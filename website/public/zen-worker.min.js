"use strict";(()=>{var ke=Object.create;var q=Object.defineProperty;var me=Object.getOwnPropertyDescriptor;var Te=Object.getOwnPropertyNames;var Ee=Object.getPrototypeOf,ge=Object.prototype.hasOwnProperty;var Se=(o,e,t)=>e in o?q(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var _=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var Ae=(o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Te(e))!ge.call(o,s)&&s!==t&&q(o,s,{get:()=>e[s],enumerable:!(n=me(e,s))||n.enumerable});return o};var ve=(o,e,t)=>(t=o!=null?ke(Ee(o)):{},Ae(e||!o||!o.__esModule?q(t,"default",{value:o,enumerable:!0}):t,o));var u=(o,e,t)=>Se(o,typeof e!="symbol"?e+"":e,t);var V=_(y=>{"use strict";Object.defineProperty(y,"__esModule",{value:!0});y.createSpan=Ne;y.mergeSpans=Re;y.isTypeDefinition=De;y.isVariableDeclaration=xe;y.isControlFlow=be;y.isLoopStatement=Ie;y.isReturnStatement=Le;y.isPushStatement=Ce;y.isDoStatement=Oe;y.isLink=Pe;y.isAnchor=Be;y.resolveLinkPath=Me;y.getLinkKind=we;function Ne(o,e,t,n,s,i){return{start:{line:o,column:e,offset:t},end:{line:n,column:s,offset:i}}}function Re(o,e){return{start:o.start.offset<e.start.offset?o.start:e.start,end:o.end.offset>e.end.offset?o.end:e.end}}function De(o){return o.kind==="TypeDefinition"}function xe(o){return o.kind==="VariableDeclaration"}function be(o){return o.kind==="ForEachStatement"||o.kind==="WhileStatement"||o.kind==="IfStatement"}function Ie(o){return o.kind==="ForEachStatement"||o.kind==="WhileStatement"}function Le(o){return o.kind==="ReturnStatement"}function Ce(o){return o.kind==="PushStatement"}function Oe(o){return o.kind==="DoStatement"}function Pe(o){return o.kind==="Link"}function Be(o){return o.kind==="Anchor"}function Me(o){return o.path.join("/")+".mdz"}function we(o){let e=o.path[0];return e==="agent"||e==="agents"?"agent":e==="skill"||e==="skills"?"skill":e==="tool"||e==="tools"?"tool":"unknown"}});var J=_($=>{"use strict";Object.defineProperty($,"__esModule",{value:!0});$.Lexer=void 0;$.tokenize=Fe;var _e=V(),U=class{constructor(e){u(this,"source");u(this,"pos",0);u(this,"line",1);u(this,"column",0);u(this,"tokens",[]);u(this,"indentStack",[0]);this.source=e}tokenize(){for(;!this.isAtEnd();)this.scanToken();for(;this.indentStack.length>1;)this.indentStack.pop(),this.addToken("DEDENT","");return this.addToken("EOF",""),this.tokens}scanToken(){if(this.column===0){if(this.line===1&&this.lookAhead(`---
`)){this.consumeChars(3),this.addToken("FRONTMATTER_START","---"),this.consumeNewline(),this.scanFrontmatter();return}if(this.lookAhead(`---
`)||this.lookAhead("---")&&this.pos+3>=this.source.length){this.consumeChars(3),this.addToken("HORIZONTAL_RULE","---"),this.isAtEnd()||this.consumeNewline();return}this.handleIndent()}let e=this.peek();if(e===" "||e==="	"){this.advance();return}if(e===`
`){this.consumeNewline();return}if(e==="\r"){this.advance();return}if(this.column===0&&e==="#"){this.scanHeading();return}if(e==="-"&&this.peekAt(1)===" "){this.advance(),this.advance(),this.addToken("LIST_MARKER","- ");return}if(this.isDigit(e)&&this.peekAt(1)==="."&&this.peekAt(2)===" "){let n=this.advance();this.advance(),this.advance(),this.addToken("LIST_MARKER",n+". ");return}if(this.column===0&&this.lookAhead("```")){this.scanCodeBlock();return}if(this.column===0&&e===">"){this.scanBlockquote();return}if(this.lookAhead("{~~")){this.consumeChars(3),this.addToken("SEMANTIC_OPEN","{~~"),this.scanSemanticContent();return}if(e==="/"&&this.tryScanSemanticMarker()||e==="~"&&this.peekAt(1)==="/"&&this.tryScanLink()||e==="#"&&this.column>0&&this.tryScanAnchor())return;if(this.lookAhead("=>")){this.consumeChars(2),this.addToken("ARROW","=>");return}if(this.lookAhead("!=")){this.consumeChars(2),this.addToken("NEQ","!=");return}if(this.lookAhead("<=")){this.consumeChars(2),this.addToken("LTE","<=");return}if(this.lookAhead(">=")){this.consumeChars(2),this.addToken("GTE",">=");return}if(this.lookAhead("<<")){this.consumeChars(2),this.addToken("PUSH","<<");return}let t={"=":"ASSIGN",":":"COLON","|":"PIPE",".":"DOT",",":"COMMA",";":"SEMICOLON","<":"LT",">":"GT","(":"LPAREN",")":"RPAREN","[":"LBRACKET","]":"RBRACKET","{":"LBRACE","}":"RBRACE"};if(t[e]){this.advance(),this.addToken(t[e],e);return}if(e==="$"){this.scanDollarIdent();return}if(e==='"'){this.scanString();return}if(e==="`"){this.scanTemplate();return}if(this.isDigit(e)||e==="-"&&this.isDigit(this.peekAt(1))){this.scanNumber();return}if(this.isAlpha(e)){this.scanIdentOrKeyword();return}this.advance(),this.addToken("TEXT",e)}handleIndent(){let e=0;for(;this.peek()===" ";)e++,this.advance();for(;this.peek()==="	";)e+=2,this.advance();if(this.peek()===`
`||this.isAtEnd())return;let t=this.indentStack[this.indentStack.length-1];if(e>t)this.indentStack.push(e),this.addToken("INDENT"," ".repeat(e-t));else if(e<t)for(;this.indentStack.length>1&&this.indentStack[this.indentStack.length-1]>e;)this.indentStack.pop(),this.addToken("DEDENT","")}scanFrontmatter(){for(;!this.isAtEnd();){if(this.column===0&&this.lookAhead("---")){this.consumeChars(3),this.addToken("FRONTMATTER_END","---"),!this.isAtEnd()&&this.peek()===`
`&&this.consumeNewline();return}let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();e&&this.addToken("TEXT",e),this.isAtEnd()||this.consumeNewline()}}scanHeading(){let e=0;for(;this.peek()==="#";)e++,this.advance();this.peek()===" "&&this.advance();let t="";for(;!this.isAtEnd()&&this.peek()!==`
`;)t+=this.advance();this.addToken("HEADING","#".repeat(e)+" "+t),this.isAtEnd()||this.consumeNewline()}scanCodeBlock(){this.consumeChars(3);let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();this.addToken("CODE_BLOCK_START","```"+e),this.isAtEnd()||this.consumeNewlineRaw();let t="";for(;!this.isAtEnd();){if(this.column===0&&this.lookAhead("```")){t&&this.addToken("CODE_BLOCK_CONTENT",t),this.consumeChars(3),this.addToken("CODE_BLOCK_END","```"),!this.isAtEnd()&&this.peek()===`
`&&this.consumeNewlineRaw();return}this.peek()===`
`?(t+=`
`,this.consumeNewlineRaw()):t+=this.advance()}t&&this.addToken("CODE_BLOCK_CONTENT",t)}scanBlockquote(){this.advance();let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();this.addToken("BLOCKQUOTE",">"+e),this.isAtEnd()||this.consumeNewline()}scanSemanticContent(){let e="";for(;!this.isAtEnd()&&this.peek()!=="}"&&this.peek()!==`
`;)e+=this.advance();e&&this.addToken("SEMANTIC_CONTENT",e),this.peek()==="}"&&(this.advance(),this.addToken("SEMANTIC_CLOSE","}"))}tryPeekSemanticMarker(e){let t=1,n=!1;for(;this.pos+t<this.source.length;){let s=this.source[this.pos+t];if(s==="/")return n;if(s===`
`||e&&s===e)return!1;s===" "&&(n=!0),t++}return!1}scanSemanticMarkerContent(){this.advance();let e="";for(;!this.isAtEnd()&&this.peek()!=="/";)e+=this.advance();this.peek()==="/"&&this.advance(),this.addToken("SEMANTIC_MARKER","/"+e+"/")}tryScanSemanticMarker(){return this.tryPeekSemanticMarker()?(this.scanSemanticMarkerContent(),!0):!1}tryScanLink(){let e=this.pos,t=this.line,n=this.column;this.advance(),this.advance();let s=[],i=this.scanLinkSegment();if(!i)return this.pos=e,this.column=n,this.line=t,!1;for(s.push(i);this.peek()==="/"&&this.peekAt(1)!=="\0";){let h=this.peekAt(1);if(!this.isAlpha(h)&&h!=="_"||(this.advance(),i=this.scanLinkSegment(),!i))break;s.push(i)}let a=null;if(this.peek()==="#"&&(this.advance(),a=this.scanLinkSegment(),!a))return this.pos=e,this.column=n,this.line=t,!1;let r=JSON.stringify({path:s,anchor:a});return this.addToken("LINK",r),!0}scanLinkSegment(){let e="";if(!this.isAlpha(this.peek())&&this.peek()!=="_")return"";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-"||this.peek()==="_";)e+=this.advance();return e}tryScanAnchor(){let e=this.pos,t=this.line,n=this.column;if(this.peek()!=="#")return!1;let s=this.peekAt(1);if(!this.isAlpha(s)&&s!=="_")return!1;this.advance();let i="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-"||this.peek()==="_";)i+=this.advance();return i?(this.addToken("ANCHOR",i),!0):(this.pos=e,this.column=n,this.line=t,!1)}scanDollarIdent(){if(this.advance(),this.peek()==="/"){this.advance();let n="";for(;!this.isAtEnd()&&this.peek()!=="/"&&this.peek()!==`
`;)n+=this.advance();if(this.peek()==="/"){this.advance(),this.addToken("INFERRED_VAR","$/"+n+"/");return}this.addToken("ERROR","$/"+n);return}let e="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)e+=this.advance();if(!e){this.addToken("ERROR","$");return}let t=e[0]>="A"&&e[0]<="Z"?"TYPE_IDENT":"DOLLAR_IDENT";this.addToken(t,"$"+e)}scanString(){this.advance();let e="";for(;!this.isAtEnd()&&this.peek()!=='"'&&this.peek()!==`
`;)if(this.peek()==="\\"){this.advance();let t=this.advance();switch(t){case"n":e+=`
`;break;case"t":e+="	";break;case'"':e+='"';break;case"\\":e+="\\";break;default:e+=t}}else e+=this.advance();this.peek()==='"'?(this.advance(),this.addToken("STRING",e)):this.addToken("ERROR",'"'+e)}scanTemplate(){this.advance(),this.addToken("TEMPLATE_START","`");let e="";for(;!this.isAtEnd()&&this.peek()!=="`";)if(this.lookAhead("${")){e&&(this.addToken("TEMPLATE_PART",e),e=""),this.consumeChars(2);let t="",n=1;for(;!this.isAtEnd()&&n>0;)this.peek()==="{"&&n++,this.peek()==="}"&&n--,n>0&&(t+=this.advance());this.peek()==="}"&&this.advance(),this.addToken("DOLLAR_IDENT",t)}else if(this.lookAhead("$/")){e&&(this.addToken("TEMPLATE_PART",e),e=""),this.advance(),this.advance();let t="";for(;!this.isAtEnd()&&this.peek()!=="/"&&this.peek()!==`
`&&this.peek()!=="`";)t+=this.advance();this.peek()==="/"?(this.advance(),this.addToken("INFERRED_VAR","$/"+t+"/")):this.addToken("ERROR","$/"+t)}else this.lookAhead("{~~")?(e&&(this.addToken("TEMPLATE_PART",e),e=""),this.consumeChars(3),this.addToken("SEMANTIC_OPEN","{~~"),this.scanSemanticContent()):this.peek()==="/"&&this.tryPeekSemanticMarker("`")?(e&&(this.addToken("TEMPLATE_PART",e),e=""),this.scanSemanticMarkerContent()):e+=this.advance();e&&this.addToken("TEMPLATE_PART",e),this.peek()==="`"&&(this.advance(),this.addToken("TEMPLATE_END","`"))}scanNumber(){let e="";for(this.peek()==="-"&&(e+=this.advance());this.isDigit(this.peek());)e+=this.advance();if(this.peek()==="."&&this.isDigit(this.peekAt(1)))for(e+=this.advance();this.isDigit(this.peek());)e+=this.advance();this.addToken("NUMBER",e)}scanIdentOrKeyword(){let e="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)e+=this.advance();let n={FOR:"FOR",EACH:"EACH",IN:"IN",WHILE:"WHILE",DO:"DO",IF:"IF",THEN:"THEN",ELSE:"ELSE",AND:"AND",OR:"OR",NOT:"NOT",WITH:"WITH",BREAK:"BREAK",CONTINUE:"CONTINUE",DELEGATE:"DELEGATE",TO:"TO",RETURN:"RETURN",ASYNC:"ASYNC",AWAIT:"AWAIT",true:"TRUE",false:"FALSE"}[e]||(e[0]>="A"&&e[0]<="Z"?"UPPER_IDENT":"LOWER_IDENT");this.addToken(n,e)}isAtEnd(){return this.pos>=this.source.length}peek(){return this.isAtEnd()?"\0":this.source[this.pos]}peekAt(e){return this.pos+e>=this.source.length?"\0":this.source[this.pos+e]}advance(){let e=this.source[this.pos++];return this.column++,e}lookAhead(e){return this.source.slice(this.pos,this.pos+e.length)===e}consumeChars(e){for(let t=0;t<e;t++)this.advance()}consumeNewline(){this.peek()===`
`&&(this.pos++,this.line++,this.column=0,this.addToken("NEWLINE",`
`))}consumeNewlineRaw(){this.peek()===`
`&&(this.pos++,this.line++,this.column=0)}isDigit(e){return e>="0"&&e<="9"}isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e==="_"}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}addToken(e,t){let n=t.length;this.tokens.push({type:e,value:t,span:(0,_e.createSpan)(this.line,this.column-n,this.pos-n,this.line,this.column,this.pos)})}};$.Lexer=U;function Fe(o){return new U(o).tokenize()}});var ee=_(x=>{"use strict";var Ve=x&&x.__createBinding||(Object.create?function(o,e,t,n){n===void 0&&(n=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(o,n,s)}:function(o,e,t,n){n===void 0&&(n=t),o[n]=e[t]}),$e=x&&x.__setModuleDefault||(Object.create?function(o,e){Object.defineProperty(o,"default",{enumerable:!0,value:e})}:function(o,e){o.default=e}),We=x&&x.__importStar||function(){var o=function(e){return o=Object.getOwnPropertyNames||function(t){var n=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[n.length]=s);return n},o(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n=o(e),s=0;s<n.length;s++)n[s]!=="default"&&Ve(t,e,n[s]);return $e(t,e),t}}();Object.defineProperty(x,"__esModule",{value:!0});x.Parser=void 0;x.parse=He;var Ue=J(),f=We(V()),H=class{constructor(e){u(this,"source");u(this,"tokens",[]);u(this,"pos",0);u(this,"errors",[]);u(this,"frontmatterContent","");u(this,"loopDepth",0);this.source=e}parse(){this.tokens=(0,Ue.tokenize)(this.source),this.pos=0,this.errors=[],this.loopDepth=0;let e=this.parseFrontmatter(),t=this.parseSections(),n=this.tokens.length>0?f.mergeSpans(this.tokens[0].span,this.tokens[this.tokens.length-1].span):f.createSpan(1,0,0,1,0,0);return{kind:"Document",frontmatter:e,sections:t,errors:this.errors,span:n}}parseFrontmatter(){if(!this.check("FRONTMATTER_START"))return null;let e=this.advance(),t="";for(;!this.check("FRONTMATTER_END")&&!this.isAtEnd();){let c=this.advance();c.type==="TEXT"&&(t+=c.value+`
`)}if(!this.check("FRONTMATTER_END"))return this.error("E013","Unclosed frontmatter"),null;let n=this.advance();this.frontmatterContent=t;let s=this.parseYaml(t),{skills:i,agents:a,tools:r,uses:h}=this.parseUsesField(s);return{kind:"Frontmatter",name:s.name||"",description:s.description||"",types:this.parseFrontmatterTypes(s.types),input:this.parseFrontmatterInput(s.input),context:this.parseFrontmatterContext(s.context),skills:i,agents:a,tools:r,uses:h,imports:this.parseImports(s.imports),raw:s,span:f.mergeSpans(e.span,n.span)}}parseUsesField(e){let t=[],n=[],s=[],i=[],a=Array.isArray(e.skills)&&e.skills.length>0,r=Array.isArray(e.agents)&&e.agents.length>0,h=Array.isArray(e.tools)&&e.tools.length>0;if(a)for(let c of e.skills)t.push(c),i.push(`~${c}`);if(r)for(let c of e.agents)n.push(c),i.push(`@${c}`);if(h)for(let c of e.tools)s.push(c),i.push(`!${c}`);if(Array.isArray(e.uses)){for(let c of e.uses)if(typeof c=="string")if(c.startsWith("~")){let d=c.slice(1);t.includes(d)||(t.push(d),i.push(c))}else if(c.startsWith("@")){let d=c.slice(1);n.includes(d)||(n.push(d),i.push(c))}else if(c.startsWith("!")){let d=c.slice(1);s.includes(d)||(s.push(d),i.push(c))}else!a&&!t.includes(c)&&(t.push(c),i.push(c))}return{skills:t,agents:n,tools:s,uses:i}}parseYaml(e){let t={},n=e.split(`
`),s="",i=!1,a=!1,r=!1,h=null;for(let c of n){let d=c.match(/^(\w+):\s*(.*)$/);if(d){s=d[1];let E=d[2].trim();E?(t[s]=E,i=!1,a=!1,r=!1):(s==="types"||s==="input"||s==="context"?(t[s]={},r=!0,i=!1):(t[s]=[],i=!0),a=s==="imports");continue}if(r&&s){let E=c.match(/^\s+(\$?\w+):\s*(.*)$/);if(E){t[s][E[1]]=E[2].trim();continue}}if(a){let E=c.match(/^\s+-\s+path:\s*(.+)$/);if(E){h&&t[s].push(h),h={path:E[1].trim().replace(/^["']|["']$/g,"")};continue}let b=c.match(/^\s+skills:\s*\[([^\]]*)\]$/);if(b&&h){h.skills=b[1]?b[1].split(",").map(v=>v.trim().replace(/^["']|["']$/g,"")).filter(v=>v):[];continue}if(c.match(/^\s+alias:\s*$/)&&h){h.alias={};continue}let N=c.match(/^\s+([a-z-]+):\s*(.+)$/);if(N&&h&&h.alias!==void 0){h.alias[N[1]]=N[2].trim();continue}}let k=c.match(/^\s+-\s+(.+)$/);k&&i&&Array.isArray(t[s])&&!a&&t[s].push(k[1])}return a&&h&&t[s].push(h),t}parseImports(e){return!e||!Array.isArray(e)?[]:e.map(t=>({kind:"ImportDeclaration",path:t.path||"",skills:t.skills||[],aliases:new Map(Object.entries(t.alias||{})),span:f.createSpan(1,0,0,1,0,0)}))}parseFrontmatterTypes(e){return!e||typeof e!="object"?[]:Object.entries(e).map(([t,n])=>({kind:"FrontmatterTypeDecl",name:t.replace(/^\$/,""),typeExpr:this.parseTypeExprFromString(String(n)),span:f.createSpan(1,0,0,1,0,0)}))}parseFrontmatterInput(e){return!e||typeof e!="object"?[]:Object.entries(e).map(([t,n])=>{let s=String(n),i=s.includes("="),[a,r]=i?s.split("=").map(h=>h.trim()):[s.trim(),void 0];return{kind:"FrontmatterInputDecl",name:t.replace(/^\$/,""),type:a?this.parseTypeExprFromString(a):void 0,defaultValue:r?this.parseValueFromString(r):void 0,required:!i,span:f.createSpan(1,0,0,1,0,0)}})}parseFrontmatterContext(e){return!e||typeof e!="object"?[]:Object.entries(e).map(([t,n])=>{let s=String(n),i=s.includes("="),[a,r]=i?s.split("=").map(h=>h.trim()):[s.trim(),void 0];return{kind:"FrontmatterContextDecl",name:t.replace(/^\$/,""),type:a?this.parseTypeExprFromString(a):void 0,initialValue:r?this.parseValueFromString(r):void 0,span:f.createSpan(1,0,0,1,0,0)}})}parseTypeExprFromString(e){let t=e.replace(/^\$/,"").replace(/\[\]$/,""),n=e.endsWith("[]"),s={kind:"TypeReference",name:t,span:f.createSpan(1,0,0,1,0,0)};return n?{kind:"ArrayType",elementType:s,span:s.span}:s}parseValueFromString(e){return e.startsWith('"')&&e.endsWith('"')?{kind:"StringLiteral",value:e.slice(1,-1),span:f.createSpan(1,0,0,1,0,0)}:isNaN(Number(e))?e==="true"||e==="false"?{kind:"BooleanLiteral",value:e==="true",span:f.createSpan(1,0,0,1,0,0)}:e==="[]"?{kind:"ArrayLiteral",elements:[],span:f.createSpan(1,0,0,1,0,0)}:{kind:"InlineText",text:e,span:f.createSpan(1,0,0,1,0,0)}:{kind:"NumberLiteral",value:Number(e),span:f.createSpan(1,0,0,1,0,0)}}parseSections(){let e=[];for(;!this.isAtEnd();)if(this.skipNewlines(),this.check("HEADING"))e.push(this.parseSection());else if(!this.isAtEnd()){let t=this.parseBlocks();if(t.length>0){let n=t[0].span;e.push({kind:"Section",level:0,title:"",anchor:"",content:t,span:n})}}return e}parseSection(){let e=this.advance(),t=e.value.match(/^(#+)\s+(.+)$/);if(!t)return this.error("E015","Invalid heading format"),this.createErrorSection(e);let n=t[1].length,s=t[2],i=s.toLowerCase().replace(/\s+/g,"-").replace(/[^\w-]/g,"");this.skipNewlines();let a=this.parseBlocks(),r=a.length>0?f.mergeSpans(e.span,a[a.length-1].span):e.span;return{kind:"Section",level:n,title:s,anchor:i,content:a,span:r}}createErrorSection(e){return{kind:"Section",level:1,title:"Error",anchor:"error",content:[],span:e.span}}parseBlocks(){let e=[];for(;!this.isAtEnd()&&!this.check("HEADING")&&(this.skipNewlines(),!(this.isAtEnd()||this.check("HEADING")));){let t=this.parseBlock();t&&e.push(t)}return e}parseBlock(){if(this.check("TYPE_IDENT")&&this.peek(1)?.type==="COLON"&&this.peek(2)?.type!=="TYPE_IDENT")return this.parseTypeDefinition();if(this.check("LIST_MARKER"))return this.parseListItem();if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT"))return this.peek(1)?.type==="PUSH"?this.parsePushStatement():this.parseVariableOrType();if(this.check("FOR"))return this.parseForEach();if(this.check("WHILE"))return this.parseWhile();if(this.check("IF"))return this.parseIf();if(this.check("BREAK"))return this.parseBreak();if(this.check("CONTINUE"))return this.parseContinue();if(this.check("RETURN"))return this.parseReturnStatement();if(this.check("ASYNC")||this.check("AWAIT"))return this.parseDelegateStatement();if(this.check("DO")&&this.peek(1)?.type==="SEMANTIC_MARKER")return this.parseDoStatement();if(this.check("DELEGATE"))return this.parseDelegateStatement();if(this.check("CODE_BLOCK_START"))return this.parseCodeBlock();if(this.check("HORIZONTAL_RULE"))return this.parseHorizontalRule();if(this.check("BLOCKQUOTE"))return this.parseBlockquote();if(this.check("UPPER_IDENT")&&this.current().value==="USE")return this.parseUseStatement();if(this.check("UPPER_IDENT")&&this.current().value==="EXECUTE")return this.parseExecuteStatement();if(this.check("UPPER_IDENT")&&this.current().value==="GOTO")return this.parseGotoStatement();if(this.check("LOWER_IDENT")||this.check("UPPER_IDENT")){let e=this.current().value.toLowerCase();if(e==="execute"||e==="call"||e==="run"||e==="invoke"||e==="delegate"||e==="use"){let t=this.peek(1),n=this.peek(2),s=i=>i?.type==="LINK"||i?.type==="ANCHOR";if(s(t)||t?.type==="LOWER_IDENT"&&t.value==="to"&&s(n))return this.parseDelegation()}}return!this.isAtEnd()&&!this.check("HEADING")&&!this.check("NEWLINE")?this.parseParagraph():(this.isAtEnd()||this.advance(),null)}parseTypeDefinition(){let e=this.advance(),t=e.value.slice(1);this.expect("COLON");let n=this.parseTypeExpr();return{kind:"TypeDefinition",name:t,typeExpr:n,span:f.mergeSpans(e.span,n.span)}}parseTypeExpr(){let e=this.current();if(this.check("STRING"))return this.parseEnumType();if(this.check("LPAREN"))return this.parseCompoundType();if(this.check("TYPE_IDENT")){let t=this.advance(),n={kind:"TypeReference",name:t.value.slice(1),span:t.span};return this.check("LBRACKET")?(this.advance(),this.expect("RBRACKET"),{kind:"ArrayType",elementType:n,span:f.mergeSpans(t.span,this.previous().span)}):n}return this.parseSemanticTypeDefinition()}parseEnumType(){let e=[],t=this.current();for(;this.check("STRING");){let n=this.advance();if(e.push(n.value),this.check("PIPE"))this.advance();else break}return{kind:"EnumType",values:e,span:f.mergeSpans(t.span,this.previous().span)}}parseCompoundType(){let e=this.advance(),t=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)t.push(this.parseTypeExpr()),this.check("COMMA")&&this.advance();let n=this.expect("RPAREN"),s={kind:"CompoundType",elements:t,span:f.mergeSpans(e.span,n?.span||this.previous().span)};return this.check("LBRACKET")?(this.advance(),this.expect("RBRACKET"),{kind:"ArrayType",elementType:s,span:f.mergeSpans(e.span,this.previous().span)}):s}parseSemanticTypeDefinition(){let e="",t=this.current();for(;!this.check("NEWLINE")&&!this.isAtEnd();){let n=this.advance();e&&(e+=" "),e+=n.value}return{kind:"SemanticType",description:e.trim(),span:f.mergeSpans(t.span,this.previous().span)}}parseVariableOrType(){return this.check("TYPE_IDENT")&&this.peek(1)?.type==="COLON"&&this.peek(2)?.type!=="TYPE_IDENT"?this.parseTypeDefinition():this.parseVariableDeclaration()}parseVariableDeclaration(e=!1){let t=this.advance(),n=t.value.slice(1),s=null,i=!1;if(this.check("COLON")){if(this.advance(),this.check("TYPE_IDENT")){let h=this.advance();s={kind:"TypeReference",name:h.value.slice(1),span:h.span}}else if(this.check("SEMANTIC_MARKER")){let h=this.advance();s={kind:"SemanticType",description:h.value.slice(1,-1),span:h.span}}}let a=null,r=!1;return this.check("ASSIGN")?(this.advance(),this.check("DOLLAR_IDENT")||this.check("LPAREN")?this.findArrow()?(r=!0,a=this.parseLambdaExpression()):a=this.parseExpression():a=this.parseExpression()):e&&s&&(i=!0),{kind:"VariableDeclaration",name:n,typeAnnotation:s,value:a,isLambda:r,isRequired:i,span:f.mergeSpans(t.span,a?.span||s?.span||t.span)}}findArrow(){let e=0,t=0;for(;e<10;){let n=this.peek(e);if(!n)return!1;if(n.type==="LPAREN"&&t++,n.type==="RPAREN"&&t--,n.type==="ARROW"&&t===0)return!0;if(n.type==="NEWLINE")return!1;e++}return!1}parseListItem(){return this.advance(),this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")?this.peek(1)?.type==="PUSH"?this.parsePushStatement():this.parseVariableDeclaration():this.check("FOR")?this.parseForEach():this.check("WHILE")?this.parseWhile():this.check("IF")?this.parseIf():this.check("BREAK")?this.parseBreak():this.check("CONTINUE")?this.parseContinue():this.check("RETURN")?this.parseReturnStatement():this.check("ASYNC")||this.check("AWAIT")?this.parseDelegateStatement():this.check("DO")&&this.peek(1)?.type==="SEMANTIC_MARKER"?this.parseDoStatement():this.check("DELEGATE")?this.parseDelegateStatement():this.parseParagraph()}parseExpression(){return this.parseOr()}parseOr(){let e=this.parseAnd();for(;this.check("OR");){this.advance();let t=this.parseAnd();e={kind:"BinaryExpression",operator:"OR",left:e,right:t,span:f.mergeSpans(e.span,t.span)}}return e}parseAnd(){let e=this.parseComparison();for(;this.check("AND");){this.advance();let t=this.parseComparison();e={kind:"BinaryExpression",operator:"AND",left:e,right:t,span:f.mergeSpans(e.span,t.span)}}return e}parseComparison(){let e=this.parsePrimary(),t=["ASSIGN","NEQ","LT","GT","LTE","GTE"];for(;t.some(n=>this.check(n));){let n=this.advance(),s=this.tokenToOperator(n.type),i=this.parsePrimary();e={kind:"BinaryExpression",operator:s,left:e,right:i,span:f.mergeSpans(e.span,i.span)}}return e}tokenToOperator(e){switch(e){case"ASSIGN":return"=";case"NEQ":return"!=";case"LT":return"<";case"GT":return">";case"LTE":return"<=";case"GTE":return">=";default:return"="}}parsePrimary(){let e=this.current();if((this.check("DOLLAR_IDENT")||this.check("LPAREN"))&&this.findArrow())return this.parseLambdaExpression();if(this.check("NOT")){let t=this.advance(),n=this.parsePrimary();return{kind:"UnaryExpression",operator:"NOT",operand:n,span:f.mergeSpans(t.span,n.span)}}if(this.check("LPAREN")){this.advance();let t=this.parseExpression();return this.expect("RPAREN"),t}if(this.check("STRING")){let t=this.advance();return{kind:"StringLiteral",value:t.value,span:t.span}}if(this.check("NUMBER")){let t=this.advance();return{kind:"NumberLiteral",value:parseFloat(t.value),span:t.span}}if(this.check("TRUE"))return{kind:"BooleanLiteral",value:!0,span:this.advance().span};if(this.check("FALSE"))return{kind:"BooleanLiteral",value:!1,span:this.advance().span};if(this.check("LBRACKET"))return this.parseArrayLiteral();if(this.check("TEMPLATE_START"))return this.parseTemplateLiteral();if(this.check("LINK"))return this.parseLink();if(this.check("ANCHOR"))return this.parseAnchor();if(this.check("SEMANTIC_OPEN")||this.check("SEMANTIC_MARKER"))return this.parseSemanticMarker();if(this.check("INFERRED_VAR"))return this.parseInferredVariable();if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT"))return this.parseVariableReference();if(this.check("LOWER_IDENT")||this.check("UPPER_IDENT")||this.check("TEXT"))return this.parseInlineText();if(!this.isAtEnd()){let t=this.advance();return this.error("E001",`Unexpected token: ${t.type}`),{kind:"InlineText",text:t.value,span:t.span}}return{kind:"InlineText",text:"",span:e?.span||f.createSpan(1,0,0,1,0,0)}}parseLambdaExpression(){let e=this.current(),t=[];if(this.check("LPAREN")){for(this.advance();!this.check("RPAREN")&&!this.isAtEnd();)this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1)),this.check("COMMA")&&this.advance();this.expect("RPAREN")}else this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1));this.expect("ARROW");let n=this.parseExpression();return{kind:"LambdaExpression",params:t,body:n,span:f.mergeSpans(e.span,n.span)}}parseArrayLiteral(){let e=this.advance(),t=[];for(;!this.check("RBRACKET")&&!this.isAtEnd();)t.push(this.parseExpression()),this.check("COMMA")&&this.advance();let n=this.expect("RBRACKET");return{kind:"ArrayLiteral",elements:t,span:f.mergeSpans(e.span,n?.span||this.previous().span)}}parseTemplateLiteral(){let e=this.advance(),t=[];for(;!this.check("TEMPLATE_END")&&!this.isAtEnd();)if(this.check("TEMPLATE_PART"))t.push(this.advance().value);else if(this.check("DOLLAR_IDENT")){let s=this.advance();t.push({kind:"VariableReference",name:s.value.slice(1),span:s.span})}else this.check("SEMANTIC_OPEN")||this.check("SEMANTIC_MARKER")?t.push(this.parseSemanticMarker()):this.check("INFERRED_VAR")?t.push(this.parseInferredVariable()):this.advance();let n=this.expect("TEMPLATE_END");return{kind:"TemplateLiteral",parts:t,span:f.mergeSpans(e.span,n?.span||this.previous().span)}}parseLink(){let e=this.expect("LINK");if(!e)return{kind:"Link",path:[],anchor:null,raw:"",span:this.current().span};let t=JSON.parse(e.value),n="~/"+t.path.join("/")+(t.anchor?"#"+t.anchor:"");return{kind:"Link",path:t.path,anchor:t.anchor,raw:n,span:e.span}}parseAnchor(){let e=this.expect("ANCHOR");return e?{kind:"Anchor",name:e.value,span:e.span}:{kind:"Anchor",name:"",span:this.current().span}}parseSemanticMarker(){if(this.check("SEMANTIC_MARKER")){let i=this.advance(),a=i.value.slice(1,-1),r=[],h=/\$([a-zA-Z][a-zA-Z0-9_-]*)/g,c;for(;(c=h.exec(a))!==null;)r.push({kind:"VariableReference",name:c[1],span:i.span});return{kind:"SemanticMarker",content:a,interpolations:r,span:i.span}}let e=this.advance(),t="",n=[];for(;!this.check("SEMANTIC_CLOSE")&&!this.isAtEnd();)if(this.check("SEMANTIC_CONTENT"))t+=this.advance().value;else if(this.check("DOLLAR_IDENT")){let i=this.advance();t+=i.value,n.push({kind:"VariableReference",name:i.value.slice(1),span:i.span})}else t+=this.advance().value;let s=this.expect("SEMANTIC_CLOSE");return{kind:"SemanticMarker",content:t,interpolations:n,span:f.mergeSpans(e.span,s?.span||this.previous().span)}}parseInferredVariable(){let e=this.advance();return{kind:"InferredVariable",name:e.value.slice(2,-1),span:e.span}}parseVariableReference(){let e=this.advance(),n={kind:"VariableReference",name:e.value.slice(1),span:e.span};for(;this.check("DOT");)if(this.advance(),this.check("LOWER_IDENT")||this.check("UPPER_IDENT")){let s=this.advance();n={kind:"MemberAccess",object:n,property:s.value,span:f.mergeSpans(e.span,s.span)}}if(this.check("LPAREN")){this.advance();let s=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)s.push(this.parseExpression()),this.check("COMMA")&&this.advance();let i=this.expect("RPAREN");n={kind:"FunctionCall",callee:n,args:s,span:f.mergeSpans(e.span,i?.span||this.previous().span)}}return n}parseInlineText(){let e="",t=this.current();for(;!this.isAtEnd()&&!this.check("NEWLINE")&&!this.check("LINK")&&!this.check("ANCHOR")&&!this.check("SEMANTIC_OPEN")&&!this.check("SEMANTIC_MARKER")&&!this.check("INFERRED_VAR")&&!this.check("DOLLAR_IDENT")&&!this.check("TYPE_IDENT");)e&&(e+=" "),e+=this.advance().value;return{kind:"InlineText",text:e.trim(),span:f.mergeSpans(t.span,this.previous().span)}}parseForEach(){let e=this.advance();this.expect("EACH");let t=this.parsePattern();this.expect("IN");let n=this.parseExpression();this.expect("COLON"),this.skipNewlines(),this.loopDepth++;let s=this.parseIndentedBlocks();return this.loopDepth--,{kind:"ForEachStatement",pattern:t,collection:n,body:s,span:f.mergeSpans(e.span,s.length>0?s[s.length-1].span:n.span)}}parseWhile(){let e=this.advance(),t=this.parseCondition();this.expect("DO"),this.expect("COLON"),this.skipNewlines(),this.loopDepth++;let n=this.parseIndentedBlocks();return this.loopDepth--,{kind:"WhileStatement",condition:t,body:n,span:f.mergeSpans(e.span,n.length>0?n[n.length-1].span:t.span)}}parseIf(){let e=this.advance(),t=this.parseCondition();this.expect("THEN"),this.expect("COLON"),this.skipNewlines();let n=this.parseIndentedBlocks(),s=[],i=null;for(;this.check("ELSE");){let r=this.current();if(this.advance(),this.check("IF")){this.advance();let h=this.parseCondition();this.expect("THEN"),this.expect("COLON"),this.skipNewlines();let c=this.parseIndentedBlocks();s.push({condition:h,body:c,span:f.mergeSpans(r.span,c.length>0?c[c.length-1].span:h.span)})}else{this.expect("COLON"),this.skipNewlines(),i=this.parseIndentedBlocks();break}}let a=t.span;return i?.length?a=i[i.length-1].span:s.length>0?a=s[s.length-1].span:n.length&&(a=n[n.length-1].span),{kind:"IfStatement",condition:t,thenBody:n,elseIf:s,elseBody:i,span:f.mergeSpans(e.span,a)}}parseBreak(){let e=this.advance();return this.loopDepth===0&&this.error("E016","BREAK can only be used inside a loop"),{kind:"BreakStatement",span:e.span}}parseContinue(){let e=this.advance();return this.loopDepth===0&&this.error("E017","CONTINUE can only be used inside a loop"),{kind:"ContinueStatement",span:e.span}}parseReturnStatement(){let e=this.advance(),t;return!this.check("NEWLINE")&&!this.isAtEnd()&&!this.check("DEDENT")&&(t=this.parseExpression()),{kind:"ReturnStatement",value:t,span:t?f.mergeSpans(e.span,t.span):e.span}}parsePushStatement(){let e=this.parseVariableReference();this.expect("PUSH");let t=this.parseExpression();return{kind:"PushStatement",target:e,value:t,span:f.mergeSpans(e.span,t.span)}}parseDoStatement(){let e=this.advance(),t=this.parseSemanticMarker();return{kind:"DoStatement",instruction:t,span:f.mergeSpans(e.span,t.span)}}parseDelegateStatement(){let e=this.current(),t=!1,n=!1;this.check("ASYNC")?(t=!0,this.advance()):this.check("AWAIT")&&(n=!0,this.advance()),this.expect("DELEGATE");let s;this.check("SEMANTIC_MARKER")&&(s=this.parseSemanticMarker());let i;this.check("TO")&&(this.advance(),i=this.parseLink());let a,r;return this.check("WITH")?(this.advance(),this.check("COLON")?r=this.parseParameterBlock():this.check("ANCHOR")&&(a=this.parseAnchor())):this.check("COLON")&&(r=this.parseParameterBlock()),{kind:"DelegateStatement",task:s,target:i,withAnchor:a,parameters:r,async:t,awaited:n,span:f.mergeSpans(e.span,this.previous().span)}}parseUseStatement(){let e=this.advance(),t=this.parseLink();this.expect("TO");let n=this.parseSemanticMarker(),s;return this.check("COLON")&&(s=this.parseParameterBlock()),{kind:"UseStatement",link:t,task:n,parameters:s,span:f.mergeSpans(e.span,this.previous().span)}}parseExecuteStatement(){let e=this.advance(),t=this.parseLink();this.expect("TO");let n=this.parseSemanticMarker();return{kind:"ExecuteStatement",link:t,task:n,span:f.mergeSpans(e.span,this.previous().span)}}parseGotoStatement(){let e=this.advance(),t=this.parseAnchor();return{kind:"GotoStatement",anchor:t,span:f.mergeSpans(e.span,t.span)}}parseParameterBlock(){let e=this.advance();this.skipNewlines();let t=[],n=this.check("INDENT");for(n&&this.advance();this.check("LIST_MARKER")&&!this.isAtEnd();){this.advance();let s=this.parseVariableDeclaration(!0);if(t.push(s),this.skipNewlines(),!this.check("LIST_MARKER")||this.check("HEADING"))break}return n&&this.check("DEDENT")&&this.advance(),{kind:"ParameterBlock",parameters:t,span:f.mergeSpans(e.span,this.previous().span)}}parsePattern(){if(this.check("LPAREN")){let e=this.advance(),t=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1)),this.check("COMMA")&&this.advance();let n=this.expect("RPAREN");return{kind:"DestructuringPattern",names:t,span:f.mergeSpans(e.span,n?.span||this.previous().span)}}if(this.check("DOLLAR_IDENT")){let e=this.advance();return{kind:"SimplePattern",name:e.value.slice(1),span:e.span}}return this.error("E005","Expected pattern"),{kind:"SimplePattern",name:"",span:this.current().span}}parseCondition(){return this.parseOrCondition()}parseOrCondition(){let e=this.parseAndCondition();for(;this.check("OR");){this.advance();let t=this.parseAndCondition();e={kind:"CompoundCondition",operator:"OR",left:e,right:t,span:f.mergeSpans(e.span,t.span)}}return e}parseAndCondition(){let e=this.parsePrimaryCondition();for(;this.check("AND");){this.advance();let t=this.parsePrimaryCondition();e={kind:"CompoundCondition",operator:"AND",left:e,right:t,span:f.mergeSpans(e.span,t.span)}}return e}parsePrimaryCondition(){let e=this.check("NOT");if(e&&this.advance(),this.check("LPAREN")){this.advance();let s=this.parseCondition();return this.expect("RPAREN"),s}if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")){let s=this.parseVariableReference();if(this.check("ASSIGN")||this.check("NEQ")||this.check("LT")||this.check("GT")||this.check("LTE")||this.check("GTE")){let i=this.advance(),a=this.tokenToOperator(i.type),r=this.parsePrimary();return{kind:"DeterministicCondition",left:s,operator:a,right:r,span:f.mergeSpans(s.span,r.span)}}return{kind:"SemanticCondition",text:"$"+s.name,negated:e,span:s.span}}let t="",n=this.current();for(;!this.isAtEnd()&&!this.check("RPAREN")&&!this.check("AND")&&!this.check("OR")&&!this.check("THEN")&&!this.check("DO")&&!this.check("COLON");)t&&(t+=" "),t+=this.advance().value;return{kind:"SemanticCondition",text:t.trim(),negated:e,span:f.mergeSpans(n.span,this.previous().span)}}parseIndentedBlocks(){let e=[];for(this.check("INDENT")&&this.advance();!this.check("DEDENT")&&!this.isAtEnd()&&!this.check("HEADING")&&(this.skipNewlines(),!(this.check("DEDENT")||this.isAtEnd()||this.check("HEADING")));){let t=this.parseBlock();t&&e.push(t)}return this.check("DEDENT")&&this.advance(),e}parseParagraph(){let e=[],t=this.current();for(;!this.isAtEnd()&&!this.check("NEWLINE")&&!this.check("HEADING");)if(this.check("LINK"))e.push(this.parseLink());else if(this.check("ANCHOR"))e.push(this.parseAnchor());else if(this.check("SEMANTIC_OPEN")||this.check("SEMANTIC_MARKER"))e.push(this.parseSemanticMarker());else if(this.check("INFERRED_VAR"))e.push(this.parseInferredVariable());else if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")){let n=this.advance();e.push({kind:"VariableReference",name:n.value.slice(1),span:n.span})}else{let n=this.parseInlineText();n.text&&e.push(n)}return this.check("NEWLINE")&&this.advance(),{kind:"Paragraph",content:e,span:f.mergeSpans(t.span,this.previous().span)}}parseCodeBlock(){let e=this.advance(),n=e.value.match(/^```(\w*)$/)?.[1]||null,s="";this.check("CODE_BLOCK_CONTENT")&&(s=this.advance().value);let i=this.expect("CODE_BLOCK_END");return{kind:"CodeBlock",language:n,content:s,span:f.mergeSpans(e.span,i?.span||this.previous().span)}}parseHorizontalRule(){return{kind:"HorizontalRule",span:this.advance().span}}parseDelegation(){let e=this.advance(),t=e.value;this.check("LOWER_IDENT")&&this.current().value==="to"&&this.advance();let n;this.check("LINK")?n=this.parseLink():this.check("ANCHOR")?n=this.parseAnchor():(this.error("E001","Expected link reference (~/path) or anchor reference (#name)"),n={kind:"Anchor",name:"",span:this.current().span});let s=[];if(this.check("WITH")){this.advance(),this.expect("COLON"),this.skipNewlines();let a=this.check("INDENT");for(a&&this.advance();this.check("LIST_MARKER")&&!this.isAtEnd();){this.advance();let r=this.parseVariableDeclaration(!0);if(s.push(r),this.skipNewlines(),!this.check("LIST_MARKER")||this.check("HEADING"))break}a&&this.check("DEDENT")&&this.advance()}let i=f.mergeSpans(e.span,this.previous().span);return{kind:"Delegation",verb:t,target:n,parameters:s,span:i}}parseBlockquote(){let e=this.advance();return{kind:"Paragraph",content:[{kind:"InlineText",text:e.value.slice(1).trim(),span:e.span}],span:e.span}}isAtEnd(){return this.pos>=this.tokens.length||this.current().type==="EOF"}current(){return this.tokens[this.pos]||{type:"EOF",value:"",span:f.createSpan(1,0,0,1,0,0)}}previous(){return this.tokens[this.pos-1]||this.current()}peek(e=0){let t=this.pos+e;return t<this.tokens.length?this.tokens[t]:null}advance(){return this.isAtEnd()||this.pos++,this.previous()}check(e){return this.current().type===e}expect(e){return this.check(e)?this.advance():(this.error("E001",`Expected ${e}, got ${this.current().type}`),null)}skipNewlines(){for(;this.check("NEWLINE");)this.advance()}error(e,t){this.errors.push({kind:"ParseError",code:e,message:t,recoverable:!0,span:this.current().span})}};x.Parser=H;function He(o){return new H(o).parse()}});var le=_(R=>{"use strict";var Ge=R&&R.__createBinding||(Object.create?function(o,e,t,n){n===void 0&&(n=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(o,n,s)}:function(o,e,t,n){n===void 0&&(n=t),o[n]=e[t]}),je=R&&R.__setModuleDefault||(Object.create?function(o,e){Object.defineProperty(o,"default",{enumerable:!0,value:e})}:function(o,e){o.default=e}),Ke=R&&R.__importStar||function(){var o=function(e){return o=Object.getOwnPropertyNames||function(t){var n=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[n.length]=s);return n},o(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n=o(e),s=0;s<n.length;s++)n[s]!=="default"&&Ge(t,e,n[s]);return je(t,e),t}}();Object.defineProperty(R,"__esModule",{value:!0});R.Compiler=void 0;R.compile=te;R.createRegistry=qe;R.buildFullDependencyGraph=Ye;var pe=ee(),he=Ke(V()),ze=new Set(["String","Number","Boolean"]),G=class{constructor(e={},t){u(this,"options");u(this,"registry");u(this,"diagnostics",[]);u(this,"sourceMap",[]);u(this,"metadata");u(this,"dependencies");u(this,"definedTypes",new Set);u(this,"definedVariables",new Set);u(this,"declaredDeps",new Set);u(this,"declaredAgents",new Set);u(this,"declaredTools",new Set);this.options={includeHeader:!1,generateSourceMap:!0,validateReferences:!0,validateTypes:!0,validateScope:!0,validateContracts:!0,...e},this.registry=t||null,this.metadata=this.createEmptyMetadata(),this.dependencies={nodes:[],edges:[],cycles:[]}}createEmptyMetadata(){return{name:"",description:"",skills:[],agents:[],tools:[],uses:[],imports:[],types:[],variables:[],references:[],sections:[],parameters:[]}}compile(e){this.diagnostics=[],this.sourceMap=[],this.metadata=this.createEmptyMetadata(),this.dependencies={nodes:[],edges:[],cycles:[]},this.definedTypes.clear(),this.definedVariables.clear(),this.declaredDeps.clear(),this.declaredAgents.clear(),this.declaredTools.clear();let t=(0,pe.parse)(e);for(let s of t.errors)this.diagnostics.push({severity:"error",code:s.code,message:s.message,span:s.span});this.extractMetadata(t),this.buildDependencyGraph(t),this.options.validateTypes&&this.validateTypes(t),this.options.validateScope&&this.validateScope(t),this.options.validateReferences&&this.validateReferences(),this.options.validateContracts&&this.validateContracts(t),this.validateDelegateStatements(t),this.validateReturnStatements(t);let n=e;return this.options.includeHeader&&(n=`<!-- MDZ Validated: ${this.metadata.name||"unnamed"} -->
<!-- Errors: ${this.diagnostics.filter(i=>i.severity==="error").length}, Warnings: ${this.diagnostics.filter(i=>i.severity==="warning").length} -->

`+e),{output:n,diagnostics:this.diagnostics,metadata:this.metadata,sourceMap:this.sourceMap,dependencies:this.dependencies}}extractMetadata(e){if(e.frontmatter){this.metadata.name=e.frontmatter.name,this.metadata.description=e.frontmatter.description,this.metadata.skills=[...e.frontmatter.skills],this.metadata.agents=[...e.frontmatter.agents],this.metadata.tools=[...e.frontmatter.tools],this.metadata.uses=[...e.frontmatter.uses];for(let t of e.frontmatter.skills)this.declaredDeps.add(t);for(let t of e.frontmatter.agents)this.declaredAgents.add(t);for(let t of e.frontmatter.tools)this.declaredTools.add(t);for(let t of e.frontmatter.imports){this.metadata.imports.push({path:t.path,skills:[...t.skills],aliases:new Map(t.aliases)});for(let n of t.skills)this.declaredDeps.add(n)}for(let t of e.frontmatter.types)this.definedTypes.add(t.name),this.metadata.types.push({name:t.name,definition:this.typeExprToString(t.typeExpr),span:t.span});for(let t of e.frontmatter.input)this.definedVariables.add(t.name),this.metadata.parameters.push({name:t.name,type:t.type?this.typeExprToString(t.type):null,hasDefault:t.defaultValue!==void 0,isRequired:t.required,span:t.span});for(let t of e.frontmatter.context)this.definedVariables.add(t.name),this.metadata.variables.push({name:t.name,type:t.type?this.typeExprToString(t.type):null,hasDefault:t.initialValue!==void 0,isRequired:!1,span:t.span})}for(let t of e.sections)t.title&&this.metadata.sections.push({title:t.title,anchor:t.anchor,level:t.level,span:t.span}),t.title==="Input"&&this.extractParameters(t.content),this.extractFromBlocks(t.content)}extractFromBlocks(e){for(let t of e)this.extractFromBlock(t)}extractFromBlock(e){switch(e.kind){case"TypeDefinition":this.extractTypeDefinition(e);break;case"VariableDeclaration":this.extractVariableDeclaration(e);break;case"ForEachStatement":this.extractFromControlFlow(e);break;case"ReturnStatement":e.value&&this.extractFromExpression(e.value);break;case"PushStatement":this.extractFromExpression(e.target),this.extractFromExpression(e.value);break;case"DoStatement":e.instruction&&this.extractFromExpression(e.instruction);break;case"WhileStatement":this.extractFromBlocks(e.body);break;case"IfStatement":this.extractFromBlocks(e.thenBody),e.elseBody&&this.extractFromBlocks(e.elseBody);break;case"Paragraph":this.extractFromParagraph(e);break;case"Delegation":this.extractFromDelegation(e);break;case"DelegateStatement":this.extractFromDelegateStatement(e);break;case"UseStatement":this.extractFromUseStatement(e);break;case"ExecuteStatement":this.extractFromExecuteStatement(e);break;case"GotoStatement":this.extractFromGotoStatement(e);break}}extractTypeDefinition(e){let t={name:e.name,definition:this.typeExprToString(e.typeExpr),span:e.span};this.metadata.types.push(t),this.definedTypes.add(e.name),this.sourceMap.push({source:e.span,type:"type-def",name:e.name})}typeExprToString(e){switch(e.kind){case"SemanticType":return e.description;case"EnumType":return e.values.map(t=>`"${t}"`).join(" | ");case"TypeReference":return`$${e.name}`;case"CompoundType":return"("+e.elements.map(t=>this.typeExprToString(t)).join(", ")+")";case"ArrayType":return this.typeExprToString(e.elementType)+"[]";case"FunctionType":return`(${e.params.join(", ")}) => ${this.typeExprToString(e.returnType)}`;default:return""}}extractVariableDeclaration(e){let t={name:e.name,type:this.getTypeAnnotationName(e.typeAnnotation),hasDefault:e.value!==null,isRequired:e.isRequired||!1,span:e.span};this.metadata.variables.push(t),this.definedVariables.add(e.name),this.sourceMap.push({source:e.span,type:"variable",name:e.name}),e.value&&this.extractFromExpression(e.value)}extractFromControlFlow(e){if(e.pattern.kind==="SimplePattern")this.definedVariables.add(e.pattern.name);else for(let t of e.pattern.names)this.definedVariables.add(t);this.sourceMap.push({source:e.span,type:"control-flow",name:e.kind}),this.extractFromExpression(e.collection),this.extractFromBlocks(e.body)}extractFromParagraph(e){for(let t of e.content)t.kind==="Link"?this.extractLinkReference(t):t.kind==="Anchor"?this.extractAnchorReference(t):t.kind==="SemanticMarker"?this.sourceMap.push({source:t.span,type:"semantic",name:t.content}):t.kind==="InferredVariable"&&this.sourceMap.push({source:t.span,type:"semantic",name:"$/"+t.name+"/"})}extractFromDelegation(e){e.target.kind==="Link"?this.extractLinkReference(e.target):this.extractAnchorReference(e.target);for(let t of e.parameters)this.extractVariableDeclaration(t)}extractFromDelegateStatement(e){if(e.target&&this.extractLinkReference(e.target),e.task&&this.sourceMap.push({source:e.task.span,type:"semantic",name:e.task.content}),e.withAnchor&&this.extractAnchorReference(e.withAnchor),e.parameters)for(let t of e.parameters.parameters)this.extractVariableDeclaration(t);this.sourceMap.push({source:e.span,type:"control-flow",name:"DelegateStatement"})}extractFromUseStatement(e){if(this.extractLinkReference(e.link),this.sourceMap.push({source:e.task.span,type:"semantic",name:e.task.content}),e.parameters)for(let t of e.parameters.parameters)this.extractVariableDeclaration(t);this.sourceMap.push({source:e.span,type:"control-flow",name:"UseStatement"})}extractFromExecuteStatement(e){this.extractLinkReference(e.link),this.sourceMap.push({source:e.task.span,type:"semantic",name:e.task.content}),this.sourceMap.push({source:e.span,type:"control-flow",name:"ExecuteStatement"})}extractFromGotoStatement(e){this.extractAnchorReference(e.anchor),this.sourceMap.push({source:e.span,type:"control-flow",name:"GotoStatement"})}extractParameters(e){for(let t of e)t.kind==="VariableDeclaration"&&this.metadata.parameters.push({name:t.name,type:this.getTypeAnnotationName(t.typeAnnotation),hasDefault:t.value!==null,isRequired:!t.value,span:t.span})}getTypeAnnotationName(e){return e?e.kind==="TypeReference"?e.name:e.description:null}extractFromExpression(e){switch(e.kind){case"Link":this.extractLinkReference(e);break;case"Anchor":this.extractAnchorReference(e);break;case"SemanticMarker":this.sourceMap.push({source:e.span,type:"semantic",name:e.content});break;case"InferredVariable":this.sourceMap.push({source:e.span,type:"semantic",name:"$/"+e.name+"/"});break;case"BinaryExpression":this.extractFromExpression(e.left),this.extractFromExpression(e.right);break;case"UnaryExpression":this.extractFromExpression(e.operand);break;case"ArrayLiteral":for(let t of e.elements)this.extractFromExpression(t);break;case"FunctionCall":this.extractFromExpression(e.callee);for(let t of e.args)this.extractFromExpression(t);break;case"MemberAccess":this.extractFromExpression(e.object);break;case"LambdaExpression":this.extractFromExpression(e.body);break}}extractLinkReference(e){let t=he.getLinkKind(e),n=e.raw;this.metadata.references.push({kind:t==="unknown"?"skill":t,target:n,path:e.path,anchor:e.anchor||void 0,span:e.span}),this.sourceMap.push({source:e.span,type:"reference",name:n})}extractAnchorReference(e){this.metadata.references.push({kind:"anchor",target:`#${e.name}`,anchor:e.name,span:e.span}),this.sourceMap.push({source:e.span,type:"reference",name:`#${e.name}`})}buildDependencyGraph(e){let t=new Set,n=[];for(let s of this.metadata.references)if(s.path&&s.path.length>0){let i=s.path.join("/");t.add(i),n.push({target:i,type:"reference",span:s.span})}this.dependencies.nodes=Array.from(t),this.dependencies.edges=n}validateTypes(e){for(let t of this.metadata.variables)if(t.type&&!this.definedTypes.has(t.type)){if(ze.has(t.type))continue;this.diagnostics.push({severity:"warning",code:"E008",message:`Type '$${t.type}' is not defined in this document`,span:t.span})}}validateScope(e){let t=new Set;for(let n of e.sections)this.checkScopeInBlocks(n.content,t)}checkScopeInBlocks(e,t){for(let n of e)if(n.kind==="VariableDeclaration")this.definedVariables.add(n.name),n.value&&this.checkExpressionScope(n.value,t);else if(n.kind==="ForEachStatement"){if(this.checkExpressionScope(n.collection,t),n.pattern.kind==="SimplePattern")this.definedVariables.add(n.pattern.name);else for(let s of n.pattern.names)this.definedVariables.add(s);this.checkScopeInBlocks(n.body,t)}else if(n.kind==="WhileStatement")this.checkScopeInBlocks(n.body,t);else if(n.kind==="IfStatement")this.checkScopeInBlocks(n.thenBody,t),n.elseBody&&this.checkScopeInBlocks(n.elseBody,t);else if(n.kind==="Paragraph"){for(let s of n.content)if(s.kind==="VariableReference")this.definedVariables.has(s.name)||t.add(s.name);else if(s.kind==="SemanticMarker")for(let i of s.interpolations)this.definedVariables.has(i.name)||t.add(i.name)}else if(n.kind==="DelegateStatement"){if(n.task)for(let s of n.task.interpolations)this.definedVariables.has(s.name)||t.add(s.name);if(n.parameters)for(let s of n.parameters.parameters)s.value&&this.checkExpressionScope(s.value,t)}else if(n.kind==="ReturnStatement")n.value&&this.checkExpressionScope(n.value,t);else if(n.kind==="PushStatement")this.definedVariables.has(n.target.name)||t.add(n.target.name),this.checkExpressionScope(n.value,t);else if(n.kind==="DoStatement")for(let s of n.instruction.interpolations)this.definedVariables.has(s.name)||t.add(s.name)}checkExpressionScope(e,t){if(e.kind==="VariableReference")this.definedVariables.has(e.name)||t.add(e.name);else if(e.kind!=="InferredVariable"){if(e.kind==="SemanticMarker")for(let n of e.interpolations)this.definedVariables.has(n.name)||t.add(n.name);else if(e.kind==="BinaryExpression")this.checkExpressionScope(e.left,t),this.checkExpressionScope(e.right,t);else if(e.kind==="UnaryExpression")this.checkExpressionScope(e.operand,t);else if(e.kind==="ArrayLiteral")for(let n of e.elements)this.checkExpressionScope(n,t)}}validateReferences(){for(let e of this.metadata.references)e.kind==="anchor"&&e.anchor&&(this.metadata.sections.some(n=>n.anchor===e.anchor)||this.diagnostics.push({severity:"error",code:"E010",message:`Section '#${e.anchor}' does not exist in this document`,span:e.span}));if(this.registry){for(let e of this.metadata.references)if(e.path&&e.path.length>0){let t=e.path.join("/"),n=this.registry.get(t);n?e.anchor&&(n.ast.sections.find(i=>i.anchor===e.anchor)||this.diagnostics.push({severity:"error",code:"E010",message:`Section '#${e.anchor}' does not exist in '${e.target}'`,span:e.span})):this.diagnostics.push({severity:"error",code:"E009",message:`File '${e.target}' is not found in registry`,span:e.span})}}}validateDelegateStatements(e){let t=[];this.findDelegateStatements(e.sections,t);for(let n of t)this.validateDelegateAgent(n)}findDelegateStatements(e,t){for(let n of e)this.findDelegateStatementsInBlocks(n.content,t)}findDelegateStatementsInBlocks(e,t){for(let n of e)if(n.kind==="DelegateStatement")t.push(n);else if(n.kind==="ForEachStatement")this.findDelegateStatementsInBlocks(n.body,t);else if(n.kind==="WhileStatement")this.findDelegateStatementsInBlocks(n.body,t);else if(n.kind==="IfStatement"){this.findDelegateStatementsInBlocks(n.thenBody,t);for(let s of n.elseIf)this.findDelegateStatementsInBlocks(s.body,t);n.elseBody&&this.findDelegateStatementsInBlocks(n.elseBody,t)}}validateDelegateAgent(e){if(!e.target)return;he.getLinkKind(e.target)!=="agent"&&this.diagnostics.push({severity:"warning",code:"W003",message:`DELEGATE target '${e.target.raw}' should be an agent (~/agent/...)`,span:e.target.span})}validateReturnStatements(e){for(let t of e.sections)this.validateReturnInBlocks(t.content,t.content.length)}validateReturnInBlocks(e,t){for(let n=0;n<e.length;n++){let s=e[n];if(s.kind==="ReturnStatement")n===t-1||this.addDiagnostic({severity:"error",code:"E018",message:"RETURN must be at end of section or loop iteration",span:s.span});else if(s.kind==="ForEachStatement"||s.kind==="WhileStatement")this.validateReturnInBlocks(s.body,s.body.length);else if(s.kind==="IfStatement"){this.validateReturnInBlocks(s.thenBody,s.thenBody.length);for(let i of s.elseIf)this.validateReturnInBlocks(i.body,i.body.length);s.elseBody&&this.validateReturnInBlocks(s.elseBody,s.elseBody.length)}}}addDiagnostic(e){this.diagnostics.push(e)}validateContracts(e){let t=[];this.findDelegations(e.sections,t);for(let n of t)n.target.kind==="Link"&&this.validateDelegationParameters(n)}findDelegations(e,t){for(let n of e)this.findDelegationsInBlocks(n.content,t)}findDelegationsInBlocks(e,t){for(let n of e)n.kind==="Delegation"?t.push(n):n.kind==="ForEachStatement"?this.findDelegationsInBlocks(n.body,t):n.kind==="WhileStatement"?this.findDelegationsInBlocks(n.body,t):n.kind==="IfStatement"&&(this.findDelegationsInBlocks(n.thenBody,t),n.elseBody&&this.findDelegationsInBlocks(n.elseBody,t))}validateDelegationParameters(e){if(e.target.kind!=="Link")return;let t=e.target.path.join("/"),n=[];if(t===this.metadata.name)n=this.metadata.parameters;else if(this.registry){let a=this.registry.get(t);a&&(n=te(a.source,{validateReferences:!1,validateContracts:!1}).metadata.parameters)}let s=new Set(e.parameters.map(a=>a.name)),i=n.filter(a=>a.isRequired);for(let a of i)s.has(a.name)||this.diagnostics.push({severity:"error",code:"E011",message:`Required parameter '${a.name}' is missing for '${t}'`,span:e.span});if(e.parameters.length>0)for(let a of e.parameters)n.find(h=>h.name===a.name)||this.diagnostics.push({severity:"warning",code:"W002",message:`Parameter '${a.name}' is not defined for '${t}'`,span:a.span})}};R.Compiler=G;function te(o,e,t){return new G(e,t).compile(o)}function qe(o){let e=new Map;return{get(t){if(e.has(t))return e.get(t);let n=o[t];if(!n)return;let s=(0,pe.parse)(n),i={name:t,source:n,ast:s};return e.set(t,i),i},getSection(t,n){let s=this.get(t);if(!s)return;let i=s.ast.sections.find(a=>a.anchor===n);if(i)return`[Section: ${i.title}]`},list(){return Object.keys(o)}}}function Ye(o){let e=new Map,t=o.list();for(let h of t){let c=o.get(h);if(c){let d=te(c.source,{validateReferences:!1});e.set(h,d.dependencies.nodes)}}let n=[],s=new Set,i=new Set,a=[];function r(h){s.add(h),i.add(h),a.push(h);let c=e.get(h)||[];for(let d of c)if(!s.has(d))r(d);else if(i.has(d)){let k=a.indexOf(d);n.push([...a.slice(k),d])}a.pop(),i.delete(h)}for(let h of t)s.has(h)||r(h);return{graph:e,cycles:n}}});var ue=_(g=>{"use strict";var Ze=g&&g.__createBinding||(Object.create?function(o,e,t,n){n===void 0&&(n=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(o,n,s)}:function(o,e,t,n){n===void 0&&(n=t),o[n]=e[t]}),Qe=g&&g.__setModuleDefault||(Object.create?function(o,e){Object.defineProperty(o,"default",{enumerable:!0,value:e})}:function(o,e){o.default=e}),Xe=g&&g.__importStar||function(){var o=function(e){return o=Object.getOwnPropertyNames||function(t){var n=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[n.length]=s);return n},o(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var n=o(e),s=0;s<n.length;s++)n[s]!=="default"&&Ze(t,e,n[s]);return Qe(t,e),t}}();Object.defineProperty(g,"__esModule",{value:!0});g.buildFullDependencyGraph=g.createRegistry=g.Compiler=g.compile=g.AST=g.Lexer=g.tokenize=g.parse=void 0;var Je=ee();Object.defineProperty(g,"parse",{enumerable:!0,get:function(){return Je.parse}});var de=J();Object.defineProperty(g,"tokenize",{enumerable:!0,get:function(){return de.tokenize}});Object.defineProperty(g,"Lexer",{enumerable:!0,get:function(){return de.Lexer}});g.AST=Xe(V());var j=le();Object.defineProperty(g,"compile",{enumerable:!0,get:function(){return j.compile}});Object.defineProperty(g,"Compiler",{enumerable:!0,get:function(){return j.Compiler}});Object.defineProperty(g,"createRegistry",{enumerable:!0,get:function(){return j.createRegistry}});Object.defineProperty(g,"buildFullDependencyGraph",{enumerable:!0,get:function(){return j.buildFullDependencyGraph}})});function A(o,e,t,n,s,i){return{start:{line:o,column:e,offset:t},end:{line:n,column:s,offset:i}}}function T(o,e){return{start:o.start.offset<e.start.offset?o.start:e.start,end:o.end.offset>e.end.offset?o.end:e.end}}function Y(o){let e=o.path[0];return e==="agent"||e==="agents"?"agent":e==="skill"||e==="skills"?"skill":e==="tool"||e==="tools"?"tool":"unknown"}var Z=class{constructor(e){u(this,"source");u(this,"pos",0);u(this,"line",1);u(this,"column",0);u(this,"tokens",[]);this.source=e}tokenize(){for(;!this.isAtEnd();)this.scanToken();return this.addToken("EOF",""),this.tokens}scanToken(){if(this.column===0){if(this.line===1&&this.lookAhead(`---
`)){this.consumeChars(3),this.addToken("FRONTMATTER_START","---"),this.consumeNewline(),this.scanFrontmatter();return}if(this.lookAhead(`---
`)||this.lookAhead("---")&&this.pos+3>=this.source.length){this.consumeChars(3),this.addToken("HORIZONTAL_RULE","---"),this.isAtEnd()||this.consumeNewline();return}}let e=this.peek();if(e===" "||e==="	"){this.advance();return}if(e===`
`){this.consumeNewline();return}if(e==="\r"){this.advance();return}if(this.column===0&&e==="#"){this.scanHeading();return}if(e==="-"&&this.peekAt(1)===" "){this.advance(),this.advance(),this.addToken("LIST_MARKER","- ");return}if(this.isDigit(e)&&this.peekAt(1)==="."&&this.peekAt(2)===" "){let n=this.advance();this.advance(),this.advance(),this.addToken("LIST_MARKER",n+". ");return}if(this.column===0&&this.lookAhead("```")){this.scanCodeBlock();return}if(this.column===0&&e===">"){this.scanBlockquote();return}if(this.lookAhead("{~~")){this.consumeChars(3),this.addToken("SEMANTIC_OPEN","{~~"),this.scanSemanticContent();return}if(e==="/"&&this.tryScanSemanticMarker()||e==="~"&&this.peekAt(1)==="/"&&this.tryScanLink()||e==="#"&&this.column>0&&this.tryScanAnchor())return;if(this.lookAhead("=>")){this.consumeChars(2),this.addToken("ARROW","=>");return}if(this.lookAhead("!=")){this.consumeChars(2),this.addToken("NEQ","!=");return}if(this.lookAhead("<=")){this.consumeChars(2),this.addToken("LTE","<=");return}if(this.lookAhead(">=")){this.consumeChars(2),this.addToken("GTE",">=");return}if(this.lookAhead("<<")){this.consumeChars(2),this.addToken("PUSH","<<");return}let t={"=":"ASSIGN",":":"COLON","|":"PIPE",".":"DOT",",":"COMMA",";":"SEMICOLON","<":"LT",">":"GT","(":"LPAREN",")":"RPAREN","[":"LBRACKET","]":"RBRACKET","{":"LBRACE","}":"RBRACE"};if(t[e]){this.advance(),this.addToken(t[e],e);return}if(e==="$"){this.scanDollarIdent();return}if(e==='"'){this.scanString();return}if(e==="`"){this.scanTemplate();return}if(this.isDigit(e)||e==="-"&&this.isDigit(this.peekAt(1))){this.scanNumber();return}if(this.isAlpha(e)){this.scanIdentOrKeyword();return}this.advance(),this.addToken("TEXT",e)}scanFrontmatter(){for(;!this.isAtEnd();){if(this.column===0&&this.lookAhead("---")){this.consumeChars(3),this.addToken("FRONTMATTER_END","---"),!this.isAtEnd()&&this.peek()===`
`&&this.consumeNewline();return}let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();e&&this.addToken("TEXT",e),this.isAtEnd()||this.consumeNewline()}}scanHeading(){let e=0;for(;this.peek()==="#";)e++,this.advance();this.peek()===" "&&this.advance();let t="";for(;!this.isAtEnd()&&this.peek()!==`
`;)t+=this.advance();this.addToken("HEADING","#".repeat(e)+" "+t),this.isAtEnd()||this.consumeNewline()}scanCodeBlock(){this.consumeChars(3);let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();this.addToken("CODE_BLOCK_START","```"+e),this.isAtEnd()||this.consumeNewlineRaw();let t="";for(;!this.isAtEnd();){if(this.column===0&&this.lookAhead("```")){t&&this.addToken("CODE_BLOCK_CONTENT",t),this.consumeChars(3),this.addToken("CODE_BLOCK_END","```"),!this.isAtEnd()&&this.peek()===`
`&&this.consumeNewlineRaw();return}this.peek()===`
`?(t+=`
`,this.consumeNewlineRaw()):t+=this.advance()}t&&this.addToken("CODE_BLOCK_CONTENT",t)}scanBlockquote(){this.advance();let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();this.addToken("BLOCKQUOTE",">"+e),this.isAtEnd()||this.consumeNewline()}scanSemanticContent(){let e="";for(;!this.isAtEnd()&&this.peek()!=="}"&&this.peek()!==`
`;)e+=this.advance();e&&this.addToken("SEMANTIC_CONTENT",e),this.peek()==="}"&&(this.advance(),this.addToken("SEMANTIC_CLOSE","}"))}tryPeekSemanticMarker(e){let t=1;for(;this.pos+t<this.source.length;){let n=this.source[this.pos+t];if(n==="/"){let s=this.source[this.pos+t+1]??"\0";return!!(s===`
`||s==="\0"||/\s/.test(s)||/[.,;:!?)]}]/.test(s))}if(n===`
`||e&&n===e)return!1;t++}return!1}scanSemanticMarkerContent(){this.advance();let e="";for(;!this.isAtEnd()&&this.peek()!=="/";)e+=this.advance();this.peek()==="/"&&this.advance(),this.addToken("SEMANTIC_MARKER","/"+e+"/")}tryScanSemanticMarker(){return this.tryPeekSemanticMarker()?(this.scanSemanticMarkerContent(),!0):!1}tryScanLink(){let e=this.pos,t=this.line,n=this.column;this.advance(),this.advance();let s=[],i=this.scanLinkSegment();if(!i)return this.pos=e,this.column=n,this.line=t,!1;for(s.push(i);this.peek()==="/"&&this.peekAt(1)!=="\0";){let h=this.peekAt(1);if(!this.isAlpha(h)&&h!=="_"||(this.advance(),i=this.scanLinkSegment(),!i))break;s.push(i)}let a=null;if(this.peek()==="#"&&(this.advance(),a=this.scanLinkSegment(),!a))return this.pos=e,this.column=n,this.line=t,!1;let r=JSON.stringify({path:s,anchor:a});return this.addToken("LINK",r),!0}scanLinkSegment(){let e="";if(!this.isAlpha(this.peek())&&this.peek()!=="_")return"";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-"||this.peek()==="_";)e+=this.advance();return e}tryScanAnchor(){let e=this.pos,t=this.line,n=this.column;if(this.peek()!=="#")return!1;let s=this.peekAt(1);if(!this.isAlpha(s)&&s!=="_")return!1;this.advance();let i="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-"||this.peek()==="_";)i+=this.advance();return i?(this.addToken("ANCHOR",i),!0):(this.pos=e,this.column=n,this.line=t,!1)}scanDollarIdent(){if(this.advance(),this.peek()==="/"){this.advance();let n="";for(;!this.isAtEnd()&&this.peek()!=="/"&&this.peek()!==`
`;)n+=this.advance();if(this.peek()==="/"){this.advance(),this.addToken("INFERRED_VAR","$/"+n+"/");return}this.addToken("ERROR","$/"+n);return}let e="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)e+=this.advance();if(!e){this.addToken("ERROR","$");return}let t=e[0]>="A"&&e[0]<="Z"?"TYPE_IDENT":"DOLLAR_IDENT";this.addToken(t,"$"+e)}scanString(){this.advance();let e="";for(;!this.isAtEnd()&&this.peek()!=='"'&&this.peek()!==`
`;)if(this.peek()==="\\"){this.advance();let t=this.advance();switch(t){case"n":e+=`
`;break;case"t":e+="	";break;case'"':e+='"';break;case"\\":e+="\\";break;default:e+=t}}else e+=this.advance();this.peek()==='"'?(this.advance(),this.addToken("STRING",e)):this.addToken("ERROR",'"'+e)}scanTemplate(){this.advance(),this.addToken("TEMPLATE_START","`");let e="";for(;!this.isAtEnd()&&this.peek()!=="`";)if(this.lookAhead("${")){e&&(this.addToken("TEMPLATE_PART",e),e=""),this.consumeChars(2);let t="",n=1;for(;!this.isAtEnd()&&n>0;)this.peek()==="{"&&n++,this.peek()==="}"&&n--,n>0&&(t+=this.advance());this.peek()==="}"&&this.advance(),this.addToken("DOLLAR_IDENT",t)}else if(this.lookAhead("$/")){e&&(this.addToken("TEMPLATE_PART",e),e=""),this.advance(),this.advance();let t="";for(;!this.isAtEnd()&&this.peek()!=="/"&&this.peek()!==`
`&&this.peek()!=="`";)t+=this.advance();this.peek()==="/"?(this.advance(),this.addToken("INFERRED_VAR","$/"+t+"/")):this.addToken("ERROR","$/"+t)}else this.lookAhead("{~~")?(e&&(this.addToken("TEMPLATE_PART",e),e=""),this.consumeChars(3),this.addToken("SEMANTIC_OPEN","{~~"),this.scanSemanticContent()):this.peek()==="/"&&this.tryPeekSemanticMarker("`")?(e&&(this.addToken("TEMPLATE_PART",e),e=""),this.scanSemanticMarkerContent()):e+=this.advance();e&&this.addToken("TEMPLATE_PART",e),this.peek()==="`"&&(this.advance(),this.addToken("TEMPLATE_END","`"))}scanNumber(){let e="";for(this.peek()==="-"&&(e+=this.advance());this.isDigit(this.peek());)e+=this.advance();if(this.peek()==="."&&this.isDigit(this.peekAt(1)))for(e+=this.advance();this.isDigit(this.peek());)e+=this.advance();this.addToken("NUMBER",e)}scanIdentOrKeyword(){let e="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)e+=this.advance();let n={FOR:"FOR",IN:"IN",WHILE:"WHILE",DO:"DO",IF:"IF",THEN:"THEN",ELSE:"ELSE",END:"END",AND:"AND",OR:"OR",NOT:"NOT",WITH:"WITH",BREAK:"BREAK",CONTINUE:"CONTINUE",DELEGATE:"DELEGATE",TO:"TO",RETURN:"RETURN",ASYNC:"ASYNC",AWAIT:"AWAIT",true:"TRUE",false:"FALSE"}[e]||(e[0]>="A"&&e[0]<="Z"?"UPPER_IDENT":"LOWER_IDENT");this.addToken(n,e)}isAtEnd(){return this.pos>=this.source.length}peek(){return this.isAtEnd()?"\0":this.source[this.pos]}peekAt(e){return this.pos+e>=this.source.length?"\0":this.source[this.pos+e]}advance(){let e=this.source[this.pos++];return this.column++,e}lookAhead(e){return this.source.slice(this.pos,this.pos+e.length)===e}consumeChars(e){for(let t=0;t<e;t++)this.advance()}consumeNewline(){this.peek()===`
`&&(this.pos++,this.line++,this.column=0,this.addToken("NEWLINE",`
`))}consumeNewlineRaw(){this.peek()===`
`&&(this.pos++,this.line++,this.column=0)}isDigit(e){return e>="0"&&e<="9"}isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e==="_"}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}addToken(e,t){let n=t.length;this.tokens.push({type:e,value:t,span:A(this.line,this.column-n,this.pos-n,this.line,this.column,this.pos)})}};function ce(o){return new Z(o).tokenize()}var Q=class{constructor(e){this.source=e;u(this,"tokens",[]);u(this,"pos",0);u(this,"errors",[]);u(this,"frontmatterContent","");u(this,"loopDepth",0);u(this,"blockDepth",0)}parse(){this.tokens=ce(this.source),this.pos=0,this.errors=[],this.loopDepth=0,this.blockDepth=0;let e=this.parseFrontmatter(),t=this.parseSections(),n=this.tokens.length>0?T(this.tokens[0].span,this.tokens[this.tokens.length-1].span):A(1,0,0,1,0,0);return{kind:"Document",frontmatter:e,sections:t,errors:this.errors,span:n}}parseFrontmatter(){if(!this.check("FRONTMATTER_START"))return null;let e=this.advance(),t="";for(;!this.check("FRONTMATTER_END")&&!this.isAtEnd();){let c=this.advance();c.type==="TEXT"&&(t+=c.value+`
`)}if(!this.check("FRONTMATTER_END"))return this.error("E013","Unclosed frontmatter"),null;let n=this.advance();this.frontmatterContent=t;let s=this.parseYaml(t),{skills:i,agents:a,tools:r,uses:h}=this.parseUsesField(s);return{kind:"Frontmatter",name:s.name||"",description:s.description||"",types:this.parseFrontmatterTypes(s.types),input:this.parseFrontmatterInput(s.input),context:this.parseFrontmatterContext(s.context),skills:i,agents:a,tools:r,uses:h,imports:this.parseImports(s.imports),raw:s,span:T(e.span,n.span)}}parseUsesField(e){let t=[],n=[],s=[],i=[],a=Array.isArray(e.skills)&&e.skills.length>0,r=Array.isArray(e.agents)&&e.agents.length>0,h=Array.isArray(e.tools)&&e.tools.length>0;if(a)for(let c of e.skills)t.push(c),i.push(`~${c}`);if(r)for(let c of e.agents)n.push(c),i.push(`@${c}`);if(h)for(let c of e.tools)s.push(c),i.push(`!${c}`);if(Array.isArray(e.uses)){for(let c of e.uses)if(typeof c=="string")if(c.startsWith("~/")){let d=c.slice(2).split("/"),k=d[0],E=d.slice(1).join("/");k==="agent"?n.includes(E)||(n.push(E),i.push(c)):k==="skill"?t.includes(E)||(t.push(E),i.push(c)):k==="tool"&&(s.includes(E)||(s.push(E),i.push(c)))}else if(c.startsWith("~")){let d=c.slice(1);t.includes(d)||(t.push(d),i.push(c))}else if(c.startsWith("@")){let d=c.slice(1);n.includes(d)||(n.push(d),i.push(c))}else if(c.startsWith("!")){let d=c.slice(1);s.includes(d)||(s.push(d),i.push(c))}else!a&&!t.includes(c)&&(t.push(c),i.push(c))}return{skills:t,agents:n,tools:s,uses:i}}parseYaml(e){let t={},n=e.split(`
`),s="",i=!1,a=!1,r=!1,h=null;for(let c of n){let d=c.match(/^(\w+):\s*(.*)$/);if(d){s=d[1];let E=d[2].trim();E?(t[s]=E,i=!1,a=!1,r=!1):(s==="types"||s==="input"||s==="context"?(t[s]={},r=!0,i=!1):(t[s]=[],i=!0),a=s==="imports");continue}if(r&&s){let E=c.match(/^\s+(\$?\w+):\s*(.*)$/);if(E){t[s][E[1]]=E[2].trim();continue}}if(a){let E=c.match(/^\s+-\s+path:\s*(.+)$/);if(E){h&&t[s].push(h),h={path:E[1].trim().replace(/^["']|["']$/g,"")};continue}let b=c.match(/^\s+skills:\s*\[([^\]]*)\]$/);if(b&&h){h.skills=b[1]?b[1].split(",").map(v=>v.trim().replace(/^["']|["']$/g,"")).filter(v=>v):[];continue}if(c.match(/^\s+alias:\s*$/)&&h){h.alias={};continue}let N=c.match(/^\s+([a-z-]+):\s*(.+)$/);if(N&&h&&h.alias!==void 0){h.alias[N[1]]=N[2].trim();continue}}let k=c.match(/^\s+-\s+(.+)$/);k&&i&&Array.isArray(t[s])&&!a&&t[s].push(k[1])}return a&&h&&t[s].push(h),t}parseImports(e){return!e||!Array.isArray(e)?[]:e.map(t=>({kind:"ImportDeclaration",path:t.path||"",skills:t.skills||[],aliases:new Map(Object.entries(t.alias||{})),span:A(1,0,0,1,0,0)}))}parseFrontmatterTypes(e){return!e||typeof e!="object"?[]:Object.entries(e).map(([t,n])=>({kind:"FrontmatterTypeDecl",name:t.replace(/^\$/,""),typeExpr:this.parseTypeExprFromString(String(n)),span:A(1,0,0,1,0,0)}))}parseFrontmatterInput(e){return!e||typeof e!="object"?[]:Object.entries(e).map(([t,n])=>{let s=String(n),i=s.includes("="),[a,r]=i?s.split("=").map(h=>h.trim()):[s.trim(),void 0];return{kind:"FrontmatterInputDecl",name:t.replace(/^\$/,""),type:a?this.parseTypeExprFromString(a):void 0,defaultValue:r?this.parseValueFromString(r):void 0,required:!i,span:A(1,0,0,1,0,0)}})}parseFrontmatterContext(e){return!e||typeof e!="object"?[]:Object.entries(e).map(([t,n])=>{let s=String(n),i=s.includes("="),[a,r]=i?s.split("=").map(h=>h.trim()):[s.trim(),void 0];return{kind:"FrontmatterContextDecl",name:t.replace(/^\$/,""),type:a?this.parseTypeExprFromString(a):void 0,initialValue:r?this.parseValueFromString(r):void 0,span:A(1,0,0,1,0,0)}})}parseTypeExprFromString(e){let t=e.replace(/^\$/,"").replace(/\[\]$/,""),n=e.endsWith("[]"),s={kind:"TypeReference",name:t,span:A(1,0,0,1,0,0)};return n?{kind:"ArrayType",elementType:s,span:s.span}:s}parseValueFromString(e){return e.startsWith('"')&&e.endsWith('"')?{kind:"StringLiteral",value:e.slice(1,-1),span:A(1,0,0,1,0,0)}:isNaN(Number(e))?e==="true"||e==="false"?{kind:"BooleanLiteral",value:e==="true",span:A(1,0,0,1,0,0)}:e==="[]"?{kind:"ArrayLiteral",elements:[],span:A(1,0,0,1,0,0)}:{kind:"InlineText",text:e,span:A(1,0,0,1,0,0)}:{kind:"NumberLiteral",value:Number(e),span:A(1,0,0,1,0,0)}}parseSections(){let e=[];for(;!this.isAtEnd();)if(this.skipNewlines(),this.check("HEADING"))e.push(this.parseSection());else if(!this.isAtEnd()){let t=this.parseBlocks();if(t.length>0){let n=t[0].span;e.push({kind:"Section",level:0,title:"",anchor:"",content:t,span:n})}}return e}parseSection(){let e=this.advance(),t=e.value.match(/^(#+)\s+(.+)$/);if(!t)return this.error("E015","Invalid heading format"),this.createErrorSection(e);let n=t[1].length,s=t[2],i=s.toLowerCase().replace(/\s+/g,"-").replace(/[^\w-]/g,"");this.skipNewlines();let a=this.parseBlocks(),r=a.length>0?T(e.span,a[a.length-1].span):e.span;return{kind:"Section",level:n,title:s,anchor:i,content:a,span:r}}createErrorSection(e){return{kind:"Section",level:1,title:"Error",anchor:"error",content:[],span:e.span}}parseBlocks(){let e=[];for(;!this.isAtEnd()&&!this.check("HEADING")&&(this.skipNewlines(),!(this.isAtEnd()||this.check("HEADING")));){let t=this.parseBlock();t&&e.push(t)}return e}parseBlock(){if(this.check("END"))return this.error("E001","Unexpected END"),this.advance(),null;if(this.check("ELSE"))return this.error("E001","Unexpected ELSE"),this.advance(),null;if(this.check("TYPE_IDENT")&&this.peek(1)?.type==="COLON"&&this.peek(2)?.type!=="TYPE_IDENT")return this.parseTypeDefinition();if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT"))return this.peek(1)?.type==="PUSH"?this.parsePushStatement():this.parseVariableOrType();if(this.check("FOR"))return this.parseFor();if(this.check("WHILE"))return this.parseWhile();if(this.check("IF"))return this.parseIf();if(this.check("BREAK"))return this.parseBreak();if(this.check("CONTINUE"))return this.parseContinue();if(this.check("RETURN"))return this.parseReturnStatement();if(this.check("ASYNC")||this.check("AWAIT"))return this.parseDelegateStatement();if(this.check("DO"))return this.parseDoStatement();if(this.check("DELEGATE"))return this.parseDelegateStatement();if(this.check("CODE_BLOCK_START"))return this.parseCodeBlock();if(this.check("HORIZONTAL_RULE"))return this.parseHorizontalRule();if(this.check("BLOCKQUOTE"))return this.parseBlockquote();if(this.check("UPPER_IDENT")&&this.current().value==="USE")return this.parseUseStatement();if(this.check("UPPER_IDENT")&&this.current().value==="EXECUTE")return this.parseExecuteStatement();if(this.check("UPPER_IDENT")&&this.current().value==="GOTO")return this.parseGotoStatement();if(this.check("LOWER_IDENT")||this.check("UPPER_IDENT")){let e=this.current().value.toLowerCase();if(e==="execute"||e==="call"||e==="run"||e==="invoke"||e==="delegate"||e==="use"){let t=this.peek(1),n=this.peek(2),s=i=>i?.type==="LINK"||i?.type==="ANCHOR";if(s(t)||t?.type==="LOWER_IDENT"&&t.value==="to"&&s(n))return this.parseDelegation()}}return!this.isAtEnd()&&!this.check("HEADING")&&!this.check("NEWLINE")?this.parseParagraph():(this.isAtEnd()||this.advance(),null)}parseTypeDefinition(){let e=this.advance(),t=e.value.slice(1);this.expect("COLON");let n=this.parseTypeExpr();return{kind:"TypeDefinition",name:t,typeExpr:n,span:T(e.span,n.span)}}parseTypeExpr(){let e=this.current();if(this.check("STRING"))return this.parseEnumType();if(this.check("LPAREN"))return this.parseCompoundType();if(this.check("TYPE_IDENT")){let t=this.advance(),n={kind:"TypeReference",name:t.value.slice(1),span:t.span};return this.check("LBRACKET")?(this.advance(),this.expect("RBRACKET"),{kind:"ArrayType",elementType:n,span:T(t.span,this.previous().span)}):n}return this.parseSemanticTypeDefinition()}parseEnumType(){let e=[],t=this.current();for(;this.check("STRING");){let n=this.advance();if(e.push(n.value),this.check("PIPE"))this.advance();else break}return{kind:"EnumType",values:e,span:T(t.span,this.previous().span)}}parseCompoundType(){let e=this.advance(),t=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)t.push(this.parseTypeExpr()),this.check("COMMA")&&this.advance();let n=this.expect("RPAREN"),s={kind:"CompoundType",elements:t,span:T(e.span,n?.span||this.previous().span)};return this.check("LBRACKET")?(this.advance(),this.expect("RBRACKET"),{kind:"ArrayType",elementType:s,span:T(e.span,this.previous().span)}):s}parseSemanticTypeDefinition(){let e="",t=this.current();for(;!this.check("NEWLINE")&&!this.isAtEnd();){let n=this.advance();e&&(e+=" "),e+=n.value}return{kind:"SemanticType",description:e.trim(),span:T(t.span,this.previous().span)}}parseVariableOrType(){return this.check("TYPE_IDENT")&&this.peek(1)?.type==="COLON"&&this.peek(2)?.type!=="TYPE_IDENT"?this.parseTypeDefinition():this.parseVariableDeclaration()}parseVariableDeclaration(e=!1){let t=this.advance(),n=t.value.slice(1),s=null,i=!1;if(this.check("COLON")){if(this.advance(),this.check("TYPE_IDENT")){let h=this.advance();s={kind:"TypeReference",name:h.value.slice(1),span:h.span}}else if(this.check("SEMANTIC_MARKER")){let h=this.advance();s={kind:"SemanticType",description:h.value.slice(1,-1),span:h.span}}}let a=null,r=!1;return this.check("ASSIGN")?(this.advance(),this.check("DOLLAR_IDENT")||this.check("LPAREN")?this.findArrow()?(r=!0,a=this.parseLambdaExpression()):a=this.parseExpression():a=this.parseExpression()):e&&s&&(i=!0),{kind:"VariableDeclaration",name:n,typeAnnotation:s,value:a,isLambda:r,isRequired:i,span:T(t.span,a?.span||s?.span||t.span)}}findArrow(){let e=0,t=0;for(;e<10;){let n=this.peek(e);if(!n)return!1;if(n.type==="LPAREN"&&t++,n.type==="RPAREN"&&t--,n.type==="ARROW"&&t===0)return!0;if(n.type==="NEWLINE")return!1;e++}return!1}parseExpression(){return this.parseOr()}parseOr(){let e=this.parseAnd();for(;this.check("OR");){this.advance();let t=this.parseAnd();e={kind:"BinaryExpression",operator:"OR",left:e,right:t,span:T(e.span,t.span)}}return e}parseAnd(){let e=this.parseComparison();for(;this.check("AND");){this.advance();let t=this.parseComparison();e={kind:"BinaryExpression",operator:"AND",left:e,right:t,span:T(e.span,t.span)}}return e}parseComparison(){let e=this.parsePrimary(),t=["ASSIGN","NEQ","LT","GT","LTE","GTE"];for(;t.some(n=>this.check(n));){let n=this.advance(),s=this.tokenToOperator(n.type),i=this.parsePrimary();e={kind:"BinaryExpression",operator:s,left:e,right:i,span:T(e.span,i.span)}}return e}tokenToOperator(e){switch(e){case"ASSIGN":return"=";case"NEQ":return"!=";case"LT":return"<";case"GT":return">";case"LTE":return"<=";case"GTE":return">=";default:return"="}}parsePrimary(){let e=this.current();if((this.check("DOLLAR_IDENT")||this.check("LPAREN"))&&this.findArrow())return this.parseLambdaExpression();if(this.check("NOT")){let t=this.advance(),n=this.parsePrimary();return{kind:"UnaryExpression",operator:"NOT",operand:n,span:T(t.span,n.span)}}if(this.check("LPAREN")){this.advance();let t=this.parseExpression();return this.expect("RPAREN"),t}if(this.check("STRING")){let t=this.advance();return{kind:"StringLiteral",value:t.value,span:t.span}}if(this.check("NUMBER")){let t=this.advance();return{kind:"NumberLiteral",value:parseFloat(t.value),span:t.span}}if(this.check("TRUE"))return{kind:"BooleanLiteral",value:!0,span:this.advance().span};if(this.check("FALSE"))return{kind:"BooleanLiteral",value:!1,span:this.advance().span};if(this.check("LBRACKET"))return this.parseArrayLiteral();if(this.check("TEMPLATE_START"))return this.parseTemplateLiteral();if(this.check("LINK"))return this.parseLink();if(this.check("ANCHOR"))return this.parseAnchor();if(this.check("SEMANTIC_OPEN")||this.check("SEMANTIC_MARKER"))return this.parseSemanticMarker();if(this.check("INFERRED_VAR"))return this.parseInferredVariable();if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT"))return this.parseVariableReference();if(this.check("LOWER_IDENT")||this.check("UPPER_IDENT")||this.check("TEXT"))return this.parseInlineText();if(!this.isAtEnd()){let t=this.advance();return this.error("E001",`Unexpected token: ${t.type}`),{kind:"InlineText",text:t.value,span:t.span}}return{kind:"InlineText",text:"",span:e?.span||A(1,0,0,1,0,0)}}parseLambdaExpression(){let e=this.current(),t=[];if(this.check("LPAREN")){for(this.advance();!this.check("RPAREN")&&!this.isAtEnd();)this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1)),this.check("COMMA")&&this.advance();this.expect("RPAREN")}else this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1));this.expect("ARROW");let n=this.parseExpression();return{kind:"LambdaExpression",params:t,body:n,span:T(e.span,n.span)}}parseArrayLiteral(){let e=this.advance(),t=[];for(;!this.check("RBRACKET")&&!this.isAtEnd();)t.push(this.parseExpression()),this.check("COMMA")&&this.advance();let n=this.expect("RBRACKET");return{kind:"ArrayLiteral",elements:t,span:T(e.span,n?.span||this.previous().span)}}parseTemplateLiteral(){let e=this.advance(),t=[];for(;!this.check("TEMPLATE_END")&&!this.isAtEnd();)if(this.check("TEMPLATE_PART"))t.push(this.advance().value);else if(this.check("DOLLAR_IDENT")){let s=this.advance();t.push({kind:"VariableReference",name:s.value.slice(1),span:s.span})}else this.check("SEMANTIC_OPEN")||this.check("SEMANTIC_MARKER")?t.push(this.parseSemanticMarker()):this.check("INFERRED_VAR")?t.push(this.parseInferredVariable()):this.advance();let n=this.expect("TEMPLATE_END");return{kind:"TemplateLiteral",parts:t,span:T(e.span,n?.span||this.previous().span)}}parseLink(){let e=this.expect("LINK");if(!e)return{kind:"Link",path:[],anchor:null,raw:"",span:this.current().span};let t=JSON.parse(e.value),n="~/"+t.path.join("/")+(t.anchor?"#"+t.anchor:"");return{kind:"Link",path:t.path,anchor:t.anchor,raw:n,span:e.span}}parseAnchor(){let e=this.expect("ANCHOR");return e?{kind:"Anchor",name:e.value,span:e.span}:{kind:"Anchor",name:"",span:this.current().span}}parseSemanticMarker(){if(this.check("SEMANTIC_MARKER")){let i=this.advance(),a=i.value.slice(1,-1),r=[],h=/\$([a-zA-Z][a-zA-Z0-9_-]*)/g,c;for(;(c=h.exec(a))!==null;)r.push({kind:"VariableReference",name:c[1],span:i.span});return{kind:"SemanticMarker",content:a,interpolations:r,span:i.span}}let e=this.advance(),t="",n=[];for(;!this.check("SEMANTIC_CLOSE")&&!this.isAtEnd();)if(this.check("SEMANTIC_CONTENT"))t+=this.advance().value;else if(this.check("DOLLAR_IDENT")){let i=this.advance();t+=i.value,n.push({kind:"VariableReference",name:i.value.slice(1),span:i.span})}else t+=this.advance().value;let s=this.expect("SEMANTIC_CLOSE");return{kind:"SemanticMarker",content:t,interpolations:n,span:T(e.span,s?.span||this.previous().span)}}parseInferredVariable(){let e=this.advance();return{kind:"InferredVariable",name:e.value.slice(2,-1),span:e.span}}parseVariableReference(){let e=this.advance(),n={kind:"VariableReference",name:e.value.slice(1),span:e.span};for(;this.check("DOT");)if(this.advance(),this.check("LOWER_IDENT")||this.check("UPPER_IDENT")){let s=this.advance();n={kind:"MemberAccess",object:n,property:s.value,span:T(e.span,s.span)}}if(this.check("LPAREN")){this.advance();let s=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)s.push(this.parseExpression()),this.check("COMMA")&&this.advance();let i=this.expect("RPAREN");n={kind:"FunctionCall",callee:n,args:s,span:T(e.span,i?.span||this.previous().span)}}return n}parseInlineText(){let e="",t=this.current();for(;!this.isAtEnd()&&!this.check("NEWLINE")&&!this.check("LINK")&&!this.check("ANCHOR")&&!this.check("SEMANTIC_OPEN")&&!this.check("SEMANTIC_MARKER")&&!this.check("INFERRED_VAR")&&!this.check("DOLLAR_IDENT")&&!this.check("TYPE_IDENT");)e&&(e+=" "),e+=this.advance().value;return{kind:"InlineText",text:e.trim(),span:T(t.span,this.previous().span)}}parseFor(){let e=this.advance(),t=this.parsePattern();this.expect("IN");let n=this.parseExpression();this.check("DO")&&this.advance(),this.expect("NEWLINE"),this.skipNewlines(),this.loopDepth++,this.blockDepth++;let s=this.parseBlockBody(["END"]);this.blockDepth--,this.loopDepth--;let i=this.expect("END");return this.skipNewlines(),{kind:"ForEachStatement",pattern:t,collection:n,body:s,span:T(e.span,i?.span||(s.length>0?s[s.length-1].span:n.span))}}parseWhile(){let e=this.advance(),t=this.parseCondition();this.check("DO")&&this.advance(),this.expect("NEWLINE"),this.skipNewlines(),this.loopDepth++,this.blockDepth++;let n=this.parseBlockBody(["END"]);this.blockDepth--,this.loopDepth--;let s=this.expect("END");return this.skipNewlines(),{kind:"WhileStatement",condition:t,body:n,span:T(e.span,s?.span||(n.length>0?n[n.length-1].span:t.span))}}parseIf(){let e=this.advance(),t=this.parseCondition();this.check("THEN")&&this.advance(),this.expect("NEWLINE"),this.skipNewlines(),this.blockDepth++;let n=this.parseBlockBody(["ELSE","END"]),s=[],i=null;for(;this.check("ELSE");){let h=this.current();if(this.advance(),this.check("IF")){this.advance();let c=this.parseCondition();this.check("THEN")&&this.advance(),this.expect("NEWLINE"),this.skipNewlines();let d=this.parseBlockBody(["ELSE","END"]);s.push({condition:c,body:d,span:T(h.span,d.length>0?d[d.length-1].span:c.span)})}else{this.expect("NEWLINE"),this.skipNewlines(),i=this.parseBlockBody(["END"]);break}}this.blockDepth--;let a=this.expect("END");this.skipNewlines();let r=a?.span||t.span;return i?.length?r=i[i.length-1].span:s.length>0?r=s[s.length-1].span:n.length&&(r=n[n.length-1].span),{kind:"IfStatement",condition:t,thenBody:n,elseIf:s,elseBody:i,span:T(e.span,r)}}parseBreak(){let e=this.advance();return this.loopDepth===0&&this.error("E016","BREAK can only be used inside a loop"),{kind:"BreakStatement",span:e.span}}parseContinue(){let e=this.advance();return this.loopDepth===0&&this.error("E017","CONTINUE can only be used inside a loop"),{kind:"ContinueStatement",span:e.span}}parseReturnStatement(){let e=this.advance(),t;return!this.check("NEWLINE")&&!this.isAtEnd()&&!this.check("END")&&!this.check("ELSE")&&(t=this.parseExpression()),{kind:"ReturnStatement",value:t,span:t?T(e.span,t.span):e.span}}parsePushStatement(){let e=this.parseVariableReference();this.expect("PUSH");let t=this.parseExpression();return{kind:"PushStatement",target:e,value:t,span:T(e.span,t.span)}}parseDoStatement(){let e=this.advance();if(this.check("SEMANTIC_MARKER")){this.blockDepth>0&&this.error("E005","Single-line DO is only valid at top level");let s=this.parseSemanticMarker();return{kind:"DoStatement",instruction:s,span:T(e.span,s.span)}}this.expect("NEWLINE"),this.skipNewlines(),this.blockDepth++;let t=this.parseBlockBody(["END"]);this.blockDepth--;let n=this.expect("END");return this.skipNewlines(),{kind:"DoStatement",body:t,span:T(e.span,n?.span||(t.length>0?t[t.length-1].span:e.span))}}parseDelegateStatement(){let e=this.current(),t=!1,n=!1;this.check("ASYNC")?(t=!0,this.advance()):this.check("AWAIT")&&(n=!0,this.advance()),this.expect("DELEGATE");let s;this.check("SEMANTIC_MARKER")&&(s=this.parseSemanticMarker());let i;this.check("TO")&&(this.advance(),i=this.parseLink());let a,r;return this.check("WITH")?(this.advance(),this.check("COLON")?r=this.parseParameterBlock():this.check("ANCHOR")&&(a=this.parseAnchor())):this.check("COLON")&&(r=this.parseParameterBlock()),{kind:"DelegateStatement",task:s,target:i,withAnchor:a,parameters:r,async:t,awaited:n,span:T(e.span,this.previous().span)}}parseUseStatement(){let e=this.advance(),t=this.parseLink();this.expect("TO");let n=this.parseSemanticMarker(),s;return this.check("COLON")&&(s=this.parseParameterBlock()),{kind:"UseStatement",link:t,task:n,parameters:s,span:T(e.span,this.previous().span)}}parseExecuteStatement(){let e=this.advance(),t=this.parseLink();this.expect("TO");let n=this.parseSemanticMarker();return{kind:"ExecuteStatement",link:t,task:n,span:T(e.span,this.previous().span)}}parseGotoStatement(){let e=this.advance(),t=this.parseAnchor();return{kind:"GotoStatement",anchor:t,span:T(e.span,t.span)}}parseParameterBlock(){let e=this.advance();this.skipNewlines();let t=[];for(;(this.check("LOWER_IDENT")||this.check("UPPER_IDENT")||this.check("DOLLAR_IDENT"))&&!this.isAtEnd();){let n=this.advance(),s=n.type==="DOLLAR_IDENT"?n.value.slice(1):n.value;this.expect("COLON");let i=null,a=!1;!this.check("NEWLINE")&&!this.check("END")&&!this.check("ELSE")&&!this.isAtEnd()?i=this.parseExpression():a=!0,t.push({kind:"VariableDeclaration",name:s,typeAnnotation:null,value:i,isLambda:!1,isRequired:a,span:T(n.span,i?.span||n.span)}),this.skipNewlines()}return{kind:"ParameterBlock",parameters:t,span:T(e.span,this.previous().span)}}parsePattern(){if(this.check("LPAREN")){let e=this.advance(),t=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1)),this.check("COMMA")&&this.advance();let n=this.expect("RPAREN");return{kind:"DestructuringPattern",names:t,span:T(e.span,n?.span||this.previous().span)}}if(this.check("DOLLAR_IDENT")){let e=this.advance();return{kind:"SimplePattern",name:e.value.slice(1),span:e.span}}return this.error("E005","Expected pattern"),{kind:"SimplePattern",name:"",span:this.current().span}}parseCondition(){return this.parseOrCondition()}parseOrCondition(){let e=this.parseAndCondition();for(;this.check("OR");){this.advance();let t=this.parseAndCondition();e={kind:"CompoundCondition",operator:"OR",left:e,right:t,span:T(e.span,t.span)}}return e}parseAndCondition(){let e=this.parsePrimaryCondition();for(;this.check("AND");){this.advance();let t=this.parsePrimaryCondition();e={kind:"CompoundCondition",operator:"AND",left:e,right:t,span:T(e.span,t.span)}}return e}parsePrimaryCondition(){let e=this.check("NOT");if(e&&this.advance(),this.check("SEMANTIC_MARKER")){let n=this.parseSemanticMarker();return{kind:"SemanticCondition",text:n.content,negated:e,span:n.span}}if(this.check("LPAREN")){this.advance();let n=this.parseCondition();return this.expect("RPAREN"),n}if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")){let n=this.parseVariableReference();if(this.check("ASSIGN")||this.check("NEQ")||this.check("LT")||this.check("GT")||this.check("LTE")||this.check("GTE")){let s=this.advance(),i=this.tokenToOperator(s.type),a=this.parsePrimary();return{kind:"DeterministicCondition",left:n,operator:i,right:a,span:T(n.span,a.span)}}return this.error("E005","Deterministic conditions require a comparison operator"),{kind:"SemanticCondition",text:"$"+n.name,negated:e,span:n.span}}this.error("E005","Semantic conditions must use /.../");let t=this.current();return this.advance(),{kind:"SemanticCondition",text:t.value,negated:e,span:t.span}}parseBlockBody(e){let t=[];for(;!this.isAtEnd()&&!this.check("HEADING")&&!(e.includes(this.current().type)||(this.skipNewlines(),this.isAtEnd()||this.check("HEADING")||e.includes(this.current().type)));){let n=this.parseBlock();n&&t.push(n)}return t}parseParagraph(){let e=[],t=this.current();for(;!this.isAtEnd()&&!this.check("NEWLINE")&&!this.check("HEADING");)if(this.check("LINK"))e.push(this.parseLink());else if(this.check("ANCHOR"))e.push(this.parseAnchor());else if(this.check("SEMANTIC_OPEN")||this.check("SEMANTIC_MARKER"))e.push(this.parseSemanticMarker());else if(this.check("INFERRED_VAR"))e.push(this.parseInferredVariable());else if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")){let n=this.advance();e.push({kind:"VariableReference",name:n.value.slice(1),span:n.span})}else{let n=this.parseInlineText();n.text&&e.push(n)}return this.check("NEWLINE")&&this.advance(),{kind:"Paragraph",content:e,span:T(t.span,this.previous().span)}}parseCodeBlock(){let e=this.advance(),n=e.value.match(/^```(\w*)$/)?.[1]||null,s="";this.check("CODE_BLOCK_CONTENT")&&(s=this.advance().value);let i=this.expect("CODE_BLOCK_END");return{kind:"CodeBlock",language:n,content:s,span:T(e.span,i?.span||this.previous().span)}}parseHorizontalRule(){return{kind:"HorizontalRule",span:this.advance().span}}parseDelegation(){let e=this.advance(),t=e.value;this.check("LOWER_IDENT")&&this.current().value==="to"&&this.advance();let n;this.check("LINK")?n=this.parseLink():this.check("ANCHOR")?n=this.parseAnchor():(this.error("E001","Expected link reference (~/path) or anchor reference (#name)"),n={kind:"Anchor",name:"",span:this.current().span});let s=[];if(this.check("WITH")&&(this.advance(),this.check("COLON"))){let a=this.parseParameterBlock();s.push(...a.parameters)}let i=T(e.span,this.previous().span);return{kind:"Delegation",verb:t,target:n,parameters:s,span:i}}parseBlockquote(){let e=this.advance();return{kind:"Paragraph",content:[{kind:"InlineText",text:e.value.slice(1).trim(),span:e.span}],span:e.span}}isAtEnd(){return this.pos>=this.tokens.length||this.current().type==="EOF"}current(){return this.tokens[this.pos]||{type:"EOF",value:"",span:A(1,0,0,1,0,0)}}previous(){return this.tokens[this.pos-1]||this.current()}peek(e=0){let t=this.pos+e;return t<this.tokens.length?this.tokens[t]:null}advance(){return this.isAtEnd()||this.pos++,this.previous()}check(e){return this.current().type===e}expect(e){return this.check(e)?this.advance():(this.error("E001",`Expected ${e}, got ${this.current().type}`),null)}skipNewlines(){for(;this.check("NEWLINE");)this.advance()}error(e,t){this.errors.push({kind:"ParseError",code:e,message:t,recoverable:!0,span:this.current().span})}};function W(o){return new Q(o).parse()}var ye=new Set(["String","Number","Boolean"]),X=class{constructor(e={},t){u(this,"options");u(this,"registry");u(this,"diagnostics",[]);u(this,"sourceMap",[]);u(this,"metadata");u(this,"dependencies");u(this,"definedTypes",new Set);u(this,"definedVariables",new Set);u(this,"declaredDeps",new Set);u(this,"declaredAgents",new Set);u(this,"declaredTools",new Set);this.options={includeHeader:!1,generateSourceMap:!0,validateReferences:!0,validateTypes:!0,validateScope:!0,validateContracts:!0,...e},this.registry=t||null,this.metadata=this.createEmptyMetadata(),this.dependencies={nodes:[],edges:[],cycles:[]}}createEmptyMetadata(){return{name:"",description:"",skills:[],agents:[],tools:[],uses:[],imports:[],types:[],variables:[],references:[],sections:[],parameters:[]}}compile(e){this.diagnostics=[],this.sourceMap=[],this.metadata=this.createEmptyMetadata(),this.dependencies={nodes:[],edges:[],cycles:[]},this.definedTypes.clear(),this.definedVariables.clear(),this.declaredDeps.clear(),this.declaredAgents.clear(),this.declaredTools.clear();let t=W(e);for(let s of t.errors)this.diagnostics.push({severity:"error",code:s.code,message:s.message,span:s.span});this.extractMetadata(t),this.buildDependencyGraph(t),this.options.validateTypes&&this.validateTypes(t),this.options.validateScope&&this.validateScope(t),this.options.validateReferences&&this.validateReferences(),this.options.validateContracts&&this.validateContracts(t),this.validateDelegateStatements(t),this.validateReturnStatements(t);let n=e;return this.options.includeHeader&&(n=`<!-- MDZ Validated: ${this.metadata.name||"unnamed"} -->
<!-- Errors: ${this.diagnostics.filter(i=>i.severity==="error").length}, Warnings: ${this.diagnostics.filter(i=>i.severity==="warning").length} -->

`+e),{output:n,diagnostics:this.diagnostics,metadata:this.metadata,sourceMap:this.sourceMap,dependencies:this.dependencies}}extractMetadata(e){if(e.frontmatter){this.metadata.name=e.frontmatter.name,this.metadata.description=e.frontmatter.description,this.metadata.skills=[...e.frontmatter.skills],this.metadata.agents=[...e.frontmatter.agents],this.metadata.tools=[...e.frontmatter.tools],this.metadata.uses=[...e.frontmatter.uses];for(let t of e.frontmatter.skills)this.declaredDeps.add(t);for(let t of e.frontmatter.agents)this.declaredAgents.add(t);for(let t of e.frontmatter.tools)this.declaredTools.add(t);for(let t of e.frontmatter.imports){this.metadata.imports.push({path:t.path,skills:[...t.skills],aliases:new Map(t.aliases)});for(let n of t.skills)this.declaredDeps.add(n)}for(let t of e.frontmatter.types)this.definedTypes.add(t.name),this.metadata.types.push({name:t.name,definition:this.typeExprToString(t.typeExpr),span:t.span});for(let t of e.frontmatter.input)this.definedVariables.add(t.name),this.metadata.parameters.push({name:t.name,type:t.type?this.typeExprToString(t.type):null,hasDefault:t.defaultValue!==void 0,isRequired:t.required,span:t.span});for(let t of e.frontmatter.context)this.definedVariables.add(t.name),this.metadata.variables.push({name:t.name,type:t.type?this.typeExprToString(t.type):null,hasDefault:t.initialValue!==void 0,isRequired:!1,span:t.span})}for(let t of e.sections)t.title&&this.metadata.sections.push({title:t.title,anchor:t.anchor,level:t.level,span:t.span}),t.title==="Input"&&this.extractParameters(t.content),this.extractFromBlocks(t.content)}extractFromBlocks(e){for(let t of e)this.extractFromBlock(t)}extractFromBlock(e){switch(e.kind){case"TypeDefinition":this.extractTypeDefinition(e);break;case"VariableDeclaration":this.extractVariableDeclaration(e);break;case"ForEachStatement":this.extractFromControlFlow(e);break;case"ReturnStatement":e.value&&this.extractFromExpression(e.value);break;case"PushStatement":this.extractFromExpression(e.target),this.extractFromExpression(e.value);break;case"DoStatement":e.instruction&&this.extractFromExpression(e.instruction),e.body&&this.extractFromBlocks(e.body);break;case"WhileStatement":this.extractFromBlocks(e.body);break;case"IfStatement":this.extractFromBlocks(e.thenBody),e.elseBody&&this.extractFromBlocks(e.elseBody);break;case"Paragraph":this.extractFromParagraph(e);break;case"Delegation":this.extractFromDelegation(e);break;case"DelegateStatement":this.extractFromDelegateStatement(e);break;case"UseStatement":this.extractFromUseStatement(e);break;case"ExecuteStatement":this.extractFromExecuteStatement(e);break;case"GotoStatement":this.extractFromGotoStatement(e);break}}extractTypeDefinition(e){let t={name:e.name,definition:this.typeExprToString(e.typeExpr),span:e.span};this.metadata.types.push(t),this.definedTypes.add(e.name),this.sourceMap.push({source:e.span,type:"type-def",name:e.name})}typeExprToString(e){switch(e.kind){case"SemanticType":return e.description;case"EnumType":return e.values.map(t=>`"${t}"`).join(" | ");case"TypeReference":return`$${e.name}`;case"CompoundType":return"("+e.elements.map(t=>this.typeExprToString(t)).join(", ")+")";case"ArrayType":return this.typeExprToString(e.elementType)+"[]";case"FunctionType":return`(${e.params.join(", ")}) => ${this.typeExprToString(e.returnType)}`;default:return""}}extractVariableDeclaration(e){let t={name:e.name,type:this.getTypeAnnotationName(e.typeAnnotation),hasDefault:e.value!==null,isRequired:e.isRequired||!1,span:e.span};this.metadata.variables.push(t),this.definedVariables.add(e.name),this.sourceMap.push({source:e.span,type:"variable",name:e.name}),e.value&&this.extractFromExpression(e.value)}extractFromControlFlow(e){if(e.pattern.kind==="SimplePattern")this.definedVariables.add(e.pattern.name);else for(let t of e.pattern.names)this.definedVariables.add(t);this.sourceMap.push({source:e.span,type:"control-flow",name:e.kind}),this.extractFromExpression(e.collection),this.extractFromBlocks(e.body)}extractFromParagraph(e){for(let t of e.content)t.kind==="Link"?this.extractLinkReference(t):t.kind==="Anchor"?this.extractAnchorReference(t):t.kind==="SemanticMarker"?this.sourceMap.push({source:t.span,type:"semantic",name:t.content}):t.kind==="InferredVariable"&&this.sourceMap.push({source:t.span,type:"semantic",name:"$/"+t.name+"/"})}extractFromDelegation(e){e.target.kind==="Link"?this.extractLinkReference(e.target):this.extractAnchorReference(e.target);for(let t of e.parameters)this.extractVariableDeclaration(t)}extractFromDelegateStatement(e){if(e.target&&this.extractLinkReference(e.target),e.task&&this.sourceMap.push({source:e.task.span,type:"semantic",name:e.task.content}),e.withAnchor&&this.extractAnchorReference(e.withAnchor),e.parameters)for(let t of e.parameters.parameters)this.extractVariableDeclaration(t);this.sourceMap.push({source:e.span,type:"control-flow",name:"DelegateStatement"})}extractFromUseStatement(e){if(this.extractLinkReference(e.link),this.sourceMap.push({source:e.task.span,type:"semantic",name:e.task.content}),e.parameters)for(let t of e.parameters.parameters)this.extractVariableDeclaration(t);this.sourceMap.push({source:e.span,type:"control-flow",name:"UseStatement"})}extractFromExecuteStatement(e){this.extractLinkReference(e.link),this.sourceMap.push({source:e.task.span,type:"semantic",name:e.task.content}),this.sourceMap.push({source:e.span,type:"control-flow",name:"ExecuteStatement"})}extractFromGotoStatement(e){this.extractAnchorReference(e.anchor),this.sourceMap.push({source:e.span,type:"control-flow",name:"GotoStatement"})}extractParameters(e){for(let t of e)t.kind==="VariableDeclaration"&&this.metadata.parameters.push({name:t.name,type:this.getTypeAnnotationName(t.typeAnnotation),hasDefault:t.value!==null,isRequired:!t.value,span:t.span})}getTypeAnnotationName(e){return e?e.kind==="TypeReference"?e.name:e.description:null}extractFromExpression(e){switch(e.kind){case"Link":this.extractLinkReference(e);break;case"Anchor":this.extractAnchorReference(e);break;case"SemanticMarker":this.sourceMap.push({source:e.span,type:"semantic",name:e.content});break;case"InferredVariable":this.sourceMap.push({source:e.span,type:"semantic",name:"$/"+e.name+"/"});break;case"BinaryExpression":this.extractFromExpression(e.left),this.extractFromExpression(e.right);break;case"UnaryExpression":this.extractFromExpression(e.operand);break;case"ArrayLiteral":for(let t of e.elements)this.extractFromExpression(t);break;case"FunctionCall":this.extractFromExpression(e.callee);for(let t of e.args)this.extractFromExpression(t);break;case"MemberAccess":this.extractFromExpression(e.object);break;case"LambdaExpression":this.extractFromExpression(e.body);break}}extractLinkReference(e){let t=Y(e),n=e.raw;this.metadata.references.push({kind:t==="unknown"?"skill":t,target:n,path:e.path,anchor:e.anchor||void 0,span:e.span}),this.sourceMap.push({source:e.span,type:"reference",name:n})}extractAnchorReference(e){this.metadata.references.push({kind:"anchor",target:`#${e.name}`,anchor:e.name,span:e.span}),this.sourceMap.push({source:e.span,type:"reference",name:`#${e.name}`})}buildDependencyGraph(e){let t=new Set,n=[];for(let s of this.metadata.references)if(s.path&&s.path.length>0){let i=s.path.join("/");t.add(i),n.push({target:i,type:"reference",span:s.span})}this.dependencies.nodes=Array.from(t),this.dependencies.edges=n}validateTypes(e){for(let t of this.metadata.variables)if(t.type&&!this.definedTypes.has(t.type)){if(ye.has(t.type))continue;this.diagnostics.push({severity:"warning",code:"E008",message:`Type '$${t.type}' is not defined in this document`,span:t.span})}}validateScope(e){let t=new Set;for(let n of e.sections)this.checkScopeInBlocks(n.content,t)}checkScopeInBlocks(e,t){for(let n of e)if(n.kind==="VariableDeclaration")this.definedVariables.add(n.name),n.value&&this.checkExpressionScope(n.value,t);else if(n.kind==="ForEachStatement"){if(this.checkExpressionScope(n.collection,t),n.pattern.kind==="SimplePattern")this.definedVariables.add(n.pattern.name);else for(let s of n.pattern.names)this.definedVariables.add(s);this.checkScopeInBlocks(n.body,t)}else if(n.kind==="WhileStatement")this.checkScopeInBlocks(n.body,t);else if(n.kind==="IfStatement")this.checkScopeInBlocks(n.thenBody,t),n.elseBody&&this.checkScopeInBlocks(n.elseBody,t);else if(n.kind==="Paragraph"){for(let s of n.content)if(s.kind==="VariableReference")this.definedVariables.has(s.name)||t.add(s.name);else if(s.kind==="SemanticMarker")for(let i of s.interpolations)this.definedVariables.has(i.name)||t.add(i.name)}else if(n.kind==="DelegateStatement"){if(n.task)for(let s of n.task.interpolations)this.definedVariables.has(s.name)||t.add(s.name);if(n.parameters)for(let s of n.parameters.parameters)s.value&&this.checkExpressionScope(s.value,t)}else if(n.kind==="ReturnStatement")n.value&&this.checkExpressionScope(n.value,t);else if(n.kind==="PushStatement")this.definedVariables.has(n.target.name)||t.add(n.target.name),this.checkExpressionScope(n.value,t);else if(n.kind==="DoStatement"){if(n.instruction)for(let s of n.instruction.interpolations)this.definedVariables.has(s.name)||t.add(s.name);n.body&&this.checkScopeInBlocks(n.body,t)}}checkExpressionScope(e,t){if(e.kind==="VariableReference")this.definedVariables.has(e.name)||t.add(e.name);else if(e.kind!=="InferredVariable"){if(e.kind==="SemanticMarker")for(let n of e.interpolations)this.definedVariables.has(n.name)||t.add(n.name);else if(e.kind==="BinaryExpression")this.checkExpressionScope(e.left,t),this.checkExpressionScope(e.right,t);else if(e.kind==="UnaryExpression")this.checkExpressionScope(e.operand,t);else if(e.kind==="ArrayLiteral")for(let n of e.elements)this.checkExpressionScope(n,t)}}validateReferences(){for(let e of this.metadata.references)e.kind==="anchor"&&e.anchor&&(this.metadata.sections.some(n=>n.anchor===e.anchor)||this.diagnostics.push({severity:"error",code:"E010",message:`Section '#${e.anchor}' does not exist in this document`,span:e.span}));if(this.registry){for(let e of this.metadata.references)if(e.path&&e.path.length>0){let t=e.path.join("/"),n=this.registry.get(t);n?e.anchor&&(n.ast.sections.find(i=>i.anchor===e.anchor)||this.diagnostics.push({severity:"error",code:"E010",message:`Section '#${e.anchor}' does not exist in '${e.target}'`,span:e.span})):this.diagnostics.push({severity:"error",code:"E009",message:`File '${e.target}' is not found in registry`,span:e.span})}}}validateDelegateStatements(e){let t=[];this.findDelegateStatements(e.sections,t);for(let n of t)this.validateDelegateAgent(n)}findDelegateStatements(e,t){for(let n of e)this.findDelegateStatementsInBlocks(n.content,t)}findDelegateStatementsInBlocks(e,t){for(let n of e)if(n.kind==="DelegateStatement")t.push(n);else if(n.kind==="ForEachStatement")this.findDelegateStatementsInBlocks(n.body,t);else if(n.kind==="WhileStatement")this.findDelegateStatementsInBlocks(n.body,t);else if(n.kind==="IfStatement"){this.findDelegateStatementsInBlocks(n.thenBody,t);for(let s of n.elseIf)this.findDelegateStatementsInBlocks(s.body,t);n.elseBody&&this.findDelegateStatementsInBlocks(n.elseBody,t)}}validateDelegateAgent(e){if(!e.target)return;Y(e.target)!=="agent"&&this.diagnostics.push({severity:"warning",code:"W003",message:`DELEGATE target '${e.target.raw}' should be an agent (~/agent/...)`,span:e.target.span})}validateReturnStatements(e){for(let t of e.sections)this.validateReturnInBlocks(t.content,t.content.length)}validateReturnInBlocks(e,t){for(let n=0;n<e.length;n++){let s=e[n];if(s.kind==="ReturnStatement")n===t-1||this.addDiagnostic({severity:"error",code:"E018",message:"RETURN must be at end of section or loop iteration",span:s.span});else if(s.kind==="ForEachStatement"||s.kind==="WhileStatement")this.validateReturnInBlocks(s.body,s.body.length);else if(s.kind==="IfStatement"){this.validateReturnInBlocks(s.thenBody,s.thenBody.length);for(let i of s.elseIf)this.validateReturnInBlocks(i.body,i.body.length);s.elseBody&&this.validateReturnInBlocks(s.elseBody,s.elseBody.length)}}}addDiagnostic(e){this.diagnostics.push(e)}validateContracts(e){let t=[];this.findDelegations(e.sections,t);for(let n of t)n.target.kind==="Link"&&this.validateDelegationParameters(n)}findDelegations(e,t){for(let n of e)this.findDelegationsInBlocks(n.content,t)}findDelegationsInBlocks(e,t){for(let n of e)n.kind==="Delegation"?t.push(n):n.kind==="ForEachStatement"?this.findDelegationsInBlocks(n.body,t):n.kind==="WhileStatement"?this.findDelegationsInBlocks(n.body,t):n.kind==="IfStatement"&&(this.findDelegationsInBlocks(n.thenBody,t),n.elseBody&&this.findDelegationsInBlocks(n.elseBody,t))}validateDelegationParameters(e){if(e.target.kind!=="Link")return;let t=e.target.path.join("/"),n=[];if(t===this.metadata.name)n=this.metadata.parameters;else if(this.registry){let a=this.registry.get(t);a&&(n=F(a.source,{validateReferences:!1,validateContracts:!1}).metadata.parameters)}let s=new Set(e.parameters.map(a=>a.name)),i=n.filter(a=>a.isRequired);for(let a of i)s.has(a.name)||this.diagnostics.push({severity:"error",code:"E011",message:`Required parameter '${a.name}' is missing for '${t}'`,span:e.span});if(e.parameters.length>0)for(let a of e.parameters)n.find(h=>h.name===a.name)||this.diagnostics.push({severity:"warning",code:"W002",message:`Parameter '${a.name}' is not defined for '${t}'`,span:a.span})}};function F(o,e,t){return new X(e,t).compile(o)}var L=ve(ue());var K=class{constructor(){u(this,"documents",new Map);u(this,"skillRegistry",new Map);u(this,"semanticTokenTypes",["keyword","variable","type","string","number","operator","function","parameter","namespace","semanticMarker","link","anchor"]);u(this,"semanticTokenTypeIndex",new Map(this.semanticTokenTypes.map((e,t)=>[e,t])))}openDocument(e,t){let n=this.analyzeDocument(e,t);return this.documents.set(e,n),this.getDiagnostics(n)}updateDocument(e,t){let n=this.analyzeDocument(e,t);return this.documents.set(e,n),this.getDiagnostics(n)}closeDocument(e){this.documents.delete(e)}analyzeDocument(e,t){let n=(0,L.parse)(t),s=new Map,i=new Map,a=[],r=[];for(let h of n.sections)this.analyzeBlocks(h.content,s,i,a,r);if(n.frontmatter?.name){let h={uri:e,content:t,ast:n,types:s,variables:i,references:a,semanticMarkers:r};this.skillRegistry.set(n.frontmatter.name,h)}return{uri:e,content:t,ast:n,types:s,variables:i,references:a,semanticMarkers:r}}analyzeBlocks(e,t,n,s,i){for(let a of e)switch(a.kind){case"TypeDefinition":t.set(a.name,{name:a.name,definition:this.typeExprToString(a.typeExpr),span:a.span});break;case"VariableDeclaration":n.set(a.name,{name:a.name,typeName:a.typeAnnotation?.kind==="TypeReference"?a.typeAnnotation.name:a.typeAnnotation?.kind==="SemanticType"?a.typeAnnotation.description:void 0,span:a.span,isLambda:a.isLambda}),a.value&&this.analyzeExpression(a.value,s,i);break;case"ForEachStatement":if(a.pattern.kind==="SimplePattern")n.set(a.pattern.name,{name:a.pattern.name,span:a.pattern.span,isLambda:!1});else for(let r of a.pattern.names)n.set(r,{name:r,span:a.pattern.span,isLambda:!1});this.analyzeExpression(a.collection,s,i),this.analyzeBlocks(a.body,t,n,s,i);break;case"WhileStatement":this.analyzeCondition(a.condition,s,i),this.analyzeBlocks(a.body,t,n,s,i);break;case"IfStatement":this.analyzeCondition(a.condition,s,i),this.analyzeBlocks(a.thenBody,t,n,s,i),a.elseBody&&this.analyzeBlocks(a.elseBody,t,n,s,i);break;case"Paragraph":for(let r of a.content)L.AST.isLink(r)?s.push({kind:"link",path:r.path,anchor:r.anchor??void 0,target:r.raw,span:r.span}):L.AST.isAnchor(r)?s.push({kind:"anchor",anchor:r.name,target:`#${r.name}`,span:r.span}):r.kind==="SemanticMarker"&&i.push({content:r.content,span:r.span});break}}analyzeExpression(e,t,n){if(L.AST.isLink(e)){t.push({kind:"link",path:e.path,anchor:e.anchor??void 0,target:e.raw,span:e.span});return}if(L.AST.isAnchor(e)){t.push({kind:"anchor",anchor:e.name,target:`#${e.name}`,span:e.span});return}switch(e.kind){case"SemanticMarker":n.push({content:e.content,span:e.span});break;case"ArrayLiteral":for(let s of e.elements)this.analyzeExpression(s,t,n);break;case"TemplateLiteral":for(let s of e.parts)typeof s!="string"&&this.analyzeExpression(s,t,n);break;case"BinaryExpression":this.analyzeExpression(e.left,t,n),this.analyzeExpression(e.right,t,n);break;case"LambdaExpression":this.analyzeExpression(e.body,t,n);break;case"FunctionCall":this.analyzeExpression(e.callee,t,n);for(let s of e.args)this.analyzeExpression(s,t,n);break}}analyzeCondition(e,t,n){switch(e.kind){case"DeterministicCondition":this.analyzeExpression(e.left,t,n),this.analyzeExpression(e.right,t,n);break;case"CompoundCondition":this.analyzeCondition(e.left,t,n),this.analyzeCondition(e.right,t,n);break}}typeExprToString(e){switch(e.kind){case"SemanticType":return e.description;case"EnumType":return e.values.map(t=>`"${t}"`).join(" | ");case"TypeReference":return`$${e.name}`;case"CompoundType":return`(${e.elements.map(t=>this.typeExprToString(t)).join(", ")})`;case"ArrayType":return`${this.typeExprToString(e.elementType)}[]`;case"FunctionType":return`(${e.params.join(", ")}) => ${this.typeExprToString(e.returnType)}`;default:return""}}getSemanticTokensLegend(){return{tokenTypes:[...this.semanticTokenTypes],tokenModifiers:[]}}getSemanticTokens(e){let t=this.documents.get(e);if(!t)return{data:[]};let n=[],s=this.buildLineOffsets(t.content),i=this.collectCodeBlockLines(t.ast),a=(l,p,m,I)=>{if(m<=0)return;let D=this.semanticTokenTypeIndex.get(I);D!==void 0&&n.push({line:l,char:p,length:m,type:D,modifiers:0})},r=(l,p)=>{l.start.line===l.end.line&&a(l.start.line-1,l.start.column,l.end.column-l.start.column,p)},h=(l,p)=>{if(i.has(l+1))return;let m=p.match(/^\s*(ELSE IF|ELSE|IF|FOR|WHILE|DO|END|RETURN|BREAK|CONTINUE|ASYNC|AWAIT|DELEGATE|USE|EXECUTE|GOTO)\b/);if(!m)return;let I=m[1],D=p.indexOf(I);D>=0&&a(l,D,I.length,"keyword")},c=(l,p)=>{let m=l.start.offset,I=l.end.offset,D=t.content.slice(m,I),O=-1;if(p==="AND"||p==="OR"||p==="NOT"){let B=new RegExp(`\\b${p}\\b`),M=D.match(B);M&&M.index!==void 0&&(O=M.index)}else O=D.indexOf(p);if(O<0)return;let P=this.offsetToPosition(m+O,s);a(P.line,P.character,p.length,"operator")},d=t.content.split(`
`),k=(l,p,m,I,D,O)=>{if(i.has(l+1))return;let P=d[l]||"",B=Math.max(0,p),M=m>0?Math.min(P.length,m):P.length,ae=P.slice(B,M),w=ae.indexOf(I);if(w===-1&&O){let re=I.replace(/^\$/,""),fe=new RegExp(`\\b${re}\\b`),z=ae.match(fe);if(z&&z.index!==void 0){w=z.index,a(l,B+w,re.length,D);return}return}w!==-1&&a(l,B+w,I.length,D)},E=(l,p)=>{let m=l.start.line-1;k(m,l.start.column,l.end.column,`$${p}`,"variable",!0)},b=(l,p)=>{let m=l.start.line-1;k(m,l.start.column,l.end.column,`$${p}`,"type",!1)},S=l=>{switch(l.kind){case"VariableReference":r(l.span,"variable");break;case"InferredVariable":r(l.span,"variable");break;case"StringLiteral":r(l.span,"string");break;case"NumberLiteral":r(l.span,"number");break;case"BooleanLiteral":r(l.span,"keyword");break;case"SemanticMarker":r(l.span,"semanticMarker");break;case"Link":r(l.span,"link");break;case"Anchor":r(l.span,"anchor");break;case"TemplateLiteral":for(let p of l.parts)typeof p!="string"&&S(p);break;case"ArrayLiteral":for(let p of l.elements)S(p);break;case"BinaryExpression":S(l.left),S(l.right),c(l.span,l.operator);break;case"UnaryExpression":S(l.operand),c(l.span,l.operator);break;case"LambdaExpression":S(l.body);break;case"FunctionCall":S(l.callee);for(let p of l.args)S(p);break;case"MemberAccess":S(l.object);break;case"InlineText":break}},N=l=>{switch(l.kind){case"SemanticCondition":r(l.span,"semanticMarker");break;case"DeterministicCondition":S(l.left),S(l.right),c(l.span,l.operator);break;case"CompoundCondition":N(l.left),N(l.right),c(l.span,l.operator);break}},v=l=>{for(let p of l)switch(p.kind){case"TypeDefinition":b(p.span,p.name);break;case"VariableDeclaration":E(p.span,p.name),p.typeAnnotation&&(p.typeAnnotation.kind==="TypeReference"?b(p.typeAnnotation.span,p.typeAnnotation.name):p.typeAnnotation.kind==="SemanticType"&&r(p.typeAnnotation.span,"semanticMarker")),p.value&&S(p.value);break;case"ForEachStatement":if(p.pattern.kind==="SimplePattern")E(p.pattern.span,p.pattern.name);else for(let m of p.pattern.names)E(p.pattern.span,m);S(p.collection),v(p.body);break;case"WhileStatement":N(p.condition),v(p.body);break;case"IfStatement":N(p.condition),v(p.thenBody);for(let m of p.elseIf)N(m.condition),v(m.body);p.elseBody&&v(p.elseBody);break;case"DoStatement":{let m=p;m.instruction&&r(m.instruction.span,"semanticMarker"),m.body&&v(m.body);break}case"ReturnStatement":p.value&&S(p.value);break;case"PushStatement":S(p.target),S(p.value);break;case"DelegateStatement":if(p.task&&r(p.task.span,"semanticMarker"),p.target&&r(p.target.span,"link"),p.withAnchor&&r(p.withAnchor.span,"anchor"),p.parameters)for(let m of p.parameters.parameters)E(m.span,m.name),m.value&&S(m.value);break;case"UseStatement":if(r(p.link.span,"link"),r(p.task.span,"semanticMarker"),p.parameters)for(let m of p.parameters.parameters)E(m.span,m.name),m.value&&S(m.value);break;case"ExecuteStatement":r(p.link.span,"link"),r(p.task.span,"semanticMarker");break;case"GotoStatement":r(p.anchor.span,"anchor");break;case"Delegation":r(p.target.span,p.target.kind==="Link"?"link":"anchor");for(let m of p.parameters)E(m.span,m.name),m.value&&S(m.value);break;case"Paragraph":for(let m of p.content)switch(m.kind){case"SemanticMarker":r(m.span,"semanticMarker");break;case"VariableReference":case"InferredVariable":r(m.span,"variable");break;case"Link":r(m.span,"link");break;case"Anchor":r(m.span,"anchor");break;case"CodeSpan":break}break;case"CodeBlock":case"List":case"HorizontalRule":break}};for(let l of t.ast.sections)v(l.content);for(let l=0;l<d.length;l+=1)h(l,d[l]);n.sort((l,p)=>l.line-p.line||l.char-p.char);let ne=[],se=0,ie=0;for(let l of n){let p=l.line-se,m=p===0?l.char-ie:l.char;ne.push(p,m,l.length,l.type,l.modifiers),se=l.line,ie=l.char}return{data:ne}}getDiagnostics(e){let t=[];for(let n of e.ast.errors)t.push({range:this.spanToRange(n.span),severity:1,message:n.message,source:"zen"});for(let n of e.references)if(n.kind==="link"&&n.path){let s=n.path.join("/"),i=this.skillRegistry.get(s);i?n.anchor&&(i.ast.sections.find(r=>r.anchor===n.anchor)||t.push({range:this.spanToRange(n.span),severity:2,message:`Section "${n.anchor}" not found in ~/${s}`,source:"zen"})):t.push({range:this.spanToRange(n.span),severity:3,message:`File not found in workspace: ~/${s}`,source:"zen"})}else n.kind==="anchor"&&n.anchor&&(e.ast.sections.find(i=>i.anchor===n.anchor)||t.push({range:this.spanToRange(n.span),severity:2,message:`Section "${n.anchor}" not found in current file`,source:"zen"}));return t}getDefinition(e,t){let n=this.documents.get(e);if(!n)return null;for(let[s,i]of n.variables)if(this.positionInSpan(t,i.span))return{uri:e,range:this.spanToRange(i.span)};for(let[s,i]of n.types)if(this.positionInSpan(t,i.span))return{uri:e,range:this.spanToRange(i.span)};for(let s of n.references)if(this.positionInSpan(t,s.span)){if(s.kind==="link"&&s.path){let i=s.path.join("/"),a=this.skillRegistry.get(i);if(a){if(s.anchor){let r=a.ast.sections.find(h=>h.anchor===s.anchor);if(r)return{uri:a.uri,range:this.spanToRange(r.span)}}return{uri:a.uri,range:{start:{line:0,character:0},end:{line:0,character:0}}}}}else if(s.kind==="anchor"&&s.anchor){let i=n.ast.sections.find(a=>a.anchor===s.anchor);if(i)return{uri:e,range:this.spanToRange(i.span)}}}return null}getHover(e,t){let n=this.documents.get(e);if(!n)return null;for(let[s,i]of n.types)if(this.positionInSpan(t,i.span))return{contents:`**Type** $${s}

${i.definition}`,range:this.spanToRange(i.span)};for(let[s,i]of n.variables)if(this.positionInSpan(t,i.span)){let a=`**Variable** $${s}`;if(i.typeName){let r=n.types.get(i.typeName);a+=`: $${i.typeName}`,r&&(a+=`

${r.definition}`)}return i.isLambda&&(a+=`

*Lambda function*`),{contents:a,range:this.spanToRange(i.span)}}for(let s of n.references)if(this.positionInSpan(t,s.span)){let i;if(s.kind==="link"&&s.path){let a=s.path.join("/"),r=this.inferLinkKind(s.path),h=this.skillRegistry.get(a);if(!h)i=`**${r}:** ${s.target}

*Not found in workspace*`;else{i=`**${r}:** ${s.target}`,h.ast.frontmatter?.description&&(i+=`

${h.ast.frontmatter.description}`);let c=h.ast.sections.filter(d=>d.anchor).map(d=>d.anchor);c.length>0&&(i+=`

Sections: ${c.join(", ")}`)}}else if(s.kind==="anchor"){let a=n.ast.sections.find(r=>r.anchor===s.anchor);i=`**Anchor** ${s.target}`,a?.title&&(i+=`

Section: ${a.title}`)}else continue;return{contents:i,range:this.spanToRange(s.span)}}return null}getCompletions(e,t){let n=this.documents.get(e);if(!n)return[];let i=(n.content.split(`
`)[t.line]||"").substring(0,t.character);if(i.endsWith("~/"))return this.getPathCompletions("");let a=i.match(/~\/([a-z0-9\/-]*)$/);if(a){let c=a[1],d=c.match(/^([^#]+)#([a-z0-9-]*)$/);if(d){let[,k,E]=d;return this.getCrossFileAnchorCompletions(k,E)}return this.getPathCompletions(c)}if(i.endsWith("#")&&!i.match(/~\/[^#]*#$/))return this.getAnchorCompletions(n);let r=i.match(/(?<!~\/[^#]*)#([a-z0-9-]+)$/);if(r){let c=r[1];return this.getAnchorCompletions(n).filter(d=>d.label.toLowerCase().startsWith(c.toLowerCase()))}if(i.endsWith("$"))return[...this.getVariableCompletions(n),...this.getTypeCompletions(n)];let h=i.match(/\$([a-zA-Z0-9-]*)$/);if(h){let c=h[1];return[...this.getVariableCompletions(n),...this.getTypeCompletions(n)].filter(k=>k.label.toLowerCase().startsWith(c.toLowerCase()))}return i.endsWith("/")?this.getSemanticCompletions():/^\s*$/.test(i)?this.getKeywordCompletions():[]}getPathCompletions(e){let t=[];for(let[n,s]of this.skillRegistry)if(n.startsWith(e)){let i=this.inferLinkKind(n.split("/"));t.push({label:"~/"+n,kind:17,detail:i,insertText:n.substring(e.length)})}return t}getCrossFileAnchorCompletions(e,t){let n=this.skillRegistry.get(e);if(!n)return[];let s=[];for(let i of n.ast.sections)i.anchor&&i.anchor.startsWith(t)&&s.push({label:"#"+i.anchor,kind:18,detail:i.title||"Section",insertText:i.anchor.substring(t.length)});return s}getAnchorCompletions(e){let t=[];for(let n of e.ast.sections)n.anchor&&t.push({label:"#"+n.anchor,kind:18,detail:n.title||"Section",insertText:n.anchor});return t}getVariableCompletions(e){let t=[];for(let[n,s]of e.variables)t.push({label:n,kind:s.isLambda?3:6,detail:s.typeName?`$${s.typeName}`:void 0});return t}getTypeCompletions(e){let t=[];for(let[s,i]of e.types)t.push({label:s,kind:7,detail:i.definition});let n=["FilePath","String","Number","Boolean"];for(let s of n)t.push({label:s,kind:7,detail:"Built-in type"});return t}getSemanticCompletions(){return[{label:"appropriate location",kind:15,insertText:"appropriate location/"},{label:"relevant context",kind:15,insertText:"relevant context/"},{label:"best approach for",kind:15,insertText:"best approach for /"},{label:"determine based on",kind:15,insertText:"determine based on /"}]}getKeywordCompletions(){return[{label:"FOR",kind:14,insertText:`FOR $item IN $items
  
END`},{label:"WHILE",kind:14,insertText:`WHILE /condition/ DO
  
END`},{label:"IF",kind:14,insertText:`IF $condition THEN
  
END`},{label:"ELSE",kind:14,insertText:`ELSE
  `},{label:"DO",kind:14,insertText:`DO
  
END`},{label:"END",kind:14,insertText:"END"}]}inferLinkKind(e){let t=e[0];return t==="agent"||t==="agents"?"agent":t==="skill"||t==="skills"?"skill":t==="tool"||t==="tools"?"tool":"link"}getDocumentSymbols(e){let t=this.documents.get(e);if(!t)return[];let n=[];for(let s of t.ast.sections){let i=[];for(let a of s.content)a.kind==="TypeDefinition"?i.push({name:`$${a.name}`,kind:5,range:this.spanToRange(a.span),selectionRange:this.spanToRange(a.span)}):a.kind==="VariableDeclaration"&&i.push({name:`$${a.name}`,kind:a.isLambda?12:13,range:this.spanToRange(a.span),selectionRange:this.spanToRange(a.span)});n.push({name:s.title||"(untitled)",kind:3,range:this.spanToRange(s.span),selectionRange:this.spanToRange(s.span),children:i.length>0?i:void 0})}return n}spanToRange(e){return{start:{line:e.start.line-1,character:e.start.column},end:{line:e.end.line-1,character:e.end.column}}}positionInSpan(e,t){let n=e.line+1,s=e.character;return!(n<t.start.line||n>t.end.line||n===t.start.line&&s<t.start.column||n===t.end.line&&s>t.end.column)}buildLineOffsets(e){let t=[],n=0;t.push(0);for(let s of e)n+=1,s===`
`&&t.push(n);return t}offsetToPosition(e,t){let n=0;for(;n+1<t.length&&t[n+1]<=e;)n+=1;let s=t[n]??0;return{line:n,character:e-s}}collectCodeBlockLines(e){let t=new Set;for(let n of e.sections)for(let s of n.content){if(s.kind!=="CodeBlock")continue;let i=s.span.start.line,a=s.span.end.line;for(let r=i;r<=a;r+=1)t.add(r)}return t}};var C=new K;function et(o,e){try{let t=W(e);postMessage({type:"parse",id:o,result:t})}catch(t){postMessage({type:"error",id:o,error:t instanceof Error?t.message:String(t)})}}function tt(o,e){try{let t=F(e),n={diagnostics:t.diagnostics.map(s=>({severity:s.severity,code:s.code,message:s.message,line:s.span.start.line,column:s.span.start.column,endLine:s.span.end.line,endColumn:s.span.end.column})),metadata:{name:t.metadata.name,description:t.metadata.description,uses:t.metadata.uses,types:t.metadata.types.map(s=>({name:s.name,definition:s.definition})),variables:t.metadata.variables.map(s=>({name:s.name,type:s.type})),references:t.metadata.references.map(s=>({kind:s.kind,target:s.target})),sections:t.metadata.sections.map(s=>({title:s.title,anchor:s.anchor,level:s.level}))},dependencies:{nodes:t.dependencies.nodes,edges:t.dependencies.edges.map(s=>({target:s.target,type:s.type}))}};postMessage({type:"validate",id:o,result:n})}catch(t){postMessage({type:"error",id:o,error:t instanceof Error?t.message:String(t)})}}function nt(o,e,t,n){try{C.updateDocument(e,t);let s=C.getCompletions(e,n);postMessage({type:"completions",id:o,result:s})}catch(s){postMessage({type:"error",id:o,error:s instanceof Error?s.message:String(s)})}}function st(o,e,t,n){try{C.updateDocument(e,t);let s=C.getHover(e,n);postMessage({type:"hover",id:o,result:s})}catch(s){postMessage({type:"error",id:o,error:s instanceof Error?s.message:String(s)})}}function it(o,e,t){try{let n=C.updateDocument(e,t);postMessage({type:"diagnostics",id:o,result:n})}catch(n){postMessage({type:"error",id:o,error:n instanceof Error?n.message:String(n)})}}function at(o,e,t){try{C.updateDocument(e,t);let n=C.getSemanticTokens(e);postMessage({type:"semanticTokens",id:o,result:n})}catch(n){postMessage({type:"error",id:o,error:n instanceof Error?n.message:String(n)})}}function rt(o,e){try{let t={},n=new Map,s=[],i=new Map;for(let[r,h]of Object.entries(e)){let c=F(h);c.metadata.name&&i.set(c.metadata.name,r)}for(let[r,h]of Object.entries(e)){let c=F(h),d=c.metadata.name;t[r]={diagnostics:c.diagnostics.map(k=>({severity:k.severity,code:k.code,message:k.message,line:k.span.start.line,column:k.span.start.column,endLine:k.span.end.line,endColumn:k.span.end.column})),metadata:{name:c.metadata.name,description:c.metadata.description,uses:c.metadata.uses,types:c.metadata.types.map(k=>({name:k.name,definition:k.definition})),variables:c.metadata.variables.map(k=>({name:k.name,type:k.type})),references:c.metadata.references.map(k=>({kind:k.kind,target:k.target})),sections:c.metadata.sections.map(k=>({title:k.title,anchor:k.anchor,level:k.level}))},dependencies:{nodes:c.dependencies.nodes,edges:c.dependencies.edges.map(k=>({target:k.target,type:k.type}))}},d&&n.set(d,r);for(let k of c.dependencies.nodes)n.has(k)||n.set(k,i.get(k)||null);for(let k of c.dependencies.edges)d&&s.push({source:d,target:k.target,type:k.type})}let a={fileResults:t,unifiedGraph:{nodes:Array.from(n.entries()).map(([r,h])=>({id:r,file:h})),edges:s}};postMessage({type:"validateProject",id:o,result:a})}catch(t){postMessage({type:"error",id:o,error:t instanceof Error?t.message:String(t)})}}self.addEventListener("message",o=>{let e=o.data;switch(e.type){case"parse":et(e.id,e.source);break;case"validate":tt(e.id,e.source);break;case"validateProject":rt(e.id,e.files);break;case"completions":nt(e.id,e.uri,e.source,e.position);break;case"hover":st(e.id,e.uri,e.source,e.position);break;case"diagnostics":it(e.id,e.uri,e.source);break;case"semanticTokens":at(e.id,e.uri,e.source);break;default:postMessage({type:"error",id:e.id||0,error:`Unknown message type: ${e.type}`})}});postMessage({type:"ready"});})();
//# sourceMappingURL=zen-worker.min.js.map
