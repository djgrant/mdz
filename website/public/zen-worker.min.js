"use strict";(()=>{var Y=Object.create;var P=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var Z=Object.getPrototypeOf,X=Object.prototype.hasOwnProperty;var J=(r,e,t)=>e in r?P(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var y=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var ee=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Q(e))!X.call(r,n)&&n!==t&&P(r,n,{get:()=>e[n],enumerable:!(s=K(e,n))||s.enumerable});return r};var te=(r,e,t)=>(t=r!=null?Y(Z(r)):{},ee(e||!r||!r.__esModule?P(t,"default",{value:r,enumerable:!0}):t,r));var c=(r,e,t)=>J(r,typeof e!="symbol"?e+"":e,t);var x=y(E=>{"use strict";Object.defineProperty(E,"__esModule",{value:!0});E.createSpan=ie;E.mergeSpans=ae;E.isTypeDefinition=re;E.isVariableDeclaration=oe;E.isControlFlow=ce;E.isLoopStatement=he;E.isReference=pe;function ie(r,e,t,s,n,a){return{start:{line:r,column:e,offset:t},end:{line:s,column:n,offset:a}}}function ae(r,e){return{start:r.start.offset<e.start.offset?r.start:e.start,end:r.end.offset>e.end.offset?r.end:e.end}}function re(r){return r.kind==="TypeDefinition"}function oe(r){return r.kind==="VariableDeclaration"}function ce(r){return r.kind==="ForEachStatement"||r.kind==="ParallelForEachStatement"||r.kind==="WhileStatement"||r.kind==="IfStatement"}function he(r){return r.kind==="ForEachStatement"||r.kind==="ParallelForEachStatement"||r.kind==="WhileStatement"}function pe(r){return r.kind==="SkillReference"||r.kind==="SectionReference"}});var F=y(R=>{"use strict";Object.defineProperty(R,"__esModule",{value:!0});R.Lexer=void 0;R.tokenize=de;var le=x(),C=class{constructor(e){c(this,"source");c(this,"pos",0);c(this,"line",1);c(this,"column",0);c(this,"tokens",[]);c(this,"indentStack",[0]);this.source=e}tokenize(){for(;!this.isAtEnd();)this.scanToken();for(;this.indentStack.length>1;)this.indentStack.pop(),this.addToken("DEDENT","");return this.addToken("EOF",""),this.tokens}scanToken(){if(this.column===0){if(this.line===1&&this.lookAhead(`---
`)){this.consumeChars(3),this.addToken("FRONTMATTER_START","---"),this.consumeNewline(),this.scanFrontmatter();return}if(this.lookAhead(`---
`)||this.lookAhead("---")&&this.pos+3>=this.source.length){this.consumeChars(3),this.addToken("HORIZONTAL_RULE","---"),this.isAtEnd()||this.consumeNewline();return}this.handleIndent()}let e=this.peek();if(e===" "||e==="	"){this.advance();return}if(e===`
`){this.consumeNewline();return}if(e==="\r"){this.advance();return}if(this.column===0&&e==="#"){this.scanHeading();return}if(e==="-"&&this.peekAt(1)===" "){this.advance(),this.advance(),this.addToken("LIST_MARKER","- ");return}if(this.isDigit(e)&&this.peekAt(1)==="."&&this.peekAt(2)===" "){let s=this.advance();this.advance(),this.advance(),this.addToken("LIST_MARKER",s+". ");return}if(this.column===0&&this.lookAhead("```")){this.scanCodeBlock();return}if(this.column===0&&e===">"){this.scanBlockquote();return}if(this.lookAhead("{~~")){this.consumeChars(3),this.addToken("SEMANTIC_OPEN","{~~"),this.scanSemanticContent();return}if(this.lookAhead("[[")){this.consumeChars(2),this.addToken("DOUBLE_LBRACKET","[[");return}if(this.lookAhead("]]")){this.consumeChars(2),this.addToken("DOUBLE_RBRACKET","]]");return}if(this.lookAhead("=>")){this.consumeChars(2),this.addToken("ARROW","=>");return}if(this.lookAhead("!=")){this.consumeChars(2),this.addToken("NEQ","!=");return}if(this.lookAhead("<=")){this.consumeChars(2),this.addToken("LTE","<=");return}if(this.lookAhead(">=")){this.consumeChars(2),this.addToken("GTE",">=");return}let t={"=":"ASSIGN",":":"COLON","|":"PIPE",".":"DOT",",":"COMMA",";":"SEMICOLON","<":"LT",">":"GT","(":"LPAREN",")":"RPAREN","[":"LBRACKET","]":"RBRACKET","{":"LBRACE","}":"RBRACE"};if(t[e]){this.advance(),this.addToken(t[e],e);return}if(e==="$"){this.scanDollarIdent();return}if(e==="#"){this.scanHashIdent();return}if(e==='"'){this.scanString();return}if(e==="`"){this.scanTemplate();return}if(this.isDigit(e)||e==="-"&&this.isDigit(this.peekAt(1))){this.scanNumber();return}if(this.isAlpha(e)){this.scanIdentOrKeyword();return}this.advance(),this.addToken("TEXT",e)}handleIndent(){let e=0;for(;this.peek()===" ";)e++,this.advance();for(;this.peek()==="	";)e+=2,this.advance();if(this.peek()===`
`||this.isAtEnd())return;let t=this.indentStack[this.indentStack.length-1];if(e>t)this.indentStack.push(e),this.addToken("INDENT"," ".repeat(e-t));else if(e<t)for(;this.indentStack.length>1&&this.indentStack[this.indentStack.length-1]>e;)this.indentStack.pop(),this.addToken("DEDENT","")}scanFrontmatter(){for(;!this.isAtEnd();){if(this.column===0&&this.lookAhead("---")){this.consumeChars(3),this.addToken("FRONTMATTER_END","---"),!this.isAtEnd()&&this.peek()===`
`&&this.consumeNewline();return}let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();e&&this.addToken("TEXT",e),this.isAtEnd()||this.consumeNewline()}}scanHeading(){let e=0;for(;this.peek()==="#";)e++,this.advance();this.peek()===" "&&this.advance();let t="";for(;!this.isAtEnd()&&this.peek()!==`
`;)t+=this.advance();this.addToken("HEADING","#".repeat(e)+" "+t),this.isAtEnd()||this.consumeNewline()}scanCodeBlock(){this.consumeChars(3);let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();this.addToken("CODE_BLOCK_START","```"+e),this.isAtEnd()||this.consumeNewline();let t="";for(;!this.isAtEnd();){if(this.column===0&&this.lookAhead("```")){t&&this.addToken("CODE_BLOCK_CONTENT",t),this.consumeChars(3),this.addToken("CODE_BLOCK_END","```"),!this.isAtEnd()&&this.peek()===`
`&&this.consumeNewline();return}this.peek()===`
`?(t+=`
`,this.consumeNewlineRaw()):t+=this.advance()}t&&this.addToken("CODE_BLOCK_CONTENT",t)}scanBlockquote(){this.advance();let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();this.addToken("BLOCKQUOTE",">"+e),this.isAtEnd()||this.consumeNewline()}scanSemanticContent(){let e="";for(;!this.isAtEnd()&&this.peek()!=="}"&&this.peek()!==`
`;)e+=this.advance();e&&this.addToken("SEMANTIC_CONTENT",e),this.peek()==="}"&&(this.advance(),this.addToken("SEMANTIC_CLOSE","}"))}scanDollarIdent(){this.advance();let e="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)e+=this.advance();if(!e){this.addToken("ERROR","$");return}let t=e[0]>="A"&&e[0]<="Z"?"TYPE_IDENT":"DOLLAR_IDENT";this.addToken(t,"$"+e)}scanHashIdent(){this.advance();let e="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)e+=this.advance();this.addToken("LOWER_IDENT","#"+e)}scanString(){this.advance();let e="";for(;!this.isAtEnd()&&this.peek()!=='"'&&this.peek()!==`
`;)if(this.peek()==="\\"){this.advance();let t=this.advance();switch(t){case"n":e+=`
`;break;case"t":e+="	";break;case'"':e+='"';break;case"\\":e+="\\";break;default:e+=t}}else e+=this.advance();this.peek()==='"'?(this.advance(),this.addToken("STRING",e)):this.addToken("ERROR",'"'+e)}scanTemplate(){this.advance(),this.addToken("TEMPLATE_START","`");let e="";for(;!this.isAtEnd()&&this.peek()!=="`";)if(this.lookAhead("${")){e&&(this.addToken("TEMPLATE_PART",e),e=""),this.consumeChars(2);let t="",s=1;for(;!this.isAtEnd()&&s>0;)this.peek()==="{"&&s++,this.peek()==="}"&&s--,s>0&&(t+=this.advance());this.peek()==="}"&&this.advance(),this.addToken("DOLLAR_IDENT",t)}else this.lookAhead("{~~")?(e&&(this.addToken("TEMPLATE_PART",e),e=""),this.consumeChars(3),this.addToken("SEMANTIC_OPEN","{~~"),this.scanSemanticContent()):e+=this.advance();e&&this.addToken("TEMPLATE_PART",e),this.peek()==="`"&&(this.advance(),this.addToken("TEMPLATE_END","`"))}scanNumber(){let e="";for(this.peek()==="-"&&(e+=this.advance());this.isDigit(this.peek());)e+=this.advance();if(this.peek()==="."&&this.isDigit(this.peekAt(1)))for(e+=this.advance();this.isDigit(this.peek());)e+=this.advance();this.addToken("NUMBER",e)}scanIdentOrKeyword(){let e="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)e+=this.advance();let s={FOR:"FOR",EACH:"EACH",IN:"IN",WHILE:"WHILE",IF:"IF",THEN:"THEN",ELSE:"ELSE",AND:"AND",OR:"OR",NOT:"NOT",WITH:"WITH",PARALLEL:"PARALLEL",BREAK:"BREAK",CONTINUE:"CONTINUE",true:"TRUE",false:"FALSE"}[e]||(e[0]>="A"&&e[0]<="Z"?"UPPER_IDENT":"LOWER_IDENT");this.addToken(s,e)}isAtEnd(){return this.pos>=this.source.length}peek(){return this.isAtEnd()?"\0":this.source[this.pos]}peekAt(e){return this.pos+e>=this.source.length?"\0":this.source[this.pos+e]}advance(){let e=this.source[this.pos++];return this.column++,e}lookAhead(e){return this.source.slice(this.pos,this.pos+e.length)===e}consumeChars(e){for(let t=0;t<e;t++)this.advance()}consumeNewline(){this.peek()===`
`&&(this.pos++,this.line++,this.column=0,this.addToken("NEWLINE",`
`))}consumeNewlineRaw(){this.peek()===`
`&&(this.pos++,this.line++,this.column=0)}isDigit(e){return e>="0"&&e<="9"}isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e==="_"}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}addToken(e,t){let s=t.length;this.tokens.push({type:e,value:t,span:(0,le.createSpan)(this.line,this.column-s,this.pos-s,this.line,this.column,this.pos)})}};R.Lexer=C;function de(r){return new C(r).tokenize()}});var $=y(m=>{"use strict";var ue=m&&m.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var n=Object.getOwnPropertyDescriptor(e,t);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,n)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),ke=m&&m.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),fe=m&&m.__importStar||function(){var r=function(e){return r=Object.getOwnPropertyNames||function(t){var s=[];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[s.length]=n);return s},r(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=r(e),n=0;n<s.length;n++)s[n]!=="default"&&ue(t,e,s[n]);return ke(t,e),t}}();Object.defineProperty(m,"__esModule",{value:!0});m.Parser=void 0;m.parse=Ee;var me=F(),p=fe(x()),L=class{constructor(e){c(this,"source");c(this,"tokens",[]);c(this,"pos",0);c(this,"errors",[]);c(this,"frontmatterContent","");c(this,"loopDepth",0);this.source=e}parse(){this.tokens=(0,me.tokenize)(this.source),this.pos=0,this.errors=[],this.loopDepth=0;let e=this.parseFrontmatter(),t=this.parseSections(),s=this.tokens.length>0?p.mergeSpans(this.tokens[0].span,this.tokens[this.tokens.length-1].span):p.createSpan(1,0,0,1,0,0);return{kind:"Document",frontmatter:e,sections:t,errors:this.errors,span:s}}parseFrontmatter(){if(!this.check("FRONTMATTER_START"))return null;let e=this.advance(),t="";for(;!this.check("FRONTMATTER_END")&&!this.isAtEnd();){let a=this.advance();a.type==="TEXT"&&(t+=a.value+`
`)}if(!this.check("FRONTMATTER_END"))return this.error("E013","Unclosed frontmatter"),null;let s=this.advance();this.frontmatterContent=t;let n=this.parseYaml(t);return{kind:"Frontmatter",name:n.name||"",description:n.description||"",uses:n.uses||[],imports:this.parseImports(n.imports),raw:n,span:p.mergeSpans(e.span,s.span)}}parseYaml(e){let t={},s=e.split(`
`),n="",a=!1,i=!1,o=null;for(let h of s){let u=h.match(/^(\w+):\s*(.*)$/);if(u){n=u[1];let f=u[2].trim();f?(t[n]=f,a=!1,i=!1):(t[n]=[],a=!0,i=n==="imports");continue}if(i){let f=h.match(/^\s+-\s+path:\s*(.+)$/);if(f){o&&t[n].push(o),o={path:f[1].trim().replace(/^["']|["']$/g,"")};continue}let T=h.match(/^\s+skills:\s*\[([^\]]*)\]$/);if(T&&o){o.skills=T[1]?T[1].split(",").map(v=>v.trim().replace(/^["']|["']$/g,"")).filter(v=>v):[];continue}if(h.match(/^\s+alias:\s*$/)&&o){o.alias={};continue}let g=h.match(/^\s+([a-z-]+):\s*(.+)$/);if(g&&o&&o.alias!==void 0){o.alias[g[1]]=g[2].trim();continue}}let k=h.match(/^\s+-\s+(.+)$/);k&&a&&Array.isArray(t[n])&&!i&&t[n].push(k[1])}return i&&o&&t[n].push(o),t}parseImports(e){return!e||!Array.isArray(e)?[]:e.map(t=>({kind:"ImportDeclaration",path:t.path||"",skills:t.skills||[],aliases:new Map(Object.entries(t.alias||{})),span:p.createSpan(1,0,0,1,0,0)}))}parseSections(){let e=[];for(;!this.isAtEnd();)if(this.skipNewlines(),this.check("HEADING"))e.push(this.parseSection());else if(!this.isAtEnd()){let t=this.parseBlocks();if(t.length>0){let s=t[0].span;e.push({kind:"Section",level:0,title:"",anchor:"",content:t,span:s})}}return e}parseSection(){let e=this.advance(),t=e.value.match(/^(#+)\s+(.+)$/);if(!t)return this.error("E015","Invalid heading format"),this.createErrorSection(e);let s=t[1].length,n=t[2],a=n.toLowerCase().replace(/\s+/g,"-").replace(/[^\w-]/g,"");this.skipNewlines();let i=this.parseBlocks(),o=i.length>0?p.mergeSpans(e.span,i[i.length-1].span):e.span;return{kind:"Section",level:s,title:n,anchor:a,content:i,span:o}}createErrorSection(e){return{kind:"Section",level:1,title:"Error",anchor:"error",content:[],span:e.span}}parseBlocks(){let e=[];for(;!this.isAtEnd()&&!this.check("HEADING")&&(this.skipNewlines(),!(this.isAtEnd()||this.check("HEADING")));){let t=this.parseBlock();t&&e.push(t)}return e}parseBlock(){if(this.check("TYPE_IDENT")&&this.peek(1)?.type==="COLON"&&this.peek(2)?.type!=="TYPE_IDENT")return this.parseTypeDefinition();if(this.check("LIST_MARKER"))return this.parseListItem();if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT"))return this.parseVariableOrType();if(this.check("PARALLEL"))return this.parseParallelForEach();if(this.check("FOR"))return this.parseForEach();if(this.check("WHILE"))return this.parseWhile();if(this.check("IF"))return this.parseIf();if(this.check("BREAK"))return this.parseBreak();if(this.check("CONTINUE"))return this.parseContinue();if(this.check("CODE_BLOCK_START"))return this.parseCodeBlock();if(this.check("HORIZONTAL_RULE"))return this.parseHorizontalRule();if(this.check("BLOCKQUOTE"))return this.parseBlockquote();if(this.check("LOWER_IDENT")||this.check("UPPER_IDENT")){let e=this.current().value.toLowerCase();if((e==="execute"||e==="call"||e==="run"||e==="invoke"||e==="delegate"||e==="use")&&this.peek(1)?.type==="DOUBLE_LBRACKET")return this.parseDelegation()}return!this.isAtEnd()&&!this.check("HEADING")&&!this.check("NEWLINE")?this.parseParagraph():(this.isAtEnd()||this.advance(),null)}parseTypeDefinition(){let e=this.advance(),t=e.value.slice(1);this.expect("COLON");let s=this.parseTypeExpr();return{kind:"TypeDefinition",name:t,typeExpr:s,span:p.mergeSpans(e.span,s.span)}}parseTypeExpr(){let e=this.current();if(this.check("STRING"))return this.parseEnumType();if(this.check("LPAREN"))return this.parseCompoundType();if(this.check("TYPE_IDENT")){let t=this.advance(),s={kind:"TypeReference",name:t.value.slice(1),span:t.span};return this.check("LBRACKET")?(this.advance(),this.expect("RBRACKET"),{kind:"ArrayType",elementType:s,span:p.mergeSpans(t.span,this.previous().span)}):s}return this.parseSemanticTypeDefinition()}parseEnumType(){let e=[],t=this.current();for(;this.check("STRING");){let s=this.advance();if(e.push(s.value),this.check("PIPE"))this.advance();else break}return{kind:"EnumType",values:e,span:p.mergeSpans(t.span,this.previous().span)}}parseCompoundType(){let e=this.advance(),t=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)t.push(this.parseTypeExpr()),this.check("COMMA")&&this.advance();let s=this.expect("RPAREN"),n={kind:"CompoundType",elements:t,span:p.mergeSpans(e.span,s?.span||this.previous().span)};return this.check("LBRACKET")?(this.advance(),this.expect("RBRACKET"),{kind:"ArrayType",elementType:n,span:p.mergeSpans(e.span,this.previous().span)}):n}parseSemanticTypeDefinition(){let e="",t=this.current();for(;!this.check("NEWLINE")&&!this.isAtEnd();){let s=this.advance();e&&(e+=" "),e+=s.value}return{kind:"SemanticType",description:e.trim(),span:p.mergeSpans(t.span,this.previous().span)}}parseVariableOrType(){return this.check("TYPE_IDENT")&&this.peek(1)?.type==="COLON"&&this.peek(2)?.type!=="TYPE_IDENT"?this.parseTypeDefinition():this.parseVariableDeclaration()}parseVariableDeclaration(e=!1){let t=this.advance(),s=t.value.slice(1),n=null,a=!1;if(this.check("COLON")&&(this.advance(),this.check("TYPE_IDENT"))){let h=this.advance();n={kind:"TypeReference",name:h.value.slice(1),span:h.span}}let i=null,o=!1;return this.check("ASSIGN")?(this.advance(),this.check("DOLLAR_IDENT")||this.check("LPAREN")?this.findArrow()?(o=!0,i=this.parseLambdaExpression()):i=this.parseExpression():i=this.parseExpression()):e&&n&&(a=!0),{kind:"VariableDeclaration",name:s,typeAnnotation:n,value:i,isLambda:o,isRequired:a,span:p.mergeSpans(t.span,i?.span||n?.span||t.span)}}findArrow(){let e=0,t=0;for(;e<10;){let s=this.peek(e);if(!s)return!1;if(s.type==="LPAREN"&&t++,s.type==="RPAREN"&&t--,s.type==="ARROW"&&t===0)return!0;if(s.type==="NEWLINE")return!1;e++}return!1}parseListItem(){return this.advance(),this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")?this.parseVariableDeclaration():this.check("PARALLEL")?this.parseParallelForEach():this.check("FOR")?this.parseForEach():this.check("WHILE")?this.parseWhile():this.check("IF")?this.parseIf():this.check("BREAK")?this.parseBreak():this.check("CONTINUE")?this.parseContinue():this.parseParagraph()}parseExpression(){return this.parseOr()}parseOr(){let e=this.parseAnd();for(;this.check("OR");){this.advance();let t=this.parseAnd();e={kind:"BinaryExpression",operator:"OR",left:e,right:t,span:p.mergeSpans(e.span,t.span)}}return e}parseAnd(){let e=this.parseComparison();for(;this.check("AND");){this.advance();let t=this.parseComparison();e={kind:"BinaryExpression",operator:"AND",left:e,right:t,span:p.mergeSpans(e.span,t.span)}}return e}parseComparison(){let e=this.parsePrimary(),t=["ASSIGN","NEQ","LT","GT","LTE","GTE"];for(;t.some(s=>this.check(s));){let s=this.advance(),n=this.tokenToOperator(s.type),a=this.parsePrimary();e={kind:"BinaryExpression",operator:n,left:e,right:a,span:p.mergeSpans(e.span,a.span)}}return e}tokenToOperator(e){switch(e){case"ASSIGN":return"=";case"NEQ":return"!=";case"LT":return"<";case"GT":return">";case"LTE":return"<=";case"GTE":return">=";default:return"="}}parsePrimary(){let e=this.current();if((this.check("DOLLAR_IDENT")||this.check("LPAREN"))&&this.findArrow())return this.parseLambdaExpression();if(this.check("NOT")){let t=this.advance(),s=this.parsePrimary();return{kind:"UnaryExpression",operator:"NOT",operand:s,span:p.mergeSpans(t.span,s.span)}}if(this.check("LPAREN")){this.advance();let t=this.parseExpression();return this.expect("RPAREN"),t}if(this.check("STRING")){let t=this.advance();return{kind:"StringLiteral",value:t.value,span:t.span}}if(this.check("NUMBER")){let t=this.advance();return{kind:"NumberLiteral",value:parseFloat(t.value),span:t.span}}if(this.check("TRUE"))return{kind:"BooleanLiteral",value:!0,span:this.advance().span};if(this.check("FALSE"))return{kind:"BooleanLiteral",value:!1,span:this.advance().span};if(this.check("LBRACKET"))return this.parseArrayLiteral();if(this.check("TEMPLATE_START"))return this.parseTemplateLiteral();if(this.check("DOUBLE_LBRACKET"))return this.parseReference();if(this.check("SEMANTIC_OPEN"))return this.parseSemanticMarker();if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT"))return this.parseVariableReference();if(this.check("LOWER_IDENT")||this.check("UPPER_IDENT")||this.check("TEXT"))return this.parseInlineText();if(!this.isAtEnd()){let t=this.advance();return this.error("E001",`Unexpected token: ${t.type}`),{kind:"InlineText",text:t.value,span:t.span}}return{kind:"InlineText",text:"",span:e?.span||p.createSpan(1,0,0,1,0,0)}}parseLambdaExpression(){let e=this.current(),t=[];if(this.check("LPAREN")){for(this.advance();!this.check("RPAREN")&&!this.isAtEnd();)this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1)),this.check("COMMA")&&this.advance();this.expect("RPAREN")}else this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1));this.expect("ARROW");let s=this.parseExpression();return{kind:"LambdaExpression",params:t,body:s,span:p.mergeSpans(e.span,s.span)}}parseArrayLiteral(){let e=this.advance(),t=[];for(;!this.check("RBRACKET")&&!this.isAtEnd();)t.push(this.parseExpression()),this.check("COMMA")&&this.advance();let s=this.expect("RBRACKET");return{kind:"ArrayLiteral",elements:t,span:p.mergeSpans(e.span,s?.span||this.previous().span)}}parseTemplateLiteral(){let e=this.advance(),t=[];for(;!this.check("TEMPLATE_END")&&!this.isAtEnd();)if(this.check("TEMPLATE_PART"))t.push(this.advance().value);else if(this.check("DOLLAR_IDENT")){let n=this.advance();t.push({kind:"VariableReference",name:n.value.slice(1),span:n.span})}else this.check("SEMANTIC_OPEN")?t.push(this.parseSemanticMarker()):this.advance();let s=this.expect("TEMPLATE_END");return{kind:"TemplateLiteral",parts:t,span:p.mergeSpans(e.span,s?.span||this.previous().span)}}parseReference(){let e=this.advance(),t=null,s=null;if(this.check("LOWER_IDENT")){let i=this.advance().value;i.startsWith("#")?s=i.slice(1):t=i}if(t&&this.check("LOWER_IDENT")){let i=this.advance().value;i.startsWith("#")&&(s=i.slice(1))}let n=this.expect("DOUBLE_RBRACKET"),a=p.mergeSpans(e.span,n?.span||this.previous().span);return s!==null?{kind:"SectionReference",skill:t,section:s,span:a}:{kind:"SkillReference",skill:t||"",span:a}}parseSemanticMarker(){let e=this.advance(),t="",s=[];for(;!this.check("SEMANTIC_CLOSE")&&!this.isAtEnd();)if(this.check("SEMANTIC_CONTENT"))t+=this.advance().value;else if(this.check("DOLLAR_IDENT")){let a=this.advance();t+=a.value,s.push({kind:"VariableReference",name:a.value.slice(1),span:a.span})}else t+=this.advance().value;let n=this.expect("SEMANTIC_CLOSE");return{kind:"SemanticMarker",content:t,interpolations:s,span:p.mergeSpans(e.span,n?.span||this.previous().span)}}parseVariableReference(){let e=this.advance(),s={kind:"VariableReference",name:e.value.slice(1),span:e.span};for(;this.check("DOT");)if(this.advance(),this.check("LOWER_IDENT")||this.check("UPPER_IDENT")){let n=this.advance();s={kind:"MemberAccess",object:s,property:n.value,span:p.mergeSpans(e.span,n.span)}}if(this.check("LPAREN")){this.advance();let n=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)n.push(this.parseExpression()),this.check("COMMA")&&this.advance();let a=this.expect("RPAREN");s={kind:"FunctionCall",callee:s,args:n,span:p.mergeSpans(e.span,a?.span||this.previous().span)}}return s}parseInlineText(){let e="",t=this.current();for(;!this.isAtEnd()&&!this.check("NEWLINE")&&!this.check("DOUBLE_LBRACKET")&&!this.check("SEMANTIC_OPEN")&&!this.check("DOLLAR_IDENT")&&!this.check("TYPE_IDENT");)e&&(e+=" "),e+=this.advance().value;return{kind:"InlineText",text:e.trim(),span:p.mergeSpans(t.span,this.previous().span)}}parseForEach(){let e=this.advance();this.expect("EACH");let t=this.parsePattern();this.expect("IN");let s=this.parseExpression();this.expect("COLON"),this.skipNewlines(),this.loopDepth++;let n=this.parseIndentedBlocks();return this.loopDepth--,{kind:"ForEachStatement",pattern:t,collection:s,body:n,span:p.mergeSpans(e.span,n.length>0?n[n.length-1].span:s.span)}}parseParallelForEach(){let e=this.advance();this.expect("FOR"),this.expect("EACH");let t=this.parsePattern();this.expect("IN");let s=this.parseExpression();this.expect("COLON"),this.skipNewlines(),this.loopDepth++;let n=this.parseIndentedBlocks();return this.loopDepth--,{kind:"ParallelForEachStatement",pattern:t,collection:s,body:n,mergeStrategy:"collect",span:p.mergeSpans(e.span,n.length>0?n[n.length-1].span:s.span)}}parseWhile(){let e=this.advance();this.expect("LPAREN");let t=this.parseCondition();this.expect("RPAREN"),this.expect("COLON"),this.skipNewlines(),this.loopDepth++;let s=this.parseIndentedBlocks();return this.loopDepth--,{kind:"WhileStatement",condition:t,body:s,span:p.mergeSpans(e.span,s.length>0?s[s.length-1].span:t.span)}}parseIf(){let e=this.advance(),t=this.parseCondition();this.expect("THEN"),this.expect("COLON"),this.skipNewlines();let s=this.parseIndentedBlocks(),n=null;return this.check("ELSE")&&(this.advance(),this.expect("COLON"),this.skipNewlines(),n=this.parseIndentedBlocks()),{kind:"IfStatement",condition:t,thenBody:s,elseBody:n,span:p.mergeSpans(e.span,n?.length?n[n.length-1].span:s.length?s[s.length-1].span:t.span)}}parseBreak(){let e=this.advance();return this.loopDepth===0&&this.error("E016","BREAK can only be used inside a loop"),{kind:"BreakStatement",span:e.span}}parseContinue(){let e=this.advance();return this.loopDepth===0&&this.error("E017","CONTINUE can only be used inside a loop"),{kind:"ContinueStatement",span:e.span}}parsePattern(){if(this.check("LPAREN")){let e=this.advance(),t=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1)),this.check("COMMA")&&this.advance();let s=this.expect("RPAREN");return{kind:"DestructuringPattern",names:t,span:p.mergeSpans(e.span,s?.span||this.previous().span)}}if(this.check("DOLLAR_IDENT")){let e=this.advance();return{kind:"SimplePattern",name:e.value.slice(1),span:e.span}}return this.error("E005","Expected pattern"),{kind:"SimplePattern",name:"",span:this.current().span}}parseCondition(){return this.parseOrCondition()}parseOrCondition(){let e=this.parseAndCondition();for(;this.check("OR");){this.advance();let t=this.parseAndCondition();e={kind:"CompoundCondition",operator:"OR",left:e,right:t,span:p.mergeSpans(e.span,t.span)}}return e}parseAndCondition(){let e=this.parsePrimaryCondition();for(;this.check("AND");){this.advance();let t=this.parsePrimaryCondition();e={kind:"CompoundCondition",operator:"AND",left:e,right:t,span:p.mergeSpans(e.span,t.span)}}return e}parsePrimaryCondition(){let e=this.check("NOT");if(e&&this.advance(),this.check("LPAREN")){this.advance();let n=this.parseCondition();return this.expect("RPAREN"),n}if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")){let n=this.parseVariableReference();if(this.check("ASSIGN")||this.check("NEQ")||this.check("LT")||this.check("GT")||this.check("LTE")||this.check("GTE")){let a=this.advance(),i=this.tokenToOperator(a.type),o=this.parsePrimary();return{kind:"DeterministicCondition",left:n,operator:i,right:o,span:p.mergeSpans(n.span,o.span)}}return{kind:"SemanticCondition",text:"$"+n.name,negated:e,span:n.span}}let t="",s=this.current();for(;!this.isAtEnd()&&!this.check("RPAREN")&&!this.check("AND")&&!this.check("OR")&&!this.check("THEN")&&!this.check("COLON");)t&&(t+=" "),t+=this.advance().value;return{kind:"SemanticCondition",text:t.trim(),negated:e,span:p.mergeSpans(s.span,this.previous().span)}}parseIndentedBlocks(){let e=[];for(this.check("INDENT")&&this.advance();!this.check("DEDENT")&&!this.isAtEnd()&&!this.check("HEADING")&&(this.skipNewlines(),!(this.check("DEDENT")||this.isAtEnd()||this.check("HEADING")));){let t=this.parseBlock();t&&e.push(t)}return this.check("DEDENT")&&this.advance(),e}parseParagraph(){let e=[],t=this.current();for(;!this.isAtEnd()&&!this.check("NEWLINE")&&!this.check("HEADING");)if(this.check("DOUBLE_LBRACKET"))e.push(this.parseReference());else if(this.check("SEMANTIC_OPEN"))e.push(this.parseSemanticMarker());else if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")){let s=this.advance();e.push({kind:"VariableReference",name:s.value.slice(1),span:s.span})}else{let s=this.parseInlineText();s.text&&e.push(s)}return this.check("NEWLINE")&&this.advance(),{kind:"Paragraph",content:e,span:p.mergeSpans(t.span,this.previous().span)}}parseCodeBlock(){let e=this.advance(),s=e.value.match(/^```(\w*)$/)?.[1]||null,n="";this.check("CODE_BLOCK_CONTENT")&&(n=this.advance().value);let a=this.expect("CODE_BLOCK_END");return{kind:"CodeBlock",language:s,content:n,span:p.mergeSpans(e.span,a?.span||this.previous().span)}}parseHorizontalRule(){return{kind:"HorizontalRule",span:this.advance().span}}parseDelegation(){let e=this.advance(),t=e.value,s=this.parseReference(),n=[];if(this.check("WITH"))for(this.advance(),this.expect("COLON"),this.skipNewlines();this.check("LIST_MARKER")&&!this.isAtEnd();){this.advance();let i=this.parseVariableDeclaration(!0);if(n.push(i),this.skipNewlines(),!this.check("LIST_MARKER")||this.check("HEADING"))break}let a=p.mergeSpans(e.span,this.previous().span);return{kind:"Delegation",verb:t,target:s,parameters:n,span:a}}parseBlockquote(){let e=this.advance();return{kind:"Paragraph",content:[{kind:"InlineText",text:e.value.slice(1).trim(),span:e.span}],span:e.span}}isAtEnd(){return this.pos>=this.tokens.length||this.current().type==="EOF"}current(){return this.tokens[this.pos]||{type:"EOF",value:"",span:p.createSpan(1,0,0,1,0,0)}}previous(){return this.tokens[this.pos-1]||this.current()}peek(e=0){let t=this.pos+e;return t<this.tokens.length?this.tokens[t]:null}advance(){return this.isAtEnd()||this.pos++,this.previous()}check(e){return this.current().type===e}expect(e){return this.check(e)?this.advance():(this.error("E001",`Expected ${e}, got ${this.current().type}`),null)}skipNewlines(){for(;this.check("NEWLINE");)this.advance()}error(e,t){this.errors.push({kind:"ParseError",code:e,message:t,recoverable:!0,span:this.current().span})}};m.Parser=L;function Ee(r){return new L(r).parse()}});var U=y(A=>{"use strict";Object.defineProperty(A,"__esModule",{value:!0});A.Compiler=void 0;A.compile=W;A.createRegistry=ge;A.buildFullDependencyGraph=ve;var H=$(),Te=new Set(["String","Number","Boolean"]),I=class{constructor(e={},t){c(this,"options");c(this,"registry");c(this,"diagnostics",[]);c(this,"sourceMap",[]);c(this,"metadata");c(this,"dependencies");c(this,"definedTypes",new Set);c(this,"definedVariables",new Set);c(this,"declaredDeps",new Set);this.options={includeHeader:!1,generateSourceMap:!0,validateReferences:!0,validateTypes:!0,validateScope:!0,validateContracts:!0,...e},this.registry=t||null,this.metadata=this.createEmptyMetadata(),this.dependencies={nodes:[],edges:[],cycles:[]}}createEmptyMetadata(){return{name:"",description:"",uses:[],imports:[],types:[],variables:[],references:[],sections:[],parameters:[]}}compile(e){this.diagnostics=[],this.sourceMap=[],this.metadata=this.createEmptyMetadata(),this.dependencies={nodes:[],edges:[],cycles:[]},this.definedTypes.clear(),this.definedVariables.clear(),this.declaredDeps.clear();let t=(0,H.parse)(e);for(let n of t.errors)this.diagnostics.push({severity:"error",code:n.code,message:n.message,span:n.span});this.extractMetadata(t),this.buildDependencyGraph(t),this.options.validateTypes&&this.validateTypes(t),this.options.validateScope&&this.validateScope(t),this.options.validateReferences&&this.validateReferences(),this.options.validateContracts&&this.validateContracts(t);let s=e;return this.options.includeHeader&&(s=`<!-- MDZ Validated: ${this.metadata.name||"unnamed"} -->
<!-- Errors: ${this.diagnostics.filter(a=>a.severity==="error").length}, Warnings: ${this.diagnostics.filter(a=>a.severity==="warning").length} -->

`+e),{output:s,diagnostics:this.diagnostics,metadata:this.metadata,sourceMap:this.sourceMap,dependencies:this.dependencies}}extractMetadata(e){if(e.frontmatter){this.metadata.name=e.frontmatter.name,this.metadata.description=e.frontmatter.description,this.metadata.uses=[...e.frontmatter.uses];for(let t of e.frontmatter.uses)this.declaredDeps.add(t);for(let t of e.frontmatter.imports){this.metadata.imports.push({path:t.path,skills:[...t.skills],aliases:new Map(t.aliases)});for(let s of t.skills)this.declaredDeps.add(s)}}for(let t of e.sections)t.title&&this.metadata.sections.push({title:t.title,anchor:t.anchor,level:t.level,span:t.span}),t.title==="Input"&&this.extractParameters(t.content),this.extractFromBlocks(t.content)}extractFromBlocks(e){for(let t of e)this.extractFromBlock(t)}extractFromBlock(e){switch(e.kind){case"TypeDefinition":this.extractTypeDefinition(e);break;case"VariableDeclaration":this.extractVariableDeclaration(e);break;case"ForEachStatement":case"ParallelForEachStatement":this.extractFromControlFlow(e);break;case"WhileStatement":this.extractFromBlocks(e.body);break;case"IfStatement":this.extractFromBlocks(e.thenBody),e.elseBody&&this.extractFromBlocks(e.elseBody);break;case"Paragraph":this.extractFromParagraph(e);break;case"Delegation":this.extractFromDelegation(e);break}}extractTypeDefinition(e){let t={name:e.name,definition:this.typeExprToString(e.typeExpr),span:e.span};this.metadata.types.push(t),this.definedTypes.add(e.name),this.sourceMap.push({source:e.span,type:"type-def",name:e.name})}typeExprToString(e){switch(e.kind){case"SemanticType":return e.description;case"EnumType":return e.values.map(t=>`"${t}"`).join(" | ");case"TypeReference":return`$${e.name}`;case"CompoundType":return"("+e.elements.map(t=>this.typeExprToString(t)).join(", ")+")";case"ArrayType":return this.typeExprToString(e.elementType)+"[]";case"FunctionType":return`(${e.params.join(", ")}) => ${this.typeExprToString(e.returnType)}`;default:return""}}extractVariableDeclaration(e){let t={name:e.name,type:e.typeAnnotation?.name||null,hasDefault:e.value!==null,isRequired:e.isRequired||!1,span:e.span};this.metadata.variables.push(t),this.definedVariables.add(e.name),this.sourceMap.push({source:e.span,type:"variable",name:e.name}),e.value&&this.extractFromExpression(e.value)}extractFromControlFlow(e){if(e.pattern.kind==="SimplePattern")this.definedVariables.add(e.pattern.name);else for(let t of e.pattern.names)this.definedVariables.add(t);this.sourceMap.push({source:e.span,type:"control-flow",name:e.kind}),this.extractFromExpression(e.collection),this.extractFromBlocks(e.body)}extractFromParagraph(e){for(let t of e.content)t.kind==="SkillReference"?this.extractSkillReference(t):t.kind==="SectionReference"?this.extractSectionReference(t):t.kind==="SemanticMarker"&&this.sourceMap.push({source:t.span,type:"semantic",name:t.content})}extractFromDelegation(e){e.target.kind==="SkillReference"?this.extractSkillReference(e.target):this.extractSectionReference(e.target);for(let t of e.parameters)this.extractVariableDeclaration(t)}extractParameters(e){for(let t of e)t.kind==="VariableDeclaration"&&this.metadata.parameters.push({name:t.name,type:t.typeAnnotation?.name||null,hasDefault:t.value!==null,isRequired:!t.value,span:t.span})}extractFromExpression(e){switch(e.kind){case"SkillReference":this.extractSkillReference(e);break;case"SectionReference":this.extractSectionReference(e);break;case"SemanticMarker":this.sourceMap.push({source:e.span,type:"semantic",name:e.content});break;case"BinaryExpression":this.extractFromExpression(e.left),this.extractFromExpression(e.right);break;case"UnaryExpression":this.extractFromExpression(e.operand);break;case"ArrayLiteral":for(let t of e.elements)this.extractFromExpression(t);break;case"FunctionCall":this.extractFromExpression(e.callee);for(let t of e.args)this.extractFromExpression(t);break;case"MemberAccess":this.extractFromExpression(e.object);break;case"LambdaExpression":this.extractFromExpression(e.body);break}}extractSkillReference(e){this.metadata.references.push({kind:"skill",target:e.skill,skill:e.skill,span:e.span}),this.sourceMap.push({source:e.span,type:"reference",name:e.skill})}extractSectionReference(e){this.metadata.references.push({kind:"section",target:e.skill?`${e.skill}#${e.section}`:`#${e.section}`,skill:e.skill||void 0,section:e.section,span:e.span}),this.sourceMap.push({source:e.span,type:"reference",name:e.skill?`${e.skill}#${e.section}`:`#${e.section}`})}buildDependencyGraph(e){let t=new Set,s=[];if(e.frontmatter)for(let n of e.frontmatter.uses)t.add(n),s.push({target:n,type:"uses"});for(let n of this.metadata.references)n.kind==="skill"&&n.skill?(t.add(n.skill),s.push({target:n.skill,type:"reference",span:n.span})):n.kind==="section"&&n.skill&&(t.add(n.skill),s.push({target:n.skill,type:"reference",span:n.span}));this.dependencies.nodes=Array.from(t),this.dependencies.edges=s}validateTypes(e){for(let t of this.metadata.variables)if(t.type&&!this.definedTypes.has(t.type)){if(Te.has(t.type))continue;this.diagnostics.push({severity:"warning",code:"E008",message:`Type '$${t.type}' is not defined in this document`,span:t.span})}}validateScope(e){let t=new Set;for(let s of e.sections)this.checkScopeInBlocks(s.content,t)}checkScopeInBlocks(e,t){for(let s of e)if(s.kind==="VariableDeclaration")this.definedVariables.add(s.name),s.value&&this.checkExpressionScope(s.value,t);else if(s.kind==="ForEachStatement"||s.kind==="ParallelForEachStatement"){if(this.checkExpressionScope(s.collection,t),s.pattern.kind==="SimplePattern")this.definedVariables.add(s.pattern.name);else for(let n of s.pattern.names)this.definedVariables.add(n);this.checkScopeInBlocks(s.body,t)}else if(s.kind==="WhileStatement")this.checkScopeInBlocks(s.body,t);else if(s.kind==="IfStatement")this.checkScopeInBlocks(s.thenBody,t),s.elseBody&&this.checkScopeInBlocks(s.elseBody,t);else if(s.kind==="Paragraph")for(let n of s.content)n.kind==="VariableReference"&&(this.definedVariables.has(n.name)||t.add(n.name))}checkExpressionScope(e,t){if(e.kind==="VariableReference")this.definedVariables.has(e.name)||t.add(e.name);else if(e.kind==="BinaryExpression")this.checkExpressionScope(e.left,t),this.checkExpressionScope(e.right,t);else if(e.kind==="UnaryExpression")this.checkExpressionScope(e.operand,t);else if(e.kind==="ArrayLiteral")for(let s of e.elements)this.checkExpressionScope(s,t)}validateReferences(){for(let e of this.metadata.references)e.kind==="skill"&&e.skill?this.declaredDeps.has(e.skill)||this.diagnostics.push({severity:"warning",code:"W001",message:`Skill '${e.skill}' is referenced but not declared in 'uses:'`,span:e.span}):e.kind==="section"&&e.skill&&(this.declaredDeps.has(e.skill)||this.diagnostics.push({severity:"warning",code:"W001",message:`Skill '${e.skill}' is referenced but not declared in 'uses:'`,span:e.span}));for(let e of this.metadata.references)e.kind==="section"&&!e.skill&&e.section&&(this.metadata.sections.some(s=>s.anchor===e.section)||this.diagnostics.push({severity:"error",code:"E010",message:`Section '#${e.section}' does not exist in this document`,span:e.span}));if(this.registry)for(let e of this.metadata.references)e.kind==="skill"&&e.skill&&(this.registry.get(e.skill)||this.diagnostics.push({severity:"error",code:"E009",message:`Skill '${e.skill}' is not found in registry`,span:e.span}))}validateContracts(e){let t=[];this.findDelegations(e.sections,t);for(let s of t)s.target.kind==="SkillReference"&&s.target.skill&&this.validateDelegationParameters(s)}findDelegations(e,t){for(let s of e)this.findDelegationsInBlocks(s.content,t)}findDelegationsInBlocks(e,t){for(let s of e)s.kind==="Delegation"?t.push(s):s.kind==="ForEachStatement"||s.kind==="ParallelForEachStatement"?this.findDelegationsInBlocks(s.body,t):s.kind==="WhileStatement"?this.findDelegationsInBlocks(s.body,t):s.kind==="IfStatement"&&(this.findDelegationsInBlocks(s.thenBody,t),s.elseBody&&this.findDelegationsInBlocks(s.elseBody,t))}validateDelegationParameters(e){let t=e.target.skill,s=[];if(t===this.metadata.name)s=this.metadata.parameters;else if(this.registry){let i=this.registry.get(t);i&&(s=W(i.source,{validateReferences:!1,validateContracts:!1}).metadata.parameters)}let n=new Set(e.parameters.map(i=>i.name)),a=s.filter(i=>i.isRequired);for(let i of a)n.has(i.name)||this.diagnostics.push({severity:"error",code:"E011",message:`Required parameter '${i.name}' is missing for skill '${t}'`,span:e.span});if(e.parameters.length>0)for(let i of e.parameters)s.find(h=>h.name===i.name)||this.diagnostics.push({severity:"warning",code:"W002",message:`Parameter '${i.name}' is not defined for skill '${t}'`,span:i.span})}};A.Compiler=I;function W(r,e,t){return new I(e,t).compile(r)}function ge(r){let e=new Map;return{get(t){if(e.has(t))return e.get(t);let s=r[t];if(!s)return;let n=(0,H.parse)(s),a={name:t,source:s,ast:n};return e.set(t,a),a},getSection(t,s){let n=this.get(t);if(!n)return;let a=n.ast.sections.find(i=>i.anchor===s);if(a)return`[Section: ${a.title}]`},list(){return Object.keys(r)}}}function ve(r){let e=new Map,t=r.list();for(let h of t){let u=r.get(h);if(u){let k=W(u.source,{validateReferences:!1});e.set(h,k.dependencies.nodes)}}let s=[],n=new Set,a=new Set,i=[];function o(h){n.add(h),a.add(h),i.push(h);let u=e.get(h)||[];for(let k of u)if(!n.has(k))o(k);else if(a.has(k)){let f=i.indexOf(k);s.push([...i.slice(f),k])}i.pop(),a.delete(h)}for(let h of t)n.has(h)||o(h);return{graph:e,cycles:s}}});var z=y(d=>{"use strict";var Se=d&&d.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var n=Object.getOwnPropertyDescriptor(e,t);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,n)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),Ae=d&&d.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),ye=d&&d.__importStar||function(){var r=function(e){return r=Object.getOwnPropertyNames||function(t){var s=[];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[s.length]=n);return s},r(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(e!=null)for(var s=r(e),n=0;n<s.length;n++)s[n]!=="default"&&Se(t,e,s[n]);return Ae(t,e),t}}();Object.defineProperty(d,"__esModule",{value:!0});d.buildFullDependencyGraph=d.createRegistry=d.Compiler=d.compile=d.AST=d.Lexer=d.tokenize=d.parse=void 0;var Re=$();Object.defineProperty(d,"parse",{enumerable:!0,get:function(){return Re.parse}});var G=F();Object.defineProperty(d,"tokenize",{enumerable:!0,get:function(){return G.tokenize}});Object.defineProperty(d,"Lexer",{enumerable:!0,get:function(){return G.Lexer}});d.AST=ye(x());var b=U();Object.defineProperty(d,"compile",{enumerable:!0,get:function(){return b.compile}});Object.defineProperty(d,"Compiler",{enumerable:!0,get:function(){return b.Compiler}});Object.defineProperty(d,"createRegistry",{enumerable:!0,get:function(){return b.createRegistry}});Object.defineProperty(d,"buildFullDependencyGraph",{enumerable:!0,get:function(){return b.buildFullDependencyGraph}})});function S(r,e,t,s,n,a){return{start:{line:r,column:e,offset:t},end:{line:s,column:n,offset:a}}}function l(r,e){return{start:r.start.offset<e.start.offset?r.start:e.start,end:r.end.offset>e.end.offset?r.end:e.end}}var B=class{constructor(e){c(this,"source");c(this,"pos",0);c(this,"line",1);c(this,"column",0);c(this,"tokens",[]);c(this,"indentStack",[0]);this.source=e}tokenize(){for(;!this.isAtEnd();)this.scanToken();for(;this.indentStack.length>1;)this.indentStack.pop(),this.addToken("DEDENT","");return this.addToken("EOF",""),this.tokens}scanToken(){if(this.column===0){if(this.line===1&&this.lookAhead(`---
`)){this.consumeChars(3),this.addToken("FRONTMATTER_START","---"),this.consumeNewline(),this.scanFrontmatter();return}if(this.lookAhead(`---
`)||this.lookAhead("---")&&this.pos+3>=this.source.length){this.consumeChars(3),this.addToken("HORIZONTAL_RULE","---"),this.isAtEnd()||this.consumeNewline();return}this.handleIndent()}let e=this.peek();if(e===" "||e==="	"){this.advance();return}if(e===`
`){this.consumeNewline();return}if(e==="\r"){this.advance();return}if(this.column===0&&e==="#"){this.scanHeading();return}if(e==="-"&&this.peekAt(1)===" "){this.advance(),this.advance(),this.addToken("LIST_MARKER","- ");return}if(this.isDigit(e)&&this.peekAt(1)==="."&&this.peekAt(2)===" "){let s=this.advance();this.advance(),this.advance(),this.addToken("LIST_MARKER",s+". ");return}if(this.column===0&&this.lookAhead("```")){this.scanCodeBlock();return}if(this.column===0&&e===">"){this.scanBlockquote();return}if(this.lookAhead("{~~")){this.consumeChars(3),this.addToken("SEMANTIC_OPEN","{~~"),this.scanSemanticContent();return}if(this.lookAhead("[[")){this.consumeChars(2),this.addToken("DOUBLE_LBRACKET","[[");return}if(this.lookAhead("]]")){this.consumeChars(2),this.addToken("DOUBLE_RBRACKET","]]");return}if(this.lookAhead("=>")){this.consumeChars(2),this.addToken("ARROW","=>");return}if(this.lookAhead("!=")){this.consumeChars(2),this.addToken("NEQ","!=");return}if(this.lookAhead("<=")){this.consumeChars(2),this.addToken("LTE","<=");return}if(this.lookAhead(">=")){this.consumeChars(2),this.addToken("GTE",">=");return}let t={"=":"ASSIGN",":":"COLON","|":"PIPE",".":"DOT",",":"COMMA",";":"SEMICOLON","<":"LT",">":"GT","(":"LPAREN",")":"RPAREN","[":"LBRACKET","]":"RBRACKET","{":"LBRACE","}":"RBRACE"};if(t[e]){this.advance(),this.addToken(t[e],e);return}if(e==="$"){this.scanDollarIdent();return}if(e==="#"){this.scanHashIdent();return}if(e==='"'){this.scanString();return}if(e==="`"){this.scanTemplate();return}if(this.isDigit(e)||e==="-"&&this.isDigit(this.peekAt(1))){this.scanNumber();return}if(this.isAlpha(e)){this.scanIdentOrKeyword();return}this.advance(),this.addToken("TEXT",e)}handleIndent(){let e=0;for(;this.peek()===" ";)e++,this.advance();for(;this.peek()==="	";)e+=2,this.advance();if(this.peek()===`
`||this.isAtEnd())return;let t=this.indentStack[this.indentStack.length-1];if(e>t)this.indentStack.push(e),this.addToken("INDENT"," ".repeat(e-t));else if(e<t)for(;this.indentStack.length>1&&this.indentStack[this.indentStack.length-1]>e;)this.indentStack.pop(),this.addToken("DEDENT","")}scanFrontmatter(){for(;!this.isAtEnd();){if(this.column===0&&this.lookAhead("---")){this.consumeChars(3),this.addToken("FRONTMATTER_END","---"),!this.isAtEnd()&&this.peek()===`
`&&this.consumeNewline();return}let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();e&&this.addToken("TEXT",e),this.isAtEnd()||this.consumeNewline()}}scanHeading(){let e=0;for(;this.peek()==="#";)e++,this.advance();this.peek()===" "&&this.advance();let t="";for(;!this.isAtEnd()&&this.peek()!==`
`;)t+=this.advance();this.addToken("HEADING","#".repeat(e)+" "+t),this.isAtEnd()||this.consumeNewline()}scanCodeBlock(){this.consumeChars(3);let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();this.addToken("CODE_BLOCK_START","```"+e),this.isAtEnd()||this.consumeNewline();let t="";for(;!this.isAtEnd();){if(this.column===0&&this.lookAhead("```")){t&&this.addToken("CODE_BLOCK_CONTENT",t),this.consumeChars(3),this.addToken("CODE_BLOCK_END","```"),!this.isAtEnd()&&this.peek()===`
`&&this.consumeNewline();return}this.peek()===`
`?(t+=`
`,this.consumeNewlineRaw()):t+=this.advance()}t&&this.addToken("CODE_BLOCK_CONTENT",t)}scanBlockquote(){this.advance();let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();this.addToken("BLOCKQUOTE",">"+e),this.isAtEnd()||this.consumeNewline()}scanSemanticContent(){let e="";for(;!this.isAtEnd()&&this.peek()!=="}"&&this.peek()!==`
`;)e+=this.advance();e&&this.addToken("SEMANTIC_CONTENT",e),this.peek()==="}"&&(this.advance(),this.addToken("SEMANTIC_CLOSE","}"))}scanDollarIdent(){this.advance();let e="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)e+=this.advance();if(!e){this.addToken("ERROR","$");return}let t=e[0]>="A"&&e[0]<="Z"?"TYPE_IDENT":"DOLLAR_IDENT";this.addToken(t,"$"+e)}scanHashIdent(){this.advance();let e="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)e+=this.advance();this.addToken("LOWER_IDENT","#"+e)}scanString(){this.advance();let e="";for(;!this.isAtEnd()&&this.peek()!=='"'&&this.peek()!==`
`;)if(this.peek()==="\\"){this.advance();let t=this.advance();switch(t){case"n":e+=`
`;break;case"t":e+="	";break;case'"':e+='"';break;case"\\":e+="\\";break;default:e+=t}}else e+=this.advance();this.peek()==='"'?(this.advance(),this.addToken("STRING",e)):this.addToken("ERROR",'"'+e)}scanTemplate(){this.advance(),this.addToken("TEMPLATE_START","`");let e="";for(;!this.isAtEnd()&&this.peek()!=="`";)if(this.lookAhead("${")){e&&(this.addToken("TEMPLATE_PART",e),e=""),this.consumeChars(2);let t="",s=1;for(;!this.isAtEnd()&&s>0;)this.peek()==="{"&&s++,this.peek()==="}"&&s--,s>0&&(t+=this.advance());this.peek()==="}"&&this.advance(),this.addToken("DOLLAR_IDENT",t)}else this.lookAhead("{~~")?(e&&(this.addToken("TEMPLATE_PART",e),e=""),this.consumeChars(3),this.addToken("SEMANTIC_OPEN","{~~"),this.scanSemanticContent()):e+=this.advance();e&&this.addToken("TEMPLATE_PART",e),this.peek()==="`"&&(this.advance(),this.addToken("TEMPLATE_END","`"))}scanNumber(){let e="";for(this.peek()==="-"&&(e+=this.advance());this.isDigit(this.peek());)e+=this.advance();if(this.peek()==="."&&this.isDigit(this.peekAt(1)))for(e+=this.advance();this.isDigit(this.peek());)e+=this.advance();this.addToken("NUMBER",e)}scanIdentOrKeyword(){let e="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)e+=this.advance();let s={FOR:"FOR",EACH:"EACH",IN:"IN",WHILE:"WHILE",DO:"DO",IF:"IF",THEN:"THEN",ELSE:"ELSE",AND:"AND",OR:"OR",NOT:"NOT",WITH:"WITH",PARALLEL:"PARALLEL",BREAK:"BREAK",CONTINUE:"CONTINUE",true:"TRUE",false:"FALSE"}[e]||(e[0]>="A"&&e[0]<="Z"?"UPPER_IDENT":"LOWER_IDENT");this.addToken(s,e)}isAtEnd(){return this.pos>=this.source.length}peek(){return this.isAtEnd()?"\0":this.source[this.pos]}peekAt(e){return this.pos+e>=this.source.length?"\0":this.source[this.pos+e]}advance(){let e=this.source[this.pos++];return this.column++,e}lookAhead(e){return this.source.slice(this.pos,this.pos+e.length)===e}consumeChars(e){for(let t=0;t<e;t++)this.advance()}consumeNewline(){this.peek()===`
`&&(this.pos++,this.line++,this.column=0,this.addToken("NEWLINE",`
`))}consumeNewlineRaw(){this.peek()===`
`&&(this.pos++,this.line++,this.column=0)}isDigit(e){return e>="0"&&e<="9"}isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e==="_"}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}addToken(e,t){let s=t.length;this.tokens.push({type:e,value:t,span:S(this.line,this.column-s,this.pos-s,this.line,this.column,this.pos)})}};function V(r){return new B(r).tokenize()}var w=class{constructor(e){this.source=e;c(this,"tokens",[]);c(this,"pos",0);c(this,"errors",[]);c(this,"frontmatterContent","");c(this,"loopDepth",0)}parse(){this.tokens=V(this.source),this.pos=0,this.errors=[],this.loopDepth=0;let e=this.parseFrontmatter(),t=this.parseSections(),s=this.tokens.length>0?l(this.tokens[0].span,this.tokens[this.tokens.length-1].span):S(1,0,0,1,0,0);return{kind:"Document",frontmatter:e,sections:t,errors:this.errors,span:s}}parseFrontmatter(){if(!this.check("FRONTMATTER_START"))return null;let e=this.advance(),t="";for(;!this.check("FRONTMATTER_END")&&!this.isAtEnd();){let a=this.advance();a.type==="TEXT"&&(t+=a.value+`
`)}if(!this.check("FRONTMATTER_END"))return this.error("E013","Unclosed frontmatter"),null;let s=this.advance();this.frontmatterContent=t;let n=this.parseYaml(t);return{kind:"Frontmatter",name:n.name||"",description:n.description||"",uses:n.uses||[],imports:this.parseImports(n.imports),raw:n,span:l(e.span,s.span)}}parseYaml(e){let t={},s=e.split(`
`),n="",a=!1,i=!1,o=null;for(let h of s){let u=h.match(/^(\w+):\s*(.*)$/);if(u){n=u[1];let f=u[2].trim();f?(t[n]=f,a=!1,i=!1):(t[n]=[],a=!0,i=n==="imports");continue}if(i){let f=h.match(/^\s+-\s+path:\s*(.+)$/);if(f){o&&t[n].push(o),o={path:f[1].trim().replace(/^["']|["']$/g,"")};continue}let T=h.match(/^\s+skills:\s*\[([^\]]*)\]$/);if(T&&o){o.skills=T[1]?T[1].split(",").map(v=>v.trim().replace(/^["']|["']$/g,"")).filter(v=>v):[];continue}if(h.match(/^\s+alias:\s*$/)&&o){o.alias={};continue}let g=h.match(/^\s+([a-z-]+):\s*(.+)$/);if(g&&o&&o.alias!==void 0){o.alias[g[1]]=g[2].trim();continue}}let k=h.match(/^\s+-\s+(.+)$/);k&&a&&Array.isArray(t[n])&&!i&&t[n].push(k[1])}return i&&o&&t[n].push(o),t}parseImports(e){return!e||!Array.isArray(e)?[]:e.map(t=>({kind:"ImportDeclaration",path:t.path||"",skills:t.skills||[],aliases:new Map(Object.entries(t.alias||{})),span:S(1,0,0,1,0,0)}))}parseSections(){let e=[];for(;!this.isAtEnd();)if(this.skipNewlines(),this.check("HEADING"))e.push(this.parseSection());else if(!this.isAtEnd()){let t=this.parseBlocks();if(t.length>0){let s=t[0].span;e.push({kind:"Section",level:0,title:"",anchor:"",content:t,span:s})}}return e}parseSection(){let e=this.advance(),t=e.value.match(/^(#+)\s+(.+)$/);if(!t)return this.error("E015","Invalid heading format"),this.createErrorSection(e);let s=t[1].length,n=t[2],a=n.toLowerCase().replace(/\s+/g,"-").replace(/[^\w-]/g,"");this.skipNewlines();let i=this.parseBlocks(),o=i.length>0?l(e.span,i[i.length-1].span):e.span;return{kind:"Section",level:s,title:n,anchor:a,content:i,span:o}}createErrorSection(e){return{kind:"Section",level:1,title:"Error",anchor:"error",content:[],span:e.span}}parseBlocks(){let e=[];for(;!this.isAtEnd()&&!this.check("HEADING")&&(this.skipNewlines(),!(this.isAtEnd()||this.check("HEADING")));){let t=this.parseBlock();t&&e.push(t)}return e}parseBlock(){if(this.check("TYPE_IDENT")&&this.peek(1)?.type==="COLON"&&this.peek(2)?.type!=="TYPE_IDENT")return this.parseTypeDefinition();if(this.check("LIST_MARKER"))return this.parseListItem();if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT"))return this.parseVariableOrType();if(this.check("PARALLEL"))return this.parseParallelForEach();if(this.check("FOR"))return this.parseForEach();if(this.check("WHILE"))return this.parseWhile();if(this.check("IF"))return this.parseIf();if(this.check("BREAK"))return this.parseBreak();if(this.check("CONTINUE"))return this.parseContinue();if(this.check("CODE_BLOCK_START"))return this.parseCodeBlock();if(this.check("HORIZONTAL_RULE"))return this.parseHorizontalRule();if(this.check("BLOCKQUOTE"))return this.parseBlockquote();if(this.check("LOWER_IDENT")||this.check("UPPER_IDENT")){let e=this.current().value.toLowerCase();if((e==="execute"||e==="call"||e==="run"||e==="invoke"||e==="delegate"||e==="use")&&this.peek(1)?.type==="DOUBLE_LBRACKET")return this.parseDelegation()}return!this.isAtEnd()&&!this.check("HEADING")&&!this.check("NEWLINE")?this.parseParagraph():(this.isAtEnd()||this.advance(),null)}parseTypeDefinition(){let e=this.advance(),t=e.value.slice(1);this.expect("COLON");let s=this.parseTypeExpr();return{kind:"TypeDefinition",name:t,typeExpr:s,span:l(e.span,s.span)}}parseTypeExpr(){let e=this.current();if(this.check("STRING"))return this.parseEnumType();if(this.check("LPAREN"))return this.parseCompoundType();if(this.check("TYPE_IDENT")){let t=this.advance(),s={kind:"TypeReference",name:t.value.slice(1),span:t.span};return this.check("LBRACKET")?(this.advance(),this.expect("RBRACKET"),{kind:"ArrayType",elementType:s,span:l(t.span,this.previous().span)}):s}return this.parseSemanticTypeDefinition()}parseEnumType(){let e=[],t=this.current();for(;this.check("STRING");){let s=this.advance();if(e.push(s.value),this.check("PIPE"))this.advance();else break}return{kind:"EnumType",values:e,span:l(t.span,this.previous().span)}}parseCompoundType(){let e=this.advance(),t=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)t.push(this.parseTypeExpr()),this.check("COMMA")&&this.advance();let s=this.expect("RPAREN"),n={kind:"CompoundType",elements:t,span:l(e.span,s?.span||this.previous().span)};return this.check("LBRACKET")?(this.advance(),this.expect("RBRACKET"),{kind:"ArrayType",elementType:n,span:l(e.span,this.previous().span)}):n}parseSemanticTypeDefinition(){let e="",t=this.current();for(;!this.check("NEWLINE")&&!this.isAtEnd();){let s=this.advance();e&&(e+=" "),e+=s.value}return{kind:"SemanticType",description:e.trim(),span:l(t.span,this.previous().span)}}parseVariableOrType(){return this.check("TYPE_IDENT")&&this.peek(1)?.type==="COLON"&&this.peek(2)?.type!=="TYPE_IDENT"?this.parseTypeDefinition():this.parseVariableDeclaration()}parseVariableDeclaration(e=!1){let t=this.advance(),s=t.value.slice(1),n=null,a=!1;if(this.check("COLON")&&(this.advance(),this.check("TYPE_IDENT"))){let h=this.advance();n={kind:"TypeReference",name:h.value.slice(1),span:h.span}}let i=null,o=!1;return this.check("ASSIGN")?(this.advance(),this.check("DOLLAR_IDENT")||this.check("LPAREN")?this.findArrow()?(o=!0,i=this.parseLambdaExpression()):i=this.parseExpression():i=this.parseExpression()):e&&n&&(a=!0),{kind:"VariableDeclaration",name:s,typeAnnotation:n,value:i,isLambda:o,isRequired:a,span:l(t.span,i?.span||n?.span||t.span)}}findArrow(){let e=0,t=0;for(;e<10;){let s=this.peek(e);if(!s)return!1;if(s.type==="LPAREN"&&t++,s.type==="RPAREN"&&t--,s.type==="ARROW"&&t===0)return!0;if(s.type==="NEWLINE")return!1;e++}return!1}parseListItem(){return this.advance(),this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")?this.parseVariableDeclaration():this.check("PARALLEL")?this.parseParallelForEach():this.check("FOR")?this.parseForEach():this.check("WHILE")?this.parseWhile():this.check("IF")?this.parseIf():this.check("BREAK")?this.parseBreak():this.check("CONTINUE")?this.parseContinue():this.parseParagraph()}parseExpression(){return this.parseOr()}parseOr(){let e=this.parseAnd();for(;this.check("OR");){this.advance();let t=this.parseAnd();e={kind:"BinaryExpression",operator:"OR",left:e,right:t,span:l(e.span,t.span)}}return e}parseAnd(){let e=this.parseComparison();for(;this.check("AND");){this.advance();let t=this.parseComparison();e={kind:"BinaryExpression",operator:"AND",left:e,right:t,span:l(e.span,t.span)}}return e}parseComparison(){let e=this.parsePrimary(),t=["ASSIGN","NEQ","LT","GT","LTE","GTE"];for(;t.some(s=>this.check(s));){let s=this.advance(),n=this.tokenToOperator(s.type),a=this.parsePrimary();e={kind:"BinaryExpression",operator:n,left:e,right:a,span:l(e.span,a.span)}}return e}tokenToOperator(e){switch(e){case"ASSIGN":return"=";case"NEQ":return"!=";case"LT":return"<";case"GT":return">";case"LTE":return"<=";case"GTE":return">=";default:return"="}}parsePrimary(){let e=this.current();if((this.check("DOLLAR_IDENT")||this.check("LPAREN"))&&this.findArrow())return this.parseLambdaExpression();if(this.check("NOT")){let t=this.advance(),s=this.parsePrimary();return{kind:"UnaryExpression",operator:"NOT",operand:s,span:l(t.span,s.span)}}if(this.check("LPAREN")){this.advance();let t=this.parseExpression();return this.expect("RPAREN"),t}if(this.check("STRING")){let t=this.advance();return{kind:"StringLiteral",value:t.value,span:t.span}}if(this.check("NUMBER")){let t=this.advance();return{kind:"NumberLiteral",value:parseFloat(t.value),span:t.span}}if(this.check("TRUE"))return{kind:"BooleanLiteral",value:!0,span:this.advance().span};if(this.check("FALSE"))return{kind:"BooleanLiteral",value:!1,span:this.advance().span};if(this.check("LBRACKET"))return this.parseArrayLiteral();if(this.check("TEMPLATE_START"))return this.parseTemplateLiteral();if(this.check("DOUBLE_LBRACKET"))return this.parseReference();if(this.check("SEMANTIC_OPEN"))return this.parseSemanticMarker();if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT"))return this.parseVariableReference();if(this.check("LOWER_IDENT")||this.check("UPPER_IDENT")||this.check("TEXT"))return this.parseInlineText();if(!this.isAtEnd()){let t=this.advance();return this.error("E001",`Unexpected token: ${t.type}`),{kind:"InlineText",text:t.value,span:t.span}}return{kind:"InlineText",text:"",span:e?.span||S(1,0,0,1,0,0)}}parseLambdaExpression(){let e=this.current(),t=[];if(this.check("LPAREN")){for(this.advance();!this.check("RPAREN")&&!this.isAtEnd();)this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1)),this.check("COMMA")&&this.advance();this.expect("RPAREN")}else this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1));this.expect("ARROW");let s=this.parseExpression();return{kind:"LambdaExpression",params:t,body:s,span:l(e.span,s.span)}}parseArrayLiteral(){let e=this.advance(),t=[];for(;!this.check("RBRACKET")&&!this.isAtEnd();)t.push(this.parseExpression()),this.check("COMMA")&&this.advance();let s=this.expect("RBRACKET");return{kind:"ArrayLiteral",elements:t,span:l(e.span,s?.span||this.previous().span)}}parseTemplateLiteral(){let e=this.advance(),t=[];for(;!this.check("TEMPLATE_END")&&!this.isAtEnd();)if(this.check("TEMPLATE_PART"))t.push(this.advance().value);else if(this.check("DOLLAR_IDENT")){let n=this.advance();t.push({kind:"VariableReference",name:n.value.slice(1),span:n.span})}else this.check("SEMANTIC_OPEN")?t.push(this.parseSemanticMarker()):this.advance();let s=this.expect("TEMPLATE_END");return{kind:"TemplateLiteral",parts:t,span:l(e.span,s?.span||this.previous().span)}}parseReference(){let e=this.advance(),t=null,s=null;if(this.check("LOWER_IDENT")){let i=this.advance().value;i.startsWith("#")?s=i.slice(1):t=i}if(t&&this.check("LOWER_IDENT")){let i=this.advance().value;i.startsWith("#")&&(s=i.slice(1))}let n=this.expect("DOUBLE_RBRACKET"),a=l(e.span,n?.span||this.previous().span);return s!==null?{kind:"SectionReference",skill:t,section:s,span:a}:{kind:"SkillReference",skill:t||"",span:a}}parseSemanticMarker(){let e=this.advance(),t="",s=[];for(;!this.check("SEMANTIC_CLOSE")&&!this.isAtEnd();)if(this.check("SEMANTIC_CONTENT"))t+=this.advance().value;else if(this.check("DOLLAR_IDENT")){let a=this.advance();t+=a.value,s.push({kind:"VariableReference",name:a.value.slice(1),span:a.span})}else t+=this.advance().value;let n=this.expect("SEMANTIC_CLOSE");return{kind:"SemanticMarker",content:t,interpolations:s,span:l(e.span,n?.span||this.previous().span)}}parseVariableReference(){let e=this.advance(),s={kind:"VariableReference",name:e.value.slice(1),span:e.span};for(;this.check("DOT");)if(this.advance(),this.check("LOWER_IDENT")||this.check("UPPER_IDENT")){let n=this.advance();s={kind:"MemberAccess",object:s,property:n.value,span:l(e.span,n.span)}}if(this.check("LPAREN")){this.advance();let n=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)n.push(this.parseExpression()),this.check("COMMA")&&this.advance();let a=this.expect("RPAREN");s={kind:"FunctionCall",callee:s,args:n,span:l(e.span,a?.span||this.previous().span)}}return s}parseInlineText(){let e="",t=this.current();for(;!this.isAtEnd()&&!this.check("NEWLINE")&&!this.check("DOUBLE_LBRACKET")&&!this.check("SEMANTIC_OPEN")&&!this.check("DOLLAR_IDENT")&&!this.check("TYPE_IDENT");)e&&(e+=" "),e+=this.advance().value;return{kind:"InlineText",text:e.trim(),span:l(t.span,this.previous().span)}}parseForEach(){let e=this.advance();this.expect("EACH");let t=this.parsePattern();this.expect("IN");let s=this.parseExpression();this.expect("COLON"),this.skipNewlines(),this.loopDepth++;let n=this.parseIndentedBlocks();return this.loopDepth--,{kind:"ForEachStatement",pattern:t,collection:s,body:n,span:l(e.span,n.length>0?n[n.length-1].span:s.span)}}parseParallelForEach(){let e=this.advance();this.expect("FOR"),this.expect("EACH");let t=this.parsePattern();this.expect("IN");let s=this.parseExpression();this.expect("COLON"),this.skipNewlines(),this.loopDepth++;let n=this.parseIndentedBlocks();return this.loopDepth--,{kind:"ParallelForEachStatement",pattern:t,collection:s,body:n,mergeStrategy:"collect",span:l(e.span,n.length>0?n[n.length-1].span:s.span)}}parseWhile(){let e=this.advance(),t=this.parseCondition();this.expect("DO"),this.expect("COLON"),this.skipNewlines(),this.loopDepth++;let s=this.parseIndentedBlocks();return this.loopDepth--,{kind:"WhileStatement",condition:t,body:s,span:l(e.span,s.length>0?s[s.length-1].span:t.span)}}parseIf(){let e=this.advance(),t=this.parseCondition();this.expect("THEN"),this.expect("COLON"),this.skipNewlines();let s=this.parseIndentedBlocks(),n=null;return this.check("ELSE")&&(this.advance(),this.expect("COLON"),this.skipNewlines(),n=this.parseIndentedBlocks()),{kind:"IfStatement",condition:t,thenBody:s,elseBody:n,span:l(e.span,n?.length?n[n.length-1].span:s.length?s[s.length-1].span:t.span)}}parseBreak(){let e=this.advance();return this.loopDepth===0&&this.error("E016","BREAK can only be used inside a loop"),{kind:"BreakStatement",span:e.span}}parseContinue(){let e=this.advance();return this.loopDepth===0&&this.error("E017","CONTINUE can only be used inside a loop"),{kind:"ContinueStatement",span:e.span}}parsePattern(){if(this.check("LPAREN")){let e=this.advance(),t=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1)),this.check("COMMA")&&this.advance();let s=this.expect("RPAREN");return{kind:"DestructuringPattern",names:t,span:l(e.span,s?.span||this.previous().span)}}if(this.check("DOLLAR_IDENT")){let e=this.advance();return{kind:"SimplePattern",name:e.value.slice(1),span:e.span}}return this.error("E005","Expected pattern"),{kind:"SimplePattern",name:"",span:this.current().span}}parseCondition(){return this.parseOrCondition()}parseOrCondition(){let e=this.parseAndCondition();for(;this.check("OR");){this.advance();let t=this.parseAndCondition();e={kind:"CompoundCondition",operator:"OR",left:e,right:t,span:l(e.span,t.span)}}return e}parseAndCondition(){let e=this.parsePrimaryCondition();for(;this.check("AND");){this.advance();let t=this.parsePrimaryCondition();e={kind:"CompoundCondition",operator:"AND",left:e,right:t,span:l(e.span,t.span)}}return e}parsePrimaryCondition(){let e=this.check("NOT");if(e&&this.advance(),this.check("LPAREN")){this.advance();let n=this.parseCondition();return this.expect("RPAREN"),n}if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")){let n=this.parseVariableReference();if(this.check("ASSIGN")||this.check("NEQ")||this.check("LT")||this.check("GT")||this.check("LTE")||this.check("GTE")){let a=this.advance(),i=this.tokenToOperator(a.type),o=this.parsePrimary();return{kind:"DeterministicCondition",left:n,operator:i,right:o,span:l(n.span,o.span)}}return{kind:"SemanticCondition",text:"$"+n.name,negated:e,span:n.span}}let t="",s=this.current();for(;!this.isAtEnd()&&!this.check("RPAREN")&&!this.check("AND")&&!this.check("OR")&&!this.check("THEN")&&!this.check("DO")&&!this.check("COLON");)t&&(t+=" "),t+=this.advance().value;return{kind:"SemanticCondition",text:t.trim(),negated:e,span:l(s.span,this.previous().span)}}parseIndentedBlocks(){let e=[];for(this.check("INDENT")&&this.advance();!this.check("DEDENT")&&!this.isAtEnd()&&!this.check("HEADING")&&(this.skipNewlines(),!(this.check("DEDENT")||this.isAtEnd()||this.check("HEADING")));){let t=this.parseBlock();t&&e.push(t)}return this.check("DEDENT")&&this.advance(),e}parseParagraph(){let e=[],t=this.current();for(;!this.isAtEnd()&&!this.check("NEWLINE")&&!this.check("HEADING");)if(this.check("DOUBLE_LBRACKET"))e.push(this.parseReference());else if(this.check("SEMANTIC_OPEN"))e.push(this.parseSemanticMarker());else if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")){let s=this.advance();e.push({kind:"VariableReference",name:s.value.slice(1),span:s.span})}else{let s=this.parseInlineText();s.text&&e.push(s)}return this.check("NEWLINE")&&this.advance(),{kind:"Paragraph",content:e,span:l(t.span,this.previous().span)}}parseCodeBlock(){let e=this.advance(),s=e.value.match(/^```(\w*)$/)?.[1]||null,n="";this.check("CODE_BLOCK_CONTENT")&&(n=this.advance().value);let a=this.expect("CODE_BLOCK_END");return{kind:"CodeBlock",language:s,content:n,span:l(e.span,a?.span||this.previous().span)}}parseHorizontalRule(){return{kind:"HorizontalRule",span:this.advance().span}}parseDelegation(){let e=this.advance(),t=e.value,s=this.parseReference(),n=[];if(this.check("WITH"))for(this.advance(),this.expect("COLON"),this.skipNewlines();this.check("LIST_MARKER")&&!this.isAtEnd();){this.advance();let i=this.parseVariableDeclaration(!0);if(n.push(i),this.skipNewlines(),!this.check("LIST_MARKER")||this.check("HEADING"))break}let a=l(e.span,this.previous().span);return{kind:"Delegation",verb:t,target:s,parameters:n,span:a}}parseBlockquote(){let e=this.advance();return{kind:"Paragraph",content:[{kind:"InlineText",text:e.value.slice(1).trim(),span:e.span}],span:e.span}}isAtEnd(){return this.pos>=this.tokens.length||this.current().type==="EOF"}current(){return this.tokens[this.pos]||{type:"EOF",value:"",span:S(1,0,0,1,0,0)}}previous(){return this.tokens[this.pos-1]||this.current()}peek(e=0){let t=this.pos+e;return t<this.tokens.length?this.tokens[t]:null}advance(){return this.isAtEnd()||this.pos++,this.previous()}check(e){return this.current().type===e}expect(e){return this.check(e)?this.advance():(this.error("E001",`Expected ${e}, got ${this.current().type}`),null)}skipNewlines(){for(;this.check("NEWLINE");)this.advance()}error(e,t){this.errors.push({kind:"ParseError",code:e,message:t,recoverable:!0,span:this.current().span})}};function D(r){return new w(r).parse()}var ne=new Set(["String","Number","Boolean"]),_=class{constructor(e={},t){c(this,"options");c(this,"registry");c(this,"diagnostics",[]);c(this,"sourceMap",[]);c(this,"metadata");c(this,"dependencies");c(this,"definedTypes",new Set);c(this,"definedVariables",new Set);c(this,"declaredDeps",new Set);this.options={includeHeader:!1,generateSourceMap:!0,validateReferences:!0,validateTypes:!0,validateScope:!0,validateContracts:!0,...e},this.registry=t||null,this.metadata=this.createEmptyMetadata(),this.dependencies={nodes:[],edges:[],cycles:[]}}createEmptyMetadata(){return{name:"",description:"",uses:[],imports:[],types:[],variables:[],references:[],sections:[],parameters:[]}}compile(e){this.diagnostics=[],this.sourceMap=[],this.metadata=this.createEmptyMetadata(),this.dependencies={nodes:[],edges:[],cycles:[]},this.definedTypes.clear(),this.definedVariables.clear(),this.declaredDeps.clear();let t=D(e);for(let n of t.errors)this.diagnostics.push({severity:"error",code:n.code,message:n.message,span:n.span});this.extractMetadata(t),this.buildDependencyGraph(t),this.options.validateTypes&&this.validateTypes(t),this.options.validateScope&&this.validateScope(t),this.options.validateReferences&&this.validateReferences(),this.options.validateContracts&&this.validateContracts(t);let s=e;return this.options.includeHeader&&(s=`<!-- MDZ Validated: ${this.metadata.name||"unnamed"} -->
<!-- Errors: ${this.diagnostics.filter(a=>a.severity==="error").length}, Warnings: ${this.diagnostics.filter(a=>a.severity==="warning").length} -->

`+e),{output:s,diagnostics:this.diagnostics,metadata:this.metadata,sourceMap:this.sourceMap,dependencies:this.dependencies}}extractMetadata(e){if(e.frontmatter){this.metadata.name=e.frontmatter.name,this.metadata.description=e.frontmatter.description,this.metadata.uses=[...e.frontmatter.uses];for(let t of e.frontmatter.uses)this.declaredDeps.add(t);for(let t of e.frontmatter.imports){this.metadata.imports.push({path:t.path,skills:[...t.skills],aliases:new Map(t.aliases)});for(let s of t.skills)this.declaredDeps.add(s)}}for(let t of e.sections)t.title&&this.metadata.sections.push({title:t.title,anchor:t.anchor,level:t.level,span:t.span}),t.title==="Input"&&this.extractParameters(t.content),this.extractFromBlocks(t.content)}extractFromBlocks(e){for(let t of e)this.extractFromBlock(t)}extractFromBlock(e){switch(e.kind){case"TypeDefinition":this.extractTypeDefinition(e);break;case"VariableDeclaration":this.extractVariableDeclaration(e);break;case"ForEachStatement":case"ParallelForEachStatement":this.extractFromControlFlow(e);break;case"WhileStatement":this.extractFromBlocks(e.body);break;case"IfStatement":this.extractFromBlocks(e.thenBody),e.elseBody&&this.extractFromBlocks(e.elseBody);break;case"Paragraph":this.extractFromParagraph(e);break;case"Delegation":this.extractFromDelegation(e);break}}extractTypeDefinition(e){let t={name:e.name,definition:this.typeExprToString(e.typeExpr),span:e.span};this.metadata.types.push(t),this.definedTypes.add(e.name),this.sourceMap.push({source:e.span,type:"type-def",name:e.name})}typeExprToString(e){switch(e.kind){case"SemanticType":return e.description;case"EnumType":return e.values.map(t=>`"${t}"`).join(" | ");case"TypeReference":return`$${e.name}`;case"CompoundType":return"("+e.elements.map(t=>this.typeExprToString(t)).join(", ")+")";case"ArrayType":return this.typeExprToString(e.elementType)+"[]";case"FunctionType":return`(${e.params.join(", ")}) => ${this.typeExprToString(e.returnType)}`;default:return""}}extractVariableDeclaration(e){let t={name:e.name,type:e.typeAnnotation?.name||null,hasDefault:e.value!==null,isRequired:e.isRequired||!1,span:e.span};this.metadata.variables.push(t),this.definedVariables.add(e.name),this.sourceMap.push({source:e.span,type:"variable",name:e.name}),e.value&&this.extractFromExpression(e.value)}extractFromControlFlow(e){if(e.pattern.kind==="SimplePattern")this.definedVariables.add(e.pattern.name);else for(let t of e.pattern.names)this.definedVariables.add(t);this.sourceMap.push({source:e.span,type:"control-flow",name:e.kind}),this.extractFromExpression(e.collection),this.extractFromBlocks(e.body)}extractFromParagraph(e){for(let t of e.content)t.kind==="SkillReference"?this.extractSkillReference(t):t.kind==="SectionReference"?this.extractSectionReference(t):t.kind==="SemanticMarker"&&this.sourceMap.push({source:t.span,type:"semantic",name:t.content})}extractFromDelegation(e){e.target.kind==="SkillReference"?this.extractSkillReference(e.target):this.extractSectionReference(e.target);for(let t of e.parameters)this.extractVariableDeclaration(t)}extractParameters(e){for(let t of e)t.kind==="VariableDeclaration"&&this.metadata.parameters.push({name:t.name,type:t.typeAnnotation?.name||null,hasDefault:t.value!==null,isRequired:!t.value,span:t.span})}extractFromExpression(e){switch(e.kind){case"SkillReference":this.extractSkillReference(e);break;case"SectionReference":this.extractSectionReference(e);break;case"SemanticMarker":this.sourceMap.push({source:e.span,type:"semantic",name:e.content});break;case"BinaryExpression":this.extractFromExpression(e.left),this.extractFromExpression(e.right);break;case"UnaryExpression":this.extractFromExpression(e.operand);break;case"ArrayLiteral":for(let t of e.elements)this.extractFromExpression(t);break;case"FunctionCall":this.extractFromExpression(e.callee);for(let t of e.args)this.extractFromExpression(t);break;case"MemberAccess":this.extractFromExpression(e.object);break;case"LambdaExpression":this.extractFromExpression(e.body);break}}extractSkillReference(e){this.metadata.references.push({kind:"skill",target:e.skill,skill:e.skill,span:e.span}),this.sourceMap.push({source:e.span,type:"reference",name:e.skill})}extractSectionReference(e){this.metadata.references.push({kind:"section",target:e.skill?`${e.skill}#${e.section}`:`#${e.section}`,skill:e.skill||void 0,section:e.section,span:e.span}),this.sourceMap.push({source:e.span,type:"reference",name:e.skill?`${e.skill}#${e.section}`:`#${e.section}`})}buildDependencyGraph(e){let t=new Set,s=[];if(e.frontmatter)for(let n of e.frontmatter.uses)t.add(n),s.push({target:n,type:"uses"});for(let n of this.metadata.references)n.kind==="skill"&&n.skill?(t.add(n.skill),s.push({target:n.skill,type:"reference",span:n.span})):n.kind==="section"&&n.skill&&(t.add(n.skill),s.push({target:n.skill,type:"reference",span:n.span}));this.dependencies.nodes=Array.from(t),this.dependencies.edges=s}validateTypes(e){for(let t of this.metadata.variables)if(t.type&&!this.definedTypes.has(t.type)){if(ne.has(t.type))continue;this.diagnostics.push({severity:"warning",code:"E008",message:`Type '$${t.type}' is not defined in this document`,span:t.span})}}validateScope(e){let t=new Set;for(let s of e.sections)this.checkScopeInBlocks(s.content,t)}checkScopeInBlocks(e,t){for(let s of e)if(s.kind==="VariableDeclaration")this.definedVariables.add(s.name),s.value&&this.checkExpressionScope(s.value,t);else if(s.kind==="ForEachStatement"||s.kind==="ParallelForEachStatement"){if(this.checkExpressionScope(s.collection,t),s.pattern.kind==="SimplePattern")this.definedVariables.add(s.pattern.name);else for(let n of s.pattern.names)this.definedVariables.add(n);this.checkScopeInBlocks(s.body,t)}else if(s.kind==="WhileStatement")this.checkScopeInBlocks(s.body,t);else if(s.kind==="IfStatement")this.checkScopeInBlocks(s.thenBody,t),s.elseBody&&this.checkScopeInBlocks(s.elseBody,t);else if(s.kind==="Paragraph")for(let n of s.content)n.kind==="VariableReference"&&(this.definedVariables.has(n.name)||t.add(n.name))}checkExpressionScope(e,t){if(e.kind==="VariableReference")this.definedVariables.has(e.name)||t.add(e.name);else if(e.kind==="BinaryExpression")this.checkExpressionScope(e.left,t),this.checkExpressionScope(e.right,t);else if(e.kind==="UnaryExpression")this.checkExpressionScope(e.operand,t);else if(e.kind==="ArrayLiteral")for(let s of e.elements)this.checkExpressionScope(s,t)}validateReferences(){for(let e of this.metadata.references)e.kind==="skill"&&e.skill?this.declaredDeps.has(e.skill)||this.diagnostics.push({severity:"warning",code:"W001",message:`Skill '${e.skill}' is referenced but not declared in 'uses:'`,span:e.span}):e.kind==="section"&&e.skill&&(this.declaredDeps.has(e.skill)||this.diagnostics.push({severity:"warning",code:"W001",message:`Skill '${e.skill}' is referenced but not declared in 'uses:'`,span:e.span}));for(let e of this.metadata.references)e.kind==="section"&&!e.skill&&e.section&&(this.metadata.sections.some(s=>s.anchor===e.section)||this.diagnostics.push({severity:"error",code:"E010",message:`Section '#${e.section}' does not exist in this document`,span:e.span}));if(this.registry)for(let e of this.metadata.references)e.kind==="skill"&&e.skill&&(this.registry.get(e.skill)||this.diagnostics.push({severity:"error",code:"E009",message:`Skill '${e.skill}' is not found in registry`,span:e.span}))}validateContracts(e){let t=[];this.findDelegations(e.sections,t);for(let s of t)s.target.kind==="SkillReference"&&s.target.skill&&this.validateDelegationParameters(s)}findDelegations(e,t){for(let s of e)this.findDelegationsInBlocks(s.content,t)}findDelegationsInBlocks(e,t){for(let s of e)s.kind==="Delegation"?t.push(s):s.kind==="ForEachStatement"||s.kind==="ParallelForEachStatement"?this.findDelegationsInBlocks(s.body,t):s.kind==="WhileStatement"?this.findDelegationsInBlocks(s.body,t):s.kind==="IfStatement"&&(this.findDelegationsInBlocks(s.thenBody,t),s.elseBody&&this.findDelegationsInBlocks(s.elseBody,t))}validateDelegationParameters(e){let t=e.target.skill,s=[];if(t===this.metadata.name)s=this.metadata.parameters;else if(this.registry){let i=this.registry.get(t);i&&(s=M(i.source,{validateReferences:!1,validateContracts:!1}).metadata.parameters)}let n=new Set(e.parameters.map(i=>i.name)),a=s.filter(i=>i.isRequired);for(let i of a)n.has(i.name)||this.diagnostics.push({severity:"error",code:"E011",message:`Required parameter '${i.name}' is missing for skill '${t}'`,span:e.span});if(e.parameters.length>0)for(let i of e.parameters)s.find(h=>h.name===i.name)||this.diagnostics.push({severity:"warning",code:"W002",message:`Parameter '${i.name}' is not defined for skill '${t}'`,span:i.span})}};function M(r,e,t){return new _(e,t).compile(r)}var j=te(z());var O=class{constructor(){c(this,"documents",new Map);c(this,"skillRegistry",new Map)}openDocument(e,t){let s=this.analyzeDocument(e,t);return this.documents.set(e,s),this.getDiagnostics(s)}updateDocument(e,t){let s=this.analyzeDocument(e,t);return this.documents.set(e,s),this.getDiagnostics(s)}closeDocument(e){this.documents.delete(e)}analyzeDocument(e,t){let s=(0,j.parse)(t),n=new Map,a=new Map,i=[],o=[];for(let h of s.sections)this.analyzeBlocks(h.content,n,a,i,o);if(s.frontmatter?.name){let h={uri:e,content:t,ast:s,types:n,variables:a,references:i,semanticMarkers:o};this.skillRegistry.set(s.frontmatter.name,h)}return{uri:e,content:t,ast:s,types:n,variables:a,references:i,semanticMarkers:o}}analyzeBlocks(e,t,s,n,a){for(let i of e)switch(i.kind){case"TypeDefinition":t.set(i.name,{name:i.name,definition:this.typeExprToString(i.typeExpr),span:i.span});break;case"VariableDeclaration":s.set(i.name,{name:i.name,typeName:i.typeAnnotation?.name,span:i.span,isLambda:i.isLambda}),i.value&&this.analyzeExpression(i.value,n,a);break;case"ForEachStatement":if(i.pattern.kind==="SimplePattern")s.set(i.pattern.name,{name:i.pattern.name,span:i.pattern.span,isLambda:!1});else for(let o of i.pattern.names)s.set(o,{name:o,span:i.pattern.span,isLambda:!1});this.analyzeExpression(i.collection,n,a),this.analyzeBlocks(i.body,t,s,n,a);break;case"WhileStatement":this.analyzeCondition(i.condition,n,a),this.analyzeBlocks(i.body,t,s,n,a);break;case"IfStatement":this.analyzeCondition(i.condition,n,a),this.analyzeBlocks(i.thenBody,t,s,n,a),i.elseBody&&this.analyzeBlocks(i.elseBody,t,s,n,a);break;case"Paragraph":for(let o of i.content)o.kind==="SkillReference"?n.push({skill:o.skill,section:null,span:o.span}):o.kind==="SectionReference"?n.push({skill:o.skill,section:o.section,span:o.span}):o.kind==="SemanticMarker"&&a.push({content:o.content,span:o.span});break}}analyzeExpression(e,t,s){switch(e.kind){case"SkillReference":t.push({skill:e.skill,section:null,span:e.span});break;case"SectionReference":t.push({skill:e.skill,section:e.section,span:e.span});break;case"SemanticMarker":s.push({content:e.content,span:e.span});break;case"ArrayLiteral":for(let n of e.elements)this.analyzeExpression(n,t,s);break;case"TemplateLiteral":for(let n of e.parts)typeof n!="string"&&this.analyzeExpression(n,t,s);break;case"BinaryExpression":this.analyzeExpression(e.left,t,s),this.analyzeExpression(e.right,t,s);break;case"LambdaExpression":this.analyzeExpression(e.body,t,s);break;case"FunctionCall":this.analyzeExpression(e.callee,t,s);for(let n of e.args)this.analyzeExpression(n,t,s);break}}analyzeCondition(e,t,s){switch(e.kind){case"DeterministicCondition":this.analyzeExpression(e.left,t,s),this.analyzeExpression(e.right,t,s);break;case"CompoundCondition":this.analyzeCondition(e.left,t,s),this.analyzeCondition(e.right,t,s);break}}typeExprToString(e){switch(e.kind){case"SemanticType":return e.description;case"EnumType":return e.values.map(t=>`"${t}"`).join(" | ");case"TypeReference":return`$${e.name}`;case"CompoundType":return`(${e.elements.map(t=>this.typeExprToString(t)).join(", ")})`;case"ArrayType":return`${this.typeExprToString(e.elementType)}[]`;case"FunctionType":return`(${e.params.join(", ")}) => ${this.typeExprToString(e.returnType)}`;default:return""}}getDiagnostics(e){let t=[];for(let s of e.ast.errors)t.push({range:this.spanToRange(s.span),severity:1,message:s.message,source:"zen"});for(let s of e.references)s.skill&&!this.skillRegistry.has(s.skill)&&t.push({range:this.spanToRange(s.span),severity:3,message:`Skill '${s.skill}' not found in workspace`,source:"zen"});return t}getDefinition(e,t){let s=this.documents.get(e);if(!s)return null;for(let[n,a]of s.variables)if(this.positionInSpan(t,a.span))return{uri:e,range:this.spanToRange(a.span)};for(let[n,a]of s.types)if(this.positionInSpan(t,a.span))return{uri:e,range:this.spanToRange(a.span)};for(let n of s.references)if(this.positionInSpan(t,n.span)&&n.skill){let a=this.skillRegistry.get(n.skill);if(a){if(n.section){let i=a.ast.sections.find(o=>o.anchor===n.section);if(i)return{uri:a.uri,range:this.spanToRange(i.span)}}return{uri:a.uri,range:{start:{line:0,character:0},end:{line:0,character:0}}}}}return null}getHover(e,t){let s=this.documents.get(e);if(!s)return null;for(let[n,a]of s.types)if(this.positionInSpan(t,a.span))return{contents:`**Type** $${n}

${a.definition}`,range:this.spanToRange(a.span)};for(let[n,a]of s.variables)if(this.positionInSpan(t,a.span)){let i=`**Variable** $${n}`;if(a.typeName){let o=s.types.get(a.typeName);i+=`: $${a.typeName}`,o&&(i+=`

${o.definition}`)}return a.isLambda&&(i+=`

*Lambda function*`),{contents:i,range:this.spanToRange(a.span)}}for(let n of s.references)if(this.positionInSpan(t,n.span)){let i=`**Skill Reference** [[${n.skill?n.section?`${n.skill}#${n.section}`:n.skill:`#${n.section}`}]]`;if(n.skill){let o=this.skillRegistry.get(n.skill);o?.ast.frontmatter&&(i+=`

${o.ast.frontmatter.description}`)}return{contents:i,range:this.spanToRange(n.span)}}return null}getCompletions(e,t){let s=this.documents.get(e);if(!s)return[];let a=(s.content.split(`
`)[t.line]||"").substring(0,t.character);if(a.endsWith("[["))return this.getSkillCompletions();let i=a.match(/\[\[([a-z0-9-]*)$/);if(i){let h=i[1];return this.getSkillCompletions().filter(u=>u.label.toLowerCase().startsWith(h.toLowerCase()))}if(a.endsWith("$"))return[...this.getVariableCompletions(s),...this.getTypeCompletions(s)];let o=a.match(/\$([a-zA-Z0-9-]*)$/);if(o){let h=o[1];return[...this.getVariableCompletions(s),...this.getTypeCompletions(s)].filter(k=>k.label.toLowerCase().startsWith(h.toLowerCase()))}return a.endsWith("{~~")?this.getSemanticCompletions():/^\s*$/.test(a)?this.getKeywordCompletions():[]}getSkillCompletions(){let e=[];for(let[t,s]of this.skillRegistry)e.push({label:t,kind:9,detail:s.ast.frontmatter?.description,insertText:t+"]]"});return e}getVariableCompletions(e){let t=[];for(let[s,n]of e.variables)t.push({label:s,kind:n.isLambda?3:6,detail:n.typeName?`$${n.typeName}`:void 0});return t}getTypeCompletions(e){let t=[];for(let[n,a]of e.types)t.push({label:n,kind:7,detail:a.definition});let s=["FilePath","String","Number","Boolean"];for(let n of s)t.push({label:n,kind:7,detail:"Built-in type"});return t}getSemanticCompletions(){return[{label:"appropriate location",kind:15,insertText:"appropriate location}"},{label:"relevant context",kind:15,insertText:"relevant context}"},{label:"best approach for",kind:15,insertText:"best approach for }"},{label:"determine based on",kind:15,insertText:"determine based on }"}]}getKeywordCompletions(){return[{label:"FOR EACH",kind:14,insertText:`FOR EACH $item IN $items:
  - `},{label:"WHILE",kind:14,insertText:`WHILE ($condition):
  - `},{label:"IF",kind:14,insertText:`IF $condition THEN:
  - `},{label:"ELSE",kind:14,insertText:`ELSE:
  - `}]}getDocumentSymbols(e){let t=this.documents.get(e);if(!t)return[];let s=[];for(let n of t.ast.sections){let a=[];for(let i of n.content)i.kind==="TypeDefinition"?a.push({name:`$${i.name}`,kind:5,range:this.spanToRange(i.span),selectionRange:this.spanToRange(i.span)}):i.kind==="VariableDeclaration"&&a.push({name:`$${i.name}`,kind:i.isLambda?12:13,range:this.spanToRange(i.span),selectionRange:this.spanToRange(i.span)});s.push({name:n.title||"(untitled)",kind:3,range:this.spanToRange(n.span),selectionRange:this.spanToRange(n.span),children:a.length>0?a:void 0})}return s}spanToRange(e){return{start:{line:e.start.line-1,character:e.start.column},end:{line:e.end.line-1,character:e.end.column}}}positionInSpan(e,t){let s=e.line+1,n=e.character;return!(s<t.start.line||s>t.end.line||s===t.start.line&&n<t.start.column||s===t.end.line&&n>t.end.column)}};var N=new O;function Ne(r,e){try{let t=D(e);postMessage({type:"parse",id:r,result:t})}catch(t){postMessage({type:"error",id:r,error:t instanceof Error?t.message:String(t)})}}function De(r,e){try{let t=M(e),s={diagnostics:t.diagnostics.map(n=>({severity:n.severity,code:n.code,message:n.message,line:n.span.start.line,column:n.span.start.column,endLine:n.span.end.line,endColumn:n.span.end.column})),metadata:{name:t.metadata.name,description:t.metadata.description,uses:t.metadata.uses,types:t.metadata.types.map(n=>({name:n.name,definition:n.definition})),variables:t.metadata.variables.map(n=>({name:n.name,type:n.type})),references:t.metadata.references.map(n=>({kind:n.kind,target:n.target})),sections:t.metadata.sections.map(n=>({title:n.title,anchor:n.anchor,level:n.level}))},dependencies:{nodes:t.dependencies.nodes,edges:t.dependencies.edges.map(n=>({target:n.target,type:n.type}))}};postMessage({type:"validate",id:r,result:s})}catch(t){postMessage({type:"error",id:r,error:t instanceof Error?t.message:String(t)})}}function xe(r,e,t,s){try{N.updateDocument(e,t);let n=N.getCompletions(e,s);postMessage({type:"completions",id:r,result:n})}catch(n){postMessage({type:"error",id:r,error:n instanceof Error?n.message:String(n)})}}function Ce(r,e,t,s){try{N.updateDocument(e,t);let n=N.getHover(e,s);postMessage({type:"hover",id:r,result:n})}catch(n){postMessage({type:"error",id:r,error:n instanceof Error?n.message:String(n)})}}function Le(r,e,t){try{let s=N.updateDocument(e,t);postMessage({type:"diagnostics",id:r,result:s})}catch(s){postMessage({type:"error",id:r,error:s instanceof Error?s.message:String(s)})}}self.addEventListener("message",r=>{let e=r.data;switch(e.type){case"parse":Ne(e.id,e.source);break;case"validate":De(e.id,e.source);break;case"completions":xe(e.id,e.uri,e.source,e.position);break;case"hover":Ce(e.id,e.uri,e.source,e.position);break;case"diagnostics":Le(e.id,e.uri,e.source);break;default:postMessage({type:"error",id:e.id||0,error:`Unknown message type: ${e.type}`})}});postMessage({type:"ready"});})();
//# sourceMappingURL=zen-worker.min.js.map
