"use strict";(()=>{var Ae=Object.defineProperty;var ve=(d,e,t)=>e in d?Ae(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var g=(d,e,t)=>ve(d,typeof e!="symbol"?e+"":e,t);function v(d,e,t,n,s,a){return{start:{line:d,column:e,offset:t},end:{line:n,column:s,offset:a}}}function T(d,e){return{start:d.start.offset<e.start.offset?d.start:e.start,end:d.end.offset>e.end.offset?d.end:e.end}}function K(d){return d.kind==="Link"}function J(d){return d.kind==="Anchor"}function ee(d){let e=d.path[0];return e==="agent"||e==="agents"?"agent":e==="skill"||e==="skills"?"skill":e==="tool"||e==="tools"?"tool":"unknown"}var te=class{constructor(e){g(this,"source");g(this,"pos",0);g(this,"line",1);g(this,"column",0);g(this,"tokens",[]);g(this,"lineStartColumn",-1);g(this,"inCodeBlock",!1);g(this,"inFrontmatter",!1);g(this,"isCurrentLineMdz",!1);this.source=e}tokenize(){for(;!this.isAtEnd();)this.scanToken();return this.addToken("EOF",""),this.tokens}scanToken(){if(this.column===0){if(this.lineStartColumn=-1,this.line===1&&this.lookAhead(`---
`)){this.consumeChars(3),this.addToken("FRONTMATTER_START","---"),this.consumeNewline(),this.inFrontmatter=!0,this.scanFrontmatter();return}if(this.lookAhead(`---
`)||this.lookAhead("---")&&this.pos+3>=this.source.length){this.consumeChars(3),this.addToken("HORIZONTAL_RULE","---"),this.isAtEnd()||this.consumeNewline();return}if(this.lookAhead("```")){this.scanCodeBlock();return}if(this.peek()===">"){this.scanBlockquote();return}}if(this.lineStartColumn===-1)if(this.peek()===" "||this.peek()==="	"){this.advance();return}else this.lineStartColumn=this.column;let e=this.peek();if(e===" "||e==="	"){this.advance();return}if(e===`
`){this.lineStartColumn=-1,this.isCurrentLineMdz=!1,this.consumeNewline();return}if(e==="\r"){this.advance();return}if(this.column===0&&e==="#"){let n=0;for(;this.peekAt(n)==="#";)n+=1;if(this.peekAt(n)===" "){this.scanHeading();return}}if(this.lookAhead("->")||this.lookAhead("=>")){let n=this.lookAhead("->")?"->":"=>";this.consumeChars(2),this.addToken("ARROW",n);return}if(this.lookAhead("!=")){this.consumeChars(2),this.addToken("NEQ","!=");return}if(this.lookAhead("<=")){this.consumeChars(2),this.addToken("LTE","<=");return}if(this.lookAhead(">=")){this.consumeChars(2),this.addToken("GTE",">=");return}if(this.lookAhead("<<")){this.consumeChars(2),this.addToken("PUSH","<<");return}let t={"=":"ASSIGN",":":"COLON","|":"PIPE",".":"DOT",",":"COMMA",";":"SEMICOLON","<":"LT",">":"GT","(":"LPAREN",")":"RPAREN","[":"LBRACKET","]":"RBRACKET","{":"LBRACE","}":"RBRACE"};if(t[e]){this.advance(),this.addToken(t[e],e);return}if(e==="$"){this.scanDollarIdent();return}if(!(this.lookAhead("~/")&&this.scanLink())&&!(e==="#"&&this.scanAnchor())){if(e==='"'){this.scanString();return}if(e==="`"){this.scanTemplate();return}if(this.isDigit(e)||e==="-"&&this.isDigit(this.peekAt(1))){this.scanNumber();return}if(this.isAlpha(e)){this.scanIdentOrKeyword();return}this.advance(),this.addToken("TEXT",e)}}scanFrontmatter(){for(;!this.isAtEnd();){if(this.column===0&&this.lookAhead("---")){this.consumeChars(3),this.addToken("FRONTMATTER_END","---"),this.inFrontmatter=!1,!this.isAtEnd()&&this.peek()===`
`&&this.consumeNewline();return}let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();e&&this.addToken("TEXT",e),this.isAtEnd()||this.consumeNewline()}}scanHeading(){let e=0;for(;this.peek()==="#";)e++,this.advance();this.peek()===" "&&this.advance();let t="";for(;!this.isAtEnd()&&this.peek()!==`
`;)t+=this.advance();this.addToken("HEADING","#".repeat(e)+" "+t),this.isAtEnd()||this.consumeNewline()}scanCodeBlock(){this.consumeChars(3);let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();this.addToken("CODE_BLOCK_START","```"+e),this.inCodeBlock=!0,this.isAtEnd()||this.consumeNewlineRaw();let t="";for(;!this.isAtEnd();){if(this.column===0&&this.lookAhead("```")){t&&this.addToken("CODE_BLOCK_CONTENT",t),this.consumeChars(3),this.addToken("CODE_BLOCK_END","```"),this.inCodeBlock=!1,!this.isAtEnd()&&this.peek()===`
`&&this.consumeNewlineRaw();return}this.peek()===`
`?(t+=`
`,this.consumeNewlineRaw()):t+=this.advance()}t&&this.addToken("CODE_BLOCK_CONTENT",t)}scanBlockquote(){this.advance();let e="";for(;!this.isAtEnd()&&this.peek()!==`
`;)e+=this.advance();this.addToken("BLOCKQUOTE",">"+e),this.isAtEnd()||this.consumeNewline()}scanLink(){let e=this.pos,t=this.column,n=this.line;this.consumeChars(2);let s=[],a=this.scanLinkSegment();if(!a)return this.pos=e,this.column=t,this.line=n,!1;for(s.push(a);this.peek()==="/"&&this.peekAt(1)!=="\0";){let r=this.peekAt(1);if(!this.isAlpha(r)&&r!=="_"||(this.advance(),a=this.scanLinkSegment(),!a))break;s.push(a)}let i=null;if(this.peek()==="#"&&(this.advance(),i=this.scanLinkSegment(),!i))return this.pos=e,this.column=t,this.line=n,!1;let p=JSON.stringify({path:s,anchor:i}),c=this.pos-e;return this.addToken("LINK",p,c),!0}scanAnchor(){let e=this.pos,t=this.column,n=this.line;this.advance();let s=this.scanLinkSegment();return s?(this.addToken("ANCHOR",s,this.pos-e),!0):(this.pos=e,this.column=t,this.line=n,!1)}scanLinkSegment(){let e="";if(!this.isAlpha(this.peek())&&this.peek()!=="_")return"";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-"||this.peek()==="_";)e+=this.advance();return e}scanDollarIdent(){if(this.column===this.lineStartColumn&&!this.inCodeBlock&&!this.inFrontmatter&&(this.isCurrentLineMdz=!0),this.advance(),this.peek()==="/"){this.advance();let s="";for(;!this.isAtEnd()&&this.peek()!=="/"&&this.peek()!==`
`;)s+=this.advance();if(this.peek()==="/"){this.advance(),this.addToken("INFERRED_VAR","$/"+s+"/");return}this.addToken("ERROR","$/"+s);return}let t="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)t+=this.advance();if(!t){this.addToken("ERROR","$");return}let n=t[0]>="A"&&t[0]<="Z"?"TYPE_IDENT":"DOLLAR_IDENT";this.addToken(n,"$"+t)}scanString(){this.advance();let e="";for(;!this.isAtEnd()&&this.peek()!=='"'&&this.peek()!==`
`;)if(this.peek()==="\\"){this.advance();let t=this.advance();switch(t){case"n":e+=`
`;break;case"t":e+="	";break;case'"':e+='"';break;case"\\":e+="\\";break;default:e+=t}}else e+=this.advance();this.peek()==='"'?(this.advance(),this.addToken("STRING",e)):this.addToken("ERROR",'"'+e)}scanTemplate(){this.advance(),this.addToken("TEMPLATE_START","`");let e="";for(;!this.isAtEnd()&&this.peek()!=="`";)if(this.lookAhead("\\`"))e+="`",this.consumeChars(2);else if(this.lookAhead("\\${"))e+="${",this.consumeChars(3);else if(this.lookAhead("${")){e&&(this.addToken("TEMPLATE_PART",e),e=""),this.consumeChars(2);let t="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)t+=this.advance();t&&this.peek()==="}"?(this.advance(),this.addToken("DOLLAR_IDENT","$"+t)):this.addToken("ERROR","${"+t)}else if(this.lookAhead("$/")){e&&(this.addToken("TEMPLATE_PART",e),e=""),this.advance(),this.advance();let t="";for(;!this.isAtEnd()&&this.peek()!=="/"&&this.peek()!==`
`&&this.peek()!=="`";)t+=this.advance();this.peek()==="/"?(this.advance(),this.addToken("INFERRED_VAR","$/"+t+"/")):this.addToken("ERROR","$/"+t)}else e+=this.advance();e&&this.addToken("TEMPLATE_PART",e),this.peek()==="`"&&(this.advance(),this.addToken("TEMPLATE_END","`"))}scanNumber(){let e="";for(this.peek()==="-"&&(e+=this.advance());this.isDigit(this.peek());)e+=this.advance();if(this.peek()==="."&&this.isDigit(this.peekAt(1)))for(e+=this.advance();this.isDigit(this.peek());)e+=this.advance();this.addToken("NUMBER",e)}scanIdentOrKeyword(){let e="";for(;this.isAlphaNumeric(this.peek())||this.peek()==="-";)e+=this.advance();let n={FOR:"FOR",IN:"IN",WHILE:"WHILE",DO:"DO",IF:"IF",THEN:"THEN",ELSE:"ELSE",END:"END",AND:"AND",OR:"OR",NOT:"NOT",WITH:"WITH",BREAK:"BREAK",CONTINUE:"CONTINUE",DELEGATE:"DELEGATE",TO:"TO",RETURN:"RETURN",ASYNC:"ASYNC",AWAIT:"AWAIT",USE:"USE",EXECUTE:"EXECUTE",GOTO:"GOTO",true:"TRUE",false:"FALSE"}[e],s=["FOR","WHILE","DO","IF","ELSE","END","BREAK","CONTINUE","RETURN","DELEGATE","USE","EXECUTE","GOTO","ASYNC","AWAIT"].includes(e),a=["IN","THEN","WITH","TO","AND","OR","NOT","true","false","IF","DELEGATE","DO","ELSE"].includes(e),p=this.column-e.length===this.lineStartColumn&&!this.inCodeBlock&&!this.inFrontmatter;n?p||this.isCurrentLineMdz&&a?(s&&p&&(this.isCurrentLineMdz=!0),this.addToken(n,e)):e[0]>="A"&&e[0]<="Z"?this.addToken("UPPER_IDENT",e):this.addToken("LOWER_IDENT",e):e[0]>="A"&&e[0]<="Z"?this.addToken("UPPER_IDENT",e):this.addToken("LOWER_IDENT",e)}isAtEnd(){return this.pos>=this.source.length}peek(){return this.isAtEnd()?"\0":this.source[this.pos]}peekAt(e){return this.pos+e>=this.source.length?"\0":this.source[this.pos+e]}advance(){let e=this.source[this.pos++];return this.column++,e}lookAhead(e){return this.source.slice(this.pos,this.pos+e.length)===e}consumeChars(e){for(let t=0;t<e;t++)this.advance()}consumeNewline(){this.peek()===`
`&&(this.pos++,this.line++,this.column=0,this.addToken("NEWLINE",`
`))}consumeNewlineRaw(){this.peek()===`
`&&(this.pos++,this.line++,this.column=0,this.lineStartColumn=-1,this.isCurrentLineMdz=!1)}isDigit(e){return e>="0"&&e<="9"}isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e==="_"}isAlphaNumeric(e){return this.isAlpha(e)||this.isDigit(e)}addToken(e,t,n=t.length){let s=n;this.tokens.push({type:e,value:t,span:v(this.line,this.column-s,this.pos-s,this.line,this.column,this.pos)})}};function ue(d){return new te(d).tokenize()}var ne=class{constructor(e){this.source=e;g(this,"tokens",[]);g(this,"pos",0);g(this,"errors",[]);g(this,"frontmatterContent","");g(this,"loopDepth",0);g(this,"blockDepth",0)}parse(){this.tokens=ue(this.source),this.pos=0,this.errors=[],this.loopDepth=0,this.blockDepth=0;let e=this.parseFrontmatter(),t=this.parseSections(),n=this.tokens.length>0?T(this.tokens[0].span,this.tokens[this.tokens.length-1].span):v(1,0,0,1,0,0);return{kind:"Document",frontmatter:e,sections:t,errors:this.errors,span:n}}parseFrontmatter(){if(!this.check("FRONTMATTER_START"))return null;let e=this.advance(),t="";for(;!this.check("FRONTMATTER_END")&&!this.isAtEnd();){let r=this.advance();r.type==="TEXT"&&(t+=r.value+`
`)}if(!this.check("FRONTMATTER_END"))return this.error("E013","Unclosed frontmatter"),null;let n=this.advance();this.frontmatterContent=t;let s=this.parseYaml(t),{skills:a,agents:i,tools:p,uses:c}=this.parseUsesField(s);return{kind:"Frontmatter",name:s.name||"",description:s.description||"",types:this.parseFrontmatterTypes(s.types),input:this.parseFrontmatterInput(s.input),context:this.parseFrontmatterContext(s.context),skills:a,agents:i,tools:p,uses:c,imports:this.parseImports(s.imports),raw:s,span:T(e.span,n.span)}}parseUsesField(e){let t=[],n=[],s=[],a=[],i=Array.isArray(e.skills)&&e.skills.length>0,p=Array.isArray(e.agents)&&e.agents.length>0,c=Array.isArray(e.tools)&&e.tools.length>0;if(i)for(let r of e.skills)t.push(r),a.push(`~${r}`);if(p)for(let r of e.agents)n.push(r),a.push(`@${r}`);if(c)for(let r of e.tools)s.push(r),a.push(`!${r}`);if(Array.isArray(e.uses)){for(let r of e.uses)if(typeof r=="string")if(r.startsWith("~/")){let l=r.slice(2).split("/"),u=l[0],E=l.slice(1).join("/");u==="agent"?n.includes(E)||(n.push(E),a.push(r)):u==="skill"?t.includes(E)||(t.push(E),a.push(r)):u==="tool"&&(s.includes(E)||(s.push(E),a.push(r)))}else if(r.startsWith("~")){let l=r.slice(1);t.includes(l)||(t.push(l),a.push(r))}else if(r.startsWith("@")){let l=r.slice(1);n.includes(l)||(n.push(l),a.push(r))}else if(r.startsWith("!")){let l=r.slice(1);s.includes(l)||(s.push(l),a.push(r))}else!i&&!t.includes(r)&&(t.push(r),a.push(r))}return{skills:t,agents:n,tools:s,uses:a}}parseYaml(e){let t={},n=e.split(`
`),s="",a=!1,i=!1,p=!1,c=null;for(let r of n){let l=r.match(/^(\w+):\s*(.*)$/);if(l){s=l[1];let E=l[2].trim();E?(t[s]=E,a=!1,i=!1,p=!1):(s==="types"||s==="input"||s==="context"?(t[s]={},p=!0,a=!1):(t[s]=[],a=!0),i=s==="imports");continue}if(p&&s){let E=r.match(/^\s+(\$?\w+):\s*(.*)$/);if(E){t[s][E[1]]=E[2].trim();continue}}if(i){let E=r.match(/^\s+-\s+path:\s*(.+)$/);if(E){c&&t[s].push(c),c={path:E[1].trim().replace(/^["']|["']$/g,"")};continue}let b=r.match(/^\s+skills:\s*\[([^\]]*)\]$/);if(b&&c){c.skills=b[1]?b[1].split(",").map(S=>S.trim().replace(/^["']|["']$/g,"")).filter(S=>S):[];continue}if(r.match(/^\s+alias:\s*$/)&&c){c.alias={};continue}let I=r.match(/^\s+([a-z-]+):\s*(.+)$/);if(I&&c&&c.alias!==void 0){c.alias[I[1]]=I[2].trim();continue}}let u=r.match(/^\s+-\s+(.+)$/);u&&a&&Array.isArray(t[s])&&!i&&t[s].push(u[1])}return i&&c&&t[s].push(c),t}parseImports(e){return!e||!Array.isArray(e)?[]:e.map(t=>({kind:"ImportDeclaration",path:t.path||"",skills:t.skills||[],aliases:new Map(Object.entries(t.alias||{})),span:v(1,0,0,1,0,0)}))}parseFrontmatterTypes(e){return!e||typeof e!="object"?[]:Object.entries(e).map(([t,n])=>({kind:"FrontmatterTypeDecl",name:t.replace(/^\$/,""),typeExpr:this.parseTypeExprFromString(String(n)),span:v(1,0,0,1,0,0)}))}parseFrontmatterInput(e){return!e||typeof e!="object"?[]:Object.entries(e).map(([t,n])=>{let s=String(n),a=s.includes("="),[i,p]=a?s.split("=").map(c=>c.trim()):[s.trim(),void 0];return{kind:"FrontmatterInputDecl",name:t.replace(/^\$/,""),type:i?this.parseTypeExprFromString(i):void 0,defaultValue:p?this.parseValueFromString(p):void 0,required:!a,span:v(1,0,0,1,0,0)}})}parseFrontmatterContext(e){return!e||typeof e!="object"?[]:Object.entries(e).map(([t,n])=>{let s=String(n),a=s.includes("="),[i,p]=a?s.split("=").map(c=>c.trim()):[s.trim(),void 0];return{kind:"FrontmatterContextDecl",name:t.replace(/^\$/,""),type:i?this.parseTypeExprFromString(i):void 0,initialValue:p?this.parseValueFromString(p):void 0,span:v(1,0,0,1,0,0)}})}parseTypeExprFromString(e){let t=e.replace(/^\$/,"").replace(/\[\]$/,""),n=e.endsWith("[]"),s={kind:"TypeReference",name:t,span:v(1,0,0,1,0,0)};return n?{kind:"ArrayType",elementType:s,span:s.span}:s}parseValueFromString(e){return e.startsWith('"')&&e.endsWith('"')?{kind:"StringLiteral",value:e.slice(1,-1),span:v(1,0,0,1,0,0)}:isNaN(Number(e))?e==="true"||e==="false"?{kind:"BooleanLiteral",value:e==="true",span:v(1,0,0,1,0,0)}:e==="[]"?{kind:"ArrayLiteral",elements:[],span:v(1,0,0,1,0,0)}:{kind:"InlineText",text:e,span:v(1,0,0,1,0,0)}:{kind:"NumberLiteral",value:Number(e),span:v(1,0,0,1,0,0)}}parseSections(){let e=[];for(;!this.isAtEnd();)if(this.skipNewlines(),this.check("HEADING"))e.push(this.parseSection());else if(!this.isAtEnd()){let t=this.parseBlocks();if(t.length>0){let n=t[0].span;e.push({kind:"Section",level:0,title:"",anchor:"",content:t,span:n})}}return e}parseSection(){let e=this.advance(),t=e.value.match(/^(#+)\s+(.+)$/);if(!t)return this.error("E015","Invalid heading format"),this.createErrorSection(e);let n=t[1].length,s=t[2],a=s.toLowerCase().replace(/\s+/g,"-").replace(/[^\w-]/g,"");this.skipNewlines();let i=this.parseBlocks(),p=i.length>0?T(e.span,i[i.length-1].span):e.span;return{kind:"Section",level:n,title:s,anchor:a,content:i,span:p}}createErrorSection(e){return{kind:"Section",level:1,title:"Error",anchor:"error",content:[],span:e.span}}parseBlocks(){let e=[];for(;!this.isAtEnd()&&!this.check("HEADING")&&(this.skipNewlines(),!(this.isAtEnd()||this.check("HEADING")));){let t=this.parseBlock();t&&e.push(t)}return e}parseBlock(){if(this.check("END"))return this.error("E001","Unexpected END"),this.advance(),null;if(this.check("ELSE"))return this.error("E001","Unexpected ELSE"),this.advance(),null;if(this.check("TYPE_IDENT")&&this.peek(1)?.type==="COLON"&&this.peek(2)?.type!=="TYPE_IDENT")return this.parseTypeDefinition();if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")){let e=1;for(;this.peek(e)&&this.peek(e).type!=="NEWLINE"&&this.peek(e).type!=="EOF";){if(this.peek(e).type==="PUSH")return this.parsePushStatement();if(["ASSIGN","FOR","IF","WHILE","DELEGATE"].includes(this.peek(e).type))break;e++}return this.parseVariableOrType()}if(this.check("FOR"))return this.parseFor();if(this.check("WHILE"))return this.parseWhile();if(this.check("IF"))return this.parseIf();if(this.check("BREAK"))return this.parseBreak();if(this.check("CONTINUE"))return this.parseContinue();if(this.check("RETURN"))return this.parseReturnStatement();if(this.check("ASYNC")||this.check("AWAIT"))return this.parseDelegateStatement();if(this.check("DO"))return this.parseDoStatement();if(this.check("DELEGATE"))return this.parseDelegateStatement();if(this.check("CODE_BLOCK_START"))return this.parseCodeBlock();if(this.check("HORIZONTAL_RULE"))return this.parseHorizontalRule();if(this.check("BLOCKQUOTE"))return this.parseBlockquote();if(this.check("USE"))return this.parseUseStatement();if(this.check("EXECUTE"))return this.parseExecuteStatement();if(this.check("GOTO"))return this.parseGotoStatement();if(this.check("LOWER_IDENT")||this.check("UPPER_IDENT")){let e=this.current().value.toLowerCase();if(e==="call"||e==="run"||e==="invoke"){let t=this.peek(1),n=this.peek(2),s=a=>a?.type==="LINK"||a?.type==="ANCHOR";if(s(t)||t?.type==="LOWER_IDENT"&&t.value==="to"&&s(n))return this.parseDelegation()}}return!this.isAtEnd()&&!this.check("HEADING")&&!this.check("NEWLINE")?this.parseParagraph():(this.isAtEnd()||this.advance(),null)}parseTypeDefinition(){let e=this.advance(),t=e.value.slice(1);this.expect("COLON");let n=this.parseTypeExpr();return{kind:"TypeDefinition",name:t,typeExpr:n,span:T(e.span,n.span)}}parseTypeExpr(){let e=this.current();if(this.check("STRING"))return this.parseEnumType();if(this.check("LPAREN"))return this.parseCompoundType();if(this.check("TYPE_IDENT")){let t=this.advance(),n={kind:"TypeReference",name:t.value.slice(1),span:t.span};return this.check("LBRACKET")?(this.advance(),this.expect("RBRACKET"),{kind:"ArrayType",elementType:n,span:T(t.span,this.previous().span)}):n}return this.parseSemanticTypeDefinition()}parseEnumType(){let e=[],t=this.current();for(;this.check("STRING");){let n=this.advance();if(e.push(n.value),this.check("PIPE"))this.advance();else break}return{kind:"EnumType",values:e,span:T(t.span,this.previous().span)}}parseCompoundType(){let e=this.advance(),t=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)t.push(this.parseTypeExpr()),this.check("COMMA")&&this.advance();let n=this.expect("RPAREN"),s={kind:"CompoundType",elements:t,span:T(e.span,n?.span||this.previous().span)};return this.check("LBRACKET")?(this.advance(),this.expect("RBRACKET"),{kind:"ArrayType",elementType:s,span:T(e.span,this.previous().span)}):s}parseSemanticTypeDefinition(){let e="",t=this.current();for(;!this.check("NEWLINE")&&!this.isAtEnd();){let n=this.advance();e&&(e+=" "),e+=n.value}return{kind:"SemanticType",description:e.trim(),span:T(t.span,this.previous().span)}}parseSemanticText(e){let t=this.current(),n=[],s=null;for(;!this.isAtEnd()&&!e.includes(this.current().type);){let i=this.advance();s=i,i.type==="DOLLAR_IDENT"&&n.push({kind:"VariableReference",name:i.value.slice(1),span:i.span})}return s?{content:this.source.slice(t.span.start.offset,s.span.end.offset).trim(),span:T(t.span,s.span),interpolations:n}:{content:"",span:t.span,interpolations:[]}}parseSemanticSpan(e){let{content:t,span:n,interpolations:s}=this.parseSemanticText(e);return{kind:"SemanticMarker",content:t,interpolations:s,span:n}}parseSemanticTypeAnnotation(e){let{content:t,span:n}=this.parseSemanticText(e);return{kind:"SemanticType",description:t,span:n}}parseVariableOrType(){return this.check("TYPE_IDENT")&&this.peek(1)?.type==="COLON"&&this.peek(2)?.type!=="TYPE_IDENT"?this.parseTypeDefinition():this.parseVariableDeclaration()}parseVariableDeclaration(e=!1){let t=this.advance(),n=t.value.slice(1),s=null,a=!1;if(this.check("COLON"))if(this.advance(),this.check("TYPE_IDENT")){let c=this.advance();s={kind:"TypeReference",name:c.value.slice(1),span:c.span}}else s=this.parseSemanticTypeAnnotation(["ASSIGN","NEWLINE","END","ELSE"]),s.description.trim()===""&&this.error("E020","Malformed type annotation: expected type name or description");let i=null,p=!1;return this.check("ASSIGN")?(this.advance(),this.check("DOLLAR_IDENT")||this.check("LPAREN")?this.findArrow()?(p=!0,i=this.parseLambdaExpression()):i=this.parseExpression():i=this.parseExpression()):e&&s&&(a=!0),{kind:"VariableDeclaration",name:n,typeAnnotation:s,value:i,isLambda:p,isRequired:a,span:T(t.span,i?.span||s?.span||t.span)}}findArrow(){let e=0,t=0;for(;e<10;){let n=this.peek(e);if(!n)return!1;if(n.type==="LPAREN"&&t++,n.type==="RPAREN"&&t--,n.type==="ARROW"&&t===0)return!0;if(n.type==="NEWLINE")return!1;e++}return!1}parseExpression(){return this.parseOr()}parseOr(){let e=this.parseAnd();for(;this.check("OR");){this.advance();let t=this.parseAnd();e={kind:"BinaryExpression",operator:"OR",left:e,right:t,span:T(e.span,t.span)}}return e}parseAnd(){let e=this.parseComparison();for(;this.check("AND");){this.advance();let t=this.parseComparison();e={kind:"BinaryExpression",operator:"AND",left:e,right:t,span:T(e.span,t.span)}}return e}parseComparison(){let e=this.parsePrimary(),t=["ASSIGN","NEQ","LT","GT","LTE","GTE"];for(;t.some(n=>this.check(n));){let n=this.advance(),s=this.tokenToOperator(n.type),a=this.parsePrimary();e={kind:"BinaryExpression",operator:s,left:e,right:a,span:T(e.span,a.span)}}return e}tokenToOperator(e){switch(e){case"ASSIGN":return"=";case"NEQ":return"!=";case"LT":return"<";case"GT":return">";case"LTE":return"<=";case"GTE":return">=";default:return"="}}parsePrimary(){let e=this.current();if((this.check("DOLLAR_IDENT")||this.check("LPAREN"))&&this.findArrow())return this.parseLambdaExpression();if(this.check("NOT")){let t=this.advance(),n=this.parsePrimary();return{kind:"UnaryExpression",operator:"NOT",operand:n,span:T(t.span,n.span)}}if(this.check("LPAREN")){this.advance();let t=this.parseExpression();return this.expect("RPAREN"),t}if(this.check("STRING")){let t=this.advance();return{kind:"StringLiteral",value:t.value,span:t.span}}if(this.check("NUMBER")){let t=this.advance();return{kind:"NumberLiteral",value:parseFloat(t.value),span:t.span}}if(this.check("TRUE"))return{kind:"BooleanLiteral",value:!0,span:this.advance().span};if(this.check("FALSE"))return{kind:"BooleanLiteral",value:!1,span:this.advance().span};if(this.check("LBRACKET"))return this.parseArrayLiteral();if(this.check("TEMPLATE_START"))return this.parseTemplateLiteral();if(this.check("LINK"))return this.parseLink();if(this.check("ANCHOR"))return this.parseAnchor();if(this.check("INFERRED_VAR"))return this.parseInferredVariable();if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT"))return this.parseVariableReference();if(this.check("LOWER_IDENT")||this.check("UPPER_IDENT")||this.check("TEXT"))return this.parseInlineText();if(!this.isAtEnd()){let t=this.advance();return this.error("E001",`Unexpected token: ${t.type}`),{kind:"InlineText",text:t.value,span:t.span}}return{kind:"InlineText",text:"",span:e?.span||v(1,0,0,1,0,0)}}parseLambdaExpression(){let e=this.current(),t=[];if(this.check("LPAREN")){for(this.advance();!this.check("RPAREN")&&!this.isAtEnd();)this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1)),this.check("COMMA")&&this.advance();this.expect("RPAREN")}else this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1));this.expect("ARROW");let n=this.parseExpression();return{kind:"LambdaExpression",params:t,body:n,span:T(e.span,n.span)}}parseArrayLiteral(){let e=this.advance(),t=[];for(;!this.check("RBRACKET")&&!this.isAtEnd();)t.push(this.parseExpression()),this.check("COMMA")&&this.advance();let n=this.expect("RBRACKET");return{kind:"ArrayLiteral",elements:t,span:T(e.span,n?.span||this.previous().span)}}parseTemplateLiteral(){let e=this.advance(),t=[];for(;!this.check("TEMPLATE_END")&&!this.isAtEnd();)if(this.check("TEMPLATE_PART"))t.push(this.advance().value);else if(this.check("DOLLAR_IDENT")){let s=this.advance();t.push({kind:"VariableReference",name:s.value.slice(1),span:s.span})}else this.check("INFERRED_VAR")?t.push(this.parseInferredVariable()):this.advance();let n=this.expect("TEMPLATE_END");return{kind:"TemplateLiteral",parts:t,span:T(e.span,n?.span||this.previous().span)}}parseLink(){let e=this.expect("LINK");if(!e)return{kind:"Link",path:[],anchor:null,raw:"",span:this.current().span};let t=JSON.parse(e.value),n="~/"+t.path.join("/")+(t.anchor?"#"+t.anchor:"");return{kind:"Link",path:t.path,anchor:t.anchor,raw:n,span:e.span}}parseAnchor(){let e=this.expect("ANCHOR");return e?{kind:"Anchor",name:e.value,span:e.span}:{kind:"Anchor",name:"",span:this.current().span}}parseInferredVariable(){let e=this.advance();return{kind:"InferredVariable",name:e.value.slice(2,-1),span:e.span}}parseVariableReference(){let e=this.advance(),n={kind:"VariableReference",name:e.value.slice(1),span:e.span};for(;this.check("DOT");)if(this.advance(),this.check("LOWER_IDENT")||this.check("UPPER_IDENT")){let s=this.advance();n={kind:"MemberAccess",object:n,property:s.value,span:T(e.span,s.span)}}if(this.check("LPAREN")){this.advance();let s=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)s.push(this.parseExpression()),this.check("COMMA")&&this.advance();let a=this.expect("RPAREN");n={kind:"FunctionCall",callee:n,args:s,span:T(e.span,a?.span||this.previous().span)}}return n}parseInlineText(){let e=this.current(),t=e;for(;!this.isAtEnd()&&!this.check("NEWLINE")&&!this.check("HEADING")&&!this.check("LINK")&&!this.check("ANCHOR")&&!this.check("INFERRED_VAR")&&!this.check("DOLLAR_IDENT")&&!this.check("TYPE_IDENT");)t=this.advance();return{kind:"InlineText",text:this.source.slice(e.span.start.offset,t.span.end.offset),span:T(e.span,t.span)}}parseFor(){let e=this.advance(),t=this.parsePattern();this.expect("IN");let n=this.parseExpression();this.check("DO")&&this.advance(),this.expect("NEWLINE"),this.skipNewlines(),this.loopDepth++,this.blockDepth++;let s=this.parseBlockBody(["END"]);this.blockDepth--,this.loopDepth--;let a=this.expect("END");return this.skipNewlines(),{kind:"ForEachStatement",pattern:t,collection:n,body:s,span:T(e.span,a?.span||(s.length>0?s[s.length-1].span:n.span))}}parseWhile(){let e=this.advance(),t=this.parseCondition();this.check("DO")&&this.advance(),this.expect("NEWLINE"),this.skipNewlines(),this.loopDepth++,this.blockDepth++;let n=this.parseBlockBody(["END"]);this.blockDepth--,this.loopDepth--;let s=this.expect("END");return this.skipNewlines(),{kind:"WhileStatement",condition:t,body:n,span:T(e.span,s?.span||(n.length>0?n[n.length-1].span:t.span))}}parseIf(){let e=this.advance(),t=this.parseCondition();this.check("THEN")&&this.advance(),this.expect("NEWLINE"),this.skipNewlines(),this.blockDepth++;let n=this.parseBlockBody(["ELSE","END"]),s=[],a=null;for(;this.check("ELSE");){let c=this.current();if(this.advance(),this.check("IF")){this.advance();let r=this.parseCondition();this.check("THEN")&&this.advance(),this.expect("NEWLINE"),this.skipNewlines();let l=this.parseBlockBody(["ELSE","END"]);s.push({condition:r,body:l,span:T(c.span,l.length>0?l[l.length-1].span:r.span)})}else{this.expect("NEWLINE"),this.skipNewlines(),a=this.parseBlockBody(["END"]);break}}this.blockDepth--;let i=this.expect("END");this.skipNewlines();let p=i?.span||t.span;return a?.length?p=a[a.length-1].span:s.length>0?p=s[s.length-1].span:n.length&&(p=n[n.length-1].span),{kind:"IfStatement",condition:t,thenBody:n,elseIf:s,elseBody:a,span:T(e.span,p)}}parseBreak(){let e=this.advance();return this.loopDepth===0&&this.error("E016","BREAK can only be used inside a loop"),{kind:"BreakStatement",span:e.span}}parseContinue(){let e=this.advance();return this.loopDepth===0&&this.error("E017","CONTINUE can only be used inside a loop"),{kind:"ContinueStatement",span:e.span}}parseReturnStatement(){let e=this.advance(),t;!this.check("NEWLINE")&&!this.isAtEnd()&&!this.check("END")&&!this.check("ELSE")&&(t=this.parseExpression());let n=this.pos;for(;n<this.tokens.length&&this.tokens[n].type==="NEWLINE";)n++;let s=n<this.tokens.length?this.tokens[n]:{type:"EOF"};return["END","ELSE","EOF","HEADING"].includes(s.type)||this.error("E018","RETURN must be the last statement in a block or section"),{kind:"ReturnStatement",value:t,span:t?T(e.span,t.span):e.span}}parsePushStatement(){let e=this.parseVariableReference();e.kind!=="VariableReference"&&this.error("E019","Push target must be a variable"),this.expect("PUSH");let t=this.parseExpression();return{kind:"PushStatement",target:e,value:t,span:T(e.span,t.span)}}parseDoStatement(){let e=this.advance();if(!this.check("NEWLINE")){this.blockDepth>0&&this.error("E005","Single-line DO is only valid at top level");let s=this.parseSemanticSpan(["NEWLINE","EOF"]);return{kind:"DoStatement",instruction:s,span:T(e.span,s.span)}}this.expect("NEWLINE"),this.skipNewlines(),this.blockDepth++;let t=this.parseBlockBody(["END"]);this.blockDepth--;let n=this.expect("END");return this.skipNewlines(),{kind:"DoStatement",body:t,span:T(e.span,n?.span||(t.length>0?t[t.length-1].span:e.span))}}parseDelegateStatement(){let e=this.current(),t=!1,n=!1;if(this.check("ASYNC")?(t=!0,this.advance()):this.check("AWAIT")&&(n=!0,this.advance()),n&&this.check("DOLLAR_IDENT")){let r=this.parseVariableReference();return{kind:"DelegateStatement",handle:r,awaited:!0,span:T(e.span,r.span)}}this.expect("DELEGATE");let s,a=["TO","WITH","COLON","NEWLINE","END","EOF"];a.includes(this.current().type)||(s=this.parseSemanticSpan(a));let i;this.check("TO")&&(this.advance(),i=this.parseLink());let p,c;return this.check("WITH")?(this.advance(),this.check("COLON")?c=this.parseParameterBlock():this.check("ANCHOR")&&(p=this.parseAnchor())):this.check("COLON")&&(c=this.parseParameterBlock()),{kind:"DelegateStatement",task:s,target:i,withAnchor:p,parameters:c,async:t,awaited:n,span:T(e.span,this.previous().span)}}parseUseStatement(){let e=this.advance(),t=this.parseLink();this.expect("TO");let n=this.parseSemanticSpan(["COLON","NEWLINE","EOF"]),s;return this.check("COLON")&&(s=this.parseParameterBlock()),{kind:"UseStatement",link:t,task:n,parameters:s,span:T(e.span,this.previous().span)}}parseExecuteStatement(){let e=this.advance(),t=this.parseLink();this.expect("TO");let n=this.parseSemanticSpan(["COLON","NEWLINE","EOF"]),s;return this.check("COLON")&&(s=this.parseParameterBlock()),{kind:"ExecuteStatement",link:t,task:n,parameters:s,span:T(e.span,this.previous().span)}}parseGotoStatement(){let e=this.advance(),t=this.parseAnchor();return{kind:"GotoStatement",anchor:t,span:T(e.span,t.span)}}parseParameterBlock(){let e=this.advance();this.skipNewlines();let t=[];for(;(this.check("LOWER_IDENT")||this.check("UPPER_IDENT")||this.check("DOLLAR_IDENT"))&&!this.isAtEnd();){let n=this.advance(),s=n.type==="DOLLAR_IDENT"?n.value.slice(1):n.value;this.expect("COLON");let a=null,i=!1;!this.check("NEWLINE")&&!this.check("END")&&!this.check("ELSE")&&!this.isAtEnd()?a=this.parseExpression():i=!0,t.push({kind:"VariableDeclaration",name:s,typeAnnotation:null,value:a,isLambda:!1,isRequired:i,span:T(n.span,a?.span||n.span)}),this.skipNewlines()}return{kind:"ParameterBlock",parameters:t,span:T(e.span,this.previous().span)}}parsePattern(){if(this.check("LPAREN")){let e=this.advance(),t=[];for(;!this.check("RPAREN")&&!this.isAtEnd();)this.check("DOLLAR_IDENT")&&t.push(this.advance().value.slice(1)),this.check("COMMA")&&this.advance();let n=this.expect("RPAREN");return{kind:"DestructuringPattern",names:t,span:T(e.span,n?.span||this.previous().span)}}if(this.check("DOLLAR_IDENT")){let e=this.advance();return{kind:"SimplePattern",name:e.value.slice(1),span:e.span}}return this.error("E005","Expected pattern"),{kind:"SimplePattern",name:"",span:this.current().span}}parseCondition(){return this.parseOrCondition()}isConditionStop(e){return["AND","OR","THEN","DO","NEWLINE","END","ELSE","EOF"].includes(e)}hasComparisonOperatorAhead(){let e=!1,t=0;for(;;){let n=this.peek(t);if(!n||this.isConditionStop(n.type))return!1;if((n.type==="DOLLAR_IDENT"||n.type==="TYPE_IDENT")&&(e=!0),e&&["ASSIGN","NEQ","LT","GT","LTE","GTE"].includes(n.type))return!0;t+=1}}parseSemanticConditionSpan(e){let{content:t,span:n}=this.parseSemanticText(["AND","OR","THEN","DO","NEWLINE","END","ELSE","EOF"]);return{kind:"SemanticCondition",text:t,negated:e,span:n}}parseOrCondition(){let e=this.parseAndCondition();for(;this.check("OR");){this.advance();let t=this.parseAndCondition();e={kind:"CompoundCondition",operator:"OR",left:e,right:t,span:T(e.span,t.span)}}return e}parseAndCondition(){let e=this.parsePrimaryCondition();for(;this.check("AND");){this.advance();let t=this.parsePrimaryCondition();e={kind:"CompoundCondition",operator:"AND",left:e,right:t,span:T(e.span,t.span)}}return e}parsePrimaryCondition(){let e=this.check("NOT");if(e&&this.advance(),this.check("LPAREN")){this.advance();let t=this.parseCondition();return this.expect("RPAREN"),t}if((this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT"))&&this.hasComparisonOperatorAhead()){let t=this.parseVariableReference();if(this.check("ASSIGN")||this.check("NEQ")||this.check("LT")||this.check("GT")||this.check("LTE")||this.check("GTE")){let n=this.advance(),s=this.tokenToOperator(n.type),a=this.parsePrimary();return{kind:"DeterministicCondition",left:t,operator:s,right:a,span:T(t.span,a.span)}}}return this.parseSemanticConditionSpan(e)}parseBlockBody(e){let t=[];for(;!this.isAtEnd()&&!this.check("HEADING")&&!(e.includes(this.current().type)||(this.skipNewlines(),this.isAtEnd()||this.check("HEADING")||e.includes(this.current().type)));){let n=this.parseBlock();n&&t.push(n)}return t}parseParagraph(){let e=[],t=this.current(),n=this.pos===0?0:this.previous().span.end.offset,s=()=>{let a=this.current();a.span.start.offset>n&&e.push({kind:"InlineText",text:this.source.slice(n,a.span.start.offset),span:{start:this.pos===0?{line:1,column:0,offset:0}:this.previous().span.end,end:a.span.start}})};for(;!this.isAtEnd()&&!this.check("NEWLINE")&&!this.check("HEADING");)if(this.check("LINK")){s();let a=this.parseLink();e.push(a),n=a.span.end.offset}else if(this.check("ANCHOR")){s();let a=this.parseAnchor();e.push(a),n=a.span.end.offset}else if(this.check("INFERRED_VAR")){s();let a=this.parseInferredVariable();e.push(a),n=a.span.end.offset}else if(this.check("DOLLAR_IDENT")||this.check("TYPE_IDENT")){s();let a=this.advance();e.push({kind:"VariableReference",name:a.value.slice(1),span:a.span}),n=a.span.end.offset}else{s();let a=this.parseInlineText();a.text&&e.push(a),n=this.previous().span.end.offset}return s(),this.check("NEWLINE")&&this.advance(),{kind:"Paragraph",content:e,span:T(t.span,this.previous().span)}}parseCodeBlock(){let e=this.advance(),n=e.value.match(/^```(\w*)$/)?.[1]||null,s="";this.check("CODE_BLOCK_CONTENT")&&(s=this.advance().value);let a=this.expect("CODE_BLOCK_END");return{kind:"CodeBlock",language:n,content:s,span:T(e.span,a?.span||this.previous().span)}}parseHorizontalRule(){return{kind:"HorizontalRule",span:this.advance().span}}parseDelegation(){let e=this.advance(),t=e.value;this.check("LOWER_IDENT")&&this.current().value==="to"&&this.advance();let n;this.check("LINK")?n=this.parseLink():this.check("ANCHOR")?n=this.parseAnchor():(this.error("E001","Expected link reference (~/path) or anchor reference (#name)"),n={kind:"Anchor",name:"",span:this.current().span});let s=[];if(this.check("WITH")&&(this.advance(),this.check("COLON"))){let i=this.parseParameterBlock();s.push(...i.parameters)}let a=T(e.span,this.previous().span);return{kind:"Delegation",verb:t,target:n,parameters:s,span:a}}parseBlockquote(){let e=this.advance();return{kind:"Paragraph",content:[{kind:"InlineText",text:e.value.slice(1).trim(),span:e.span}],span:e.span}}isAtEnd(){return this.pos>=this.tokens.length||this.current().type==="EOF"}current(){return this.tokens[this.pos]||{type:"EOF",value:"",span:v(1,0,0,1,0,0)}}previous(){return this.tokens[this.pos-1]||this.current()}peek(e=0){let t=this.pos+e;return t<this.tokens.length?this.tokens[t]:null}advance(){return this.isAtEnd()||this.pos++,this.previous()}check(e){return this.current().type===e}expect(e){return this.check(e)?this.advance():(this.error("E001",`Expected ${e}, got ${this.current().type}`),null)}skipNewlines(){for(;this.check("NEWLINE");)this.advance()}error(e,t){this.errors.push({kind:"ParseError",code:e,message:t,recoverable:!0,span:this.current().span})}};function V(d){return new ne(d).parse()}var fe=12,ke=new Set(["String","Number","Boolean","FilePath","Any"]);function se(d){return ke.has(d)}var C={kind:"SemanticType",description:"any",span:v(0,0,0,0,0,0)};function Y(){return{kind:"SemanticType",description:"any",span:v(0,0,0,0,0,0)}}function xe(d){return[...new Set(d)].sort((e,t)=>e.localeCompare(t))}function me(d){return d.kind==="SemanticType"&&d.description.toLowerCase()==="any"?!0:d.kind==="TypeReference"&&d.name==="Any"}function ae(d,e=new Map){let t=new Map(e);for(let n of d)t.set(n.name,n.typeExpr);return t}function O(d,e,t={}){let n=t.maxDepth??fe,s=new Set,a=(i,p)=>{if(p>n)return i;if(i.kind==="TypeReference"){if(ke.has(i.name))return i;let c=e.get(i.name);return!c||s.has(i.name)?i:(s.add(i.name),a(c,p+1))}return i.kind==="ArrayType"?{...i,elementType:a(i.elementType,p+1)}:i.kind==="CompoundType"?{...i,elements:i.elements.map(c=>a(c,p+1))}:i.kind==="FunctionType"?{...i,returnType:a(i.returnType,p+1)}:i};return a(d,0)}function $(d){return d.kind==="EnumType"?{...d,values:xe(d.values)}:d.kind==="ArrayType"?{...d,elementType:$(d.elementType)}:d.kind==="CompoundType"?{...d,elements:d.elements.map(e=>$(e))}:d.kind==="FunctionType"?{...d,returnType:$(d.returnType)}:d}function B(d,e,t,n={}){let s=$(O(d,t,n)),a=$(O(e,t,n));if(me(a)||me(s))return{compatible:!0};if(a.kind==="TypeReference"&&s.kind==="TypeReference"&&a.name===s.name)return{compatible:!0};if(a.kind!==s.kind)return{compatible:!1,reason:"kind-mismatch"};switch(a.kind){case"SemanticType":return{compatible:a.description===s.description,reason:"semantic-mismatch"};case"EnumType":{let i=new Set(a.values);return s.values.filter(r=>!i.has(r)).length>0?{compatible:!1,reason:"enum-subset"}:{compatible:!0}}case"ArrayType":return B(s.elementType,a.elementType,t,n);case"CompoundType":{let i=a.elements,p=s.elements;if(i.length!==p.length)return{compatible:!1,reason:"tuple-length"};for(let c=0;c<i.length;c+=1){let r=B(p[c],i[c],t,n);if(!r.compatible)return r}return{compatible:!0}}case"FunctionType":{let i=a,p=s;if(i.params.length!==p.params.length)return{compatible:!1,reason:"function-arity"};for(let r=0;r<i.params.length;r+=1)if(i.params[r]!==p.params[r])return{compatible:!1,reason:"function-params"};return B(p.returnType,i.returnType,t,n).compatible?{compatible:!0}:{compatible:!1,reason:"function-return"}}case"TypeReference":return{compatible:a.name===s.name,reason:"reference-mismatch"};default:return{compatible:!1,reason:"unknown"}}}function _(d,e,t={}){let n=t.maxDepth??fe,s={maxDepth:n},a=(i,p)=>{if(p>n)return C;switch(i.kind){case"StringLiteral":return{kind:"TypeReference",name:"String",span:i.span};case"NumberLiteral":return{kind:"TypeReference",name:"Number",span:i.span};case"BooleanLiteral":return{kind:"TypeReference",name:"Boolean",span:i.span};case"ArrayLiteral":{if(i.elements.length===0)return{kind:"ArrayType",elementType:C,span:i.span};let c=i.elements.map(l=>a(l,p+1)),r=c[0];for(let l=1;l<c.length;l+=1)if(!B(c[l],r,e,s).compatible){r=C;break}return{kind:"ArrayType",elementType:r,span:i.span}}case"LambdaExpression":{let c=a(i.body,p+1);return{kind:"FunctionType",params:i.params,returnType:c,span:i.span}}case"VariableReference":{let c=e.get(i.name);return c?O(c,e,s):C}case"MemberAccess":return C;case"FunctionCall":return C;case"TemplateLiteral":return{kind:"TypeReference",name:"String",span:i.span};case"InlineText":return C;case"Link":case"Anchor":case"InferredVariable":case"BinaryExpression":case"UnaryExpression":return C;default:return C}};return $(O(a(d,0),e,s))}function ie(d){return{kind:"TypeReference",name:d,span:v(0,0,0,0,0,0)}}function U(){return ie("Any")}var re=class{constructor(e={},t){g(this,"options");g(this,"registry");g(this,"diagnostics",[]);g(this,"sourceMap",[]);g(this,"metadata");g(this,"dependencies");g(this,"definedTypes",new Set);g(this,"definedVariables",new Set);g(this,"declaredDeps",new Set);g(this,"declaredAgents",new Set);g(this,"declaredTools",new Set);g(this,"typeEnv",new Map);g(this,"variableTypeEnv",new Map);g(this,"registryTypeEnvs",new Map);this.options={includeHeader:!1,generateSourceMap:!0,validateReferences:!0,validateTypes:!0,validateScope:!0,validateContracts:!0,...e},this.registry=t||null,this.metadata=this.createEmptyMetadata(),this.dependencies={nodes:[],edges:[],cycles:[]}}createEmptyMetadata(){return{name:"",description:"",skills:[],agents:[],tools:[],uses:[],imports:[],types:[],variables:[],references:[],sections:[],parameters:[]}}compile(e){this.diagnostics=[],this.sourceMap=[],this.metadata=this.createEmptyMetadata(),this.dependencies={nodes:[],edges:[],cycles:[]},this.definedTypes.clear(),this.definedVariables.clear(),this.declaredDeps.clear(),this.declaredAgents.clear(),this.declaredTools.clear(),this.typeEnv.clear(),this.variableTypeEnv.clear(),this.registryTypeEnvs.clear();let t=V(e);for(let s of t.errors)this.diagnostics.push({severity:"error",code:s.code,message:s.message,span:s.span});this.extractMetadata(t),this.buildDependencyGraph(t),this.options.validateTypes&&this.validateTypes(t),this.options.validateScope&&this.validateScope(t),this.options.validateReferences&&this.validateReferences(),this.options.validateContracts&&this.validateContracts(t),this.validateDelegateStatements(t),this.validateReturnStatements(t);let n=e;return this.options.includeHeader&&(n=`<!-- MDZ Validated: ${this.metadata.name||"unnamed"} -->
<!-- Errors: ${this.diagnostics.filter(a=>a.severity==="error").length}, Warnings: ${this.diagnostics.filter(a=>a.severity==="warning").length} -->

`+e),{output:n,diagnostics:this.diagnostics,metadata:this.metadata,sourceMap:this.sourceMap,dependencies:this.dependencies}}extractMetadata(e){if(e.frontmatter){this.metadata.name=e.frontmatter.name,this.metadata.description=e.frontmatter.description,this.metadata.skills=[...e.frontmatter.skills],this.metadata.agents=[...e.frontmatter.agents],this.metadata.tools=[...e.frontmatter.tools],this.metadata.uses=[...e.frontmatter.uses];for(let t of e.frontmatter.skills)this.declaredDeps.add(t);for(let t of e.frontmatter.agents)this.declaredAgents.add(t);for(let t of e.frontmatter.tools)this.declaredTools.add(t);for(let t of e.frontmatter.imports){this.metadata.imports.push({path:t.path,skills:[...t.skills],aliases:new Map(t.aliases)});for(let n of t.skills)this.declaredDeps.add(n)}for(let t of e.frontmatter.types)this.definedTypes.add(t.name),this.typeEnv.set(t.name,t.typeExpr),this.metadata.types.push({name:t.name,definition:this.typeExprToString(t.typeExpr),span:t.span});for(let t of e.frontmatter.input)this.definedVariables.add(t.name),this.metadata.parameters.push({name:t.name,type:t.type?this.typeExprToString(t.type):null,hasDefault:t.defaultValue!==void 0,isRequired:t.required,span:t.span}),t.type&&this.variableTypeEnv.set(t.name,t.type);for(let t of e.frontmatter.context)this.definedVariables.add(t.name),this.metadata.variables.push({name:t.name,type:t.type?this.typeExprToString(t.type):null,hasDefault:t.initialValue!==void 0,isRequired:!1,span:t.span}),t.type&&this.variableTypeEnv.set(t.name,t.type)}for(let t of e.sections)t.title&&this.metadata.sections.push({title:t.title,anchor:t.anchor,level:t.level,span:t.span}),t.title==="Input"&&this.extractParameters(t.content),this.extractFromBlocks(t.content)}extractFromBlocks(e){for(let t of e)this.extractFromBlock(t)}extractFromBlock(e){switch(e.kind){case"TypeDefinition":this.extractTypeDefinition(e);break;case"VariableDeclaration":this.extractVariableDeclaration(e);break;case"ForEachStatement":this.extractFromControlFlow(e);break;case"ReturnStatement":e.value&&this.extractFromExpression(e.value);break;case"PushStatement":this.extractFromExpression(e.target),this.extractFromExpression(e.value);break;case"DoStatement":e.instruction&&this.sourceMap.push({source:e.instruction.span,type:"semantic",name:e.instruction.content}),e.body&&this.extractFromBlocks(e.body);break;case"WhileStatement":this.extractFromBlocks(e.body);break;case"IfStatement":this.extractFromBlocks(e.thenBody),e.elseBody&&this.extractFromBlocks(e.elseBody);break;case"Paragraph":this.extractFromParagraph(e);break;case"Delegation":this.extractFromDelegation(e);break;case"DelegateStatement":this.extractFromDelegateStatement(e);break;case"UseStatement":this.extractFromUseStatement(e);break;case"ExecuteStatement":this.extractFromExecuteStatement(e);break;case"GotoStatement":this.extractFromGotoStatement(e);break}}extractTypeDefinition(e){let t={name:e.name,definition:this.typeExprToString(e.typeExpr),span:e.span};this.metadata.types.push(t),this.definedTypes.add(e.name),this.typeEnv.set(e.name,e.typeExpr),this.sourceMap.push({source:e.span,type:"type-def",name:e.name})}typeExprToString(e){switch(e.kind){case"SemanticType":return e.description;case"EnumType":return e.values.map(t=>`"${t}"`).join(" | ");case"TypeReference":return`$${e.name}`;case"CompoundType":return"("+e.elements.map(t=>this.typeExprToString(t)).join(", ")+")";case"ArrayType":return this.typeExprToString(e.elementType)+"[]";case"FunctionType":return`(${e.params.join(", ")}) => ${this.typeExprToString(e.returnType)}`;default:return""}}extractVariableDeclaration(e){let t={name:e.name,type:this.getTypeAnnotationName(e.typeAnnotation),hasDefault:e.value!==null,isRequired:e.isRequired||!1,span:e.span};this.metadata.variables.push(t),this.definedVariables.add(e.name),e.typeAnnotation&&this.variableTypeEnv.set(e.name,this.typeAnnotationToTypeExpr(e.typeAnnotation)),this.sourceMap.push({source:e.span,type:"variable",name:e.name}),e.value&&this.extractFromExpression(e.value)}extractFromControlFlow(e){if(e.pattern.kind==="SimplePattern")this.definedVariables.add(e.pattern.name);else for(let t of e.pattern.names)this.definedVariables.add(t);this.sourceMap.push({source:e.span,type:"control-flow",name:e.kind}),this.extractFromExpression(e.collection),this.extractFromBlocks(e.body)}extractFromParagraph(e){for(let t of e.content)t.kind==="Link"?this.extractLinkReference(t):t.kind==="Anchor"?this.extractAnchorReference(t):t.kind==="InferredVariable"&&this.sourceMap.push({source:t.span,type:"semantic",name:"$/"+t.name+"/"})}extractFromDelegation(e){e.target.kind==="Link"?this.extractLinkReference(e.target):this.extractAnchorReference(e.target);for(let t of e.parameters)this.extractVariableDeclaration(t)}extractFromDelegateStatement(e){if(e.target&&this.extractLinkReference(e.target),e.task&&this.sourceMap.push({source:e.task.span,type:"semantic",name:e.task.content}),e.withAnchor&&this.extractAnchorReference(e.withAnchor),e.parameters)for(let t of e.parameters.parameters)this.extractVariableDeclaration(t),this.recordParameterType(t);this.sourceMap.push({source:e.span,type:"control-flow",name:"DelegateStatement"})}extractFromUseStatement(e){if(this.extractLinkReference(e.link),this.sourceMap.push({source:e.task.span,type:"semantic",name:e.task.content}),e.parameters)for(let t of e.parameters.parameters)this.extractVariableDeclaration(t),this.recordParameterType(t);this.sourceMap.push({source:e.span,type:"control-flow",name:"UseStatement"})}extractFromExecuteStatement(e){this.extractLinkReference(e.link),this.sourceMap.push({source:e.task.span,type:"semantic",name:e.task.content}),this.sourceMap.push({source:e.span,type:"control-flow",name:"ExecuteStatement"})}extractFromGotoStatement(e){this.extractAnchorReference(e.anchor),this.sourceMap.push({source:e.span,type:"control-flow",name:"GotoStatement"})}extractParameters(e){for(let t of e)t.kind==="VariableDeclaration"&&(this.metadata.parameters.push({name:t.name,type:this.getTypeAnnotationName(t.typeAnnotation),hasDefault:t.value!==null,isRequired:!t.value,span:t.span}),t.typeAnnotation&&this.variableTypeEnv.set(t.name,this.typeAnnotationToTypeExpr(t.typeAnnotation)))}getTypeAnnotationName(e){return e?e.kind==="TypeReference"?e.name:e.description:null}typeAnnotationToTypeExpr(e){return e}extractFromExpression(e){switch(e.kind){case"Link":this.extractLinkReference(e);break;case"Anchor":this.extractAnchorReference(e);break;case"InferredVariable":this.sourceMap.push({source:e.span,type:"semantic",name:"$/"+e.name+"/"});break;case"BinaryExpression":this.extractFromExpression(e.left),this.extractFromExpression(e.right);break;case"UnaryExpression":this.extractFromExpression(e.operand);break;case"ArrayLiteral":for(let t of e.elements)this.extractFromExpression(t);break;case"FunctionCall":this.extractFromExpression(e.callee);for(let t of e.args)this.extractFromExpression(t);break;case"MemberAccess":this.extractFromExpression(e.object);break;case"LambdaExpression":this.extractFromExpression(e.body);break}}extractLinkReference(e){let t=ee(e),n=e.raw;this.metadata.references.push({kind:t==="unknown"?"skill":t,target:n,path:e.path,anchor:e.anchor||void 0,span:e.span}),this.sourceMap.push({source:e.span,type:"reference",name:n})}extractAnchorReference(e){this.metadata.references.push({kind:"anchor",target:`#${e.name}`,anchor:e.name,span:e.span}),this.sourceMap.push({source:e.span,type:"reference",name:`#${e.name}`})}buildDependencyGraph(e){let t=new Set,n=[];for(let s of this.metadata.references)if(s.kind==="skill"&&s.path&&s.path.length>0){let a=s.path.join("/");t.add(a),n.push({target:a,type:"reference",span:s.span})}this.dependencies.nodes=Array.from(t),this.dependencies.edges=n}buildDocumentTypeEnv(){return ae(this.metadata.types.map(e=>({kind:"TypeDefinition",name:e.name,typeExpr:this.typeEnv.get(e.name)??Y(),span:e.span})))}buildVariableTypeEnv(){return new Map(this.variableTypeEnv)}buildTypeEnvFromAst(e){let t=new Map;if(e.frontmatter)for(let n of e.frontmatter.types)t.set(n.name,n.typeExpr);for(let n of e.sections)for(let s of n.content)s.kind==="TypeDefinition"&&t.set(s.name,s.typeExpr);return t}typeExprToStringResolved(e,t){return this.typeExprToString(O(e,t))}parameterTypeExprFor(e){return e.typeAnnotation?this.typeAnnotationToTypeExpr(e.typeAnnotation):e.value?_(e.value,this.variableTypeEnv):null}recordParameterType(e){let t=this.parameterTypeExprFor(e);t&&this.variableTypeEnv.set(e.name,t)}getRegistryTypeEnv(e,t){if(this.registryTypeEnvs.has(e))return this.registryTypeEnvs.get(e)??new Map;let n=this.buildTypeEnvFromAst(t.ast);return this.registryTypeEnvs.set(e,n),n}validateTypes(e){let t=this.buildDocumentTypeEnv();this.variableTypeEnv=this.buildVariableTypeEnv(),this.typeEnv=t;for(let n of this.metadata.variables)if(n.type&&!this.definedTypes.has(n.type)){if(se(n.type))continue;this.diagnostics.push({severity:"warning",code:"E008",message:`Type '$${n.type}' is not defined in this document`,span:n.span})}}validateScope(e){let t=new Set;for(let n of e.sections)this.checkScopeInBlocks(n.content,t)}checkScopeInBlocks(e,t){for(let n of e)if(n.kind==="VariableDeclaration")this.definedVariables.add(n.name),n.value&&this.checkExpressionScope(n.value,t);else if(n.kind==="ForEachStatement"){if(this.checkExpressionScope(n.collection,t),n.pattern.kind==="SimplePattern")this.definedVariables.add(n.pattern.name);else for(let s of n.pattern.names)this.definedVariables.add(s);this.checkScopeInBlocks(n.body,t)}else if(n.kind==="WhileStatement")this.checkConditionScope(n.condition,t),this.checkScopeInBlocks(n.body,t);else if(n.kind==="IfStatement"){this.checkConditionScope(n.condition,t),this.checkScopeInBlocks(n.thenBody,t);for(let s of n.elseIf)this.checkConditionScope(s.condition,t),this.checkScopeInBlocks(s.body,t);n.elseBody&&this.checkScopeInBlocks(n.elseBody,t)}else if(n.kind==="Paragraph")for(let s of n.content)s.kind==="VariableReference"&&(this.definedVariables.has(s.name)||t.add(s.name));else if(n.kind==="DelegateStatement"){if(n.task)for(let s of n.task.interpolations)this.definedVariables.has(s.name)||t.add(s.name);if(n.parameters)for(let s of n.parameters.parameters)s.value&&this.checkExpressionScope(s.value,t)}else if(n.kind==="ReturnStatement")n.value&&this.checkExpressionScope(n.value,t);else if(n.kind==="PushStatement")this.definedVariables.has(n.target.name)||t.add(n.target.name),this.checkExpressionScope(n.value,t);else if(n.kind==="DoStatement"){if(n.instruction)for(let s of n.instruction.interpolations)this.definedVariables.has(s.name)||t.add(s.name);n.body&&this.checkScopeInBlocks(n.body,t)}}checkExpressionScope(e,t){if(e.kind==="VariableReference")this.definedVariables.has(e.name)||t.add(e.name);else if(e.kind!=="InferredVariable"){if(e.kind==="BinaryExpression")this.checkExpressionScope(e.left,t),this.checkExpressionScope(e.right,t);else if(e.kind==="UnaryExpression")this.checkExpressionScope(e.operand,t);else if(e.kind==="ArrayLiteral")for(let n of e.elements)this.checkExpressionScope(n,t);else if(e.kind==="MemberAccess")this.checkExpressionScope(e.object,t);else if(e.kind==="FunctionCall"){this.checkExpressionScope(e.callee,t);for(let n of e.args)this.checkExpressionScope(n,t)}}}checkConditionScope(e,t){switch(e.kind){case"DeterministicCondition":this.checkExpressionScope(e.left,t),this.checkExpressionScope(e.right,t);break;case"CompoundCondition":this.checkConditionScope(e.left,t),this.checkConditionScope(e.right,t);break;case"SemanticCondition":break}}validateReferences(){for(let e of this.metadata.references)e.kind==="anchor"&&e.anchor&&(this.metadata.sections.some(n=>n.anchor===e.anchor)||this.diagnostics.push({severity:"error",code:"E010",message:`Section '#${e.anchor}' does not exist in this document`,span:e.span}));if(this.registry){for(let e of this.metadata.references)if(e.path&&e.path.length>0){let t=e.path.join("/"),n=this.registry.get(t);n?e.anchor&&(n.ast.sections.find(a=>a.anchor===e.anchor)||this.diagnostics.push({severity:"error",code:"E010",message:`Section '#${e.anchor}' does not exist in '${e.target}'`,span:e.span})):this.diagnostics.push({severity:"error",code:"E009",message:`File '${e.target}' is not found in registry`,span:e.span})}}}validateDelegateStatements(e){let t=[];this.findDelegateStatements(e.sections,t);for(let n of t)this.validateDelegateAgent(n)}findDelegateStatements(e,t){for(let n of e)this.findDelegateStatementsInBlocks(n.content,t)}findDelegateStatementsInBlocks(e,t){for(let n of e)if(n.kind==="DelegateStatement")t.push(n);else if(n.kind==="ForEachStatement")this.findDelegateStatementsInBlocks(n.body,t);else if(n.kind==="WhileStatement")this.findDelegateStatementsInBlocks(n.body,t);else if(n.kind==="IfStatement"){this.findDelegateStatementsInBlocks(n.thenBody,t);for(let s of n.elseIf)this.findDelegateStatementsInBlocks(s.body,t);n.elseBody&&this.findDelegateStatementsInBlocks(n.elseBody,t)}}validateDelegateAgent(e){if(!e.target)return;ee(e.target)!=="agent"&&this.diagnostics.push({severity:"warning",code:"W003",message:`DELEGATE target '${e.target.raw}' should be an agent (~/agent/...)`,span:e.target.span})}validateReturnStatements(e){for(let t of e.sections)this.validateReturnInBlocks(t.content)}validateReturnInBlocks(e){for(let t=0;t<e.length;t++){let n=e[t];if(n.kind==="ReturnStatement")t===e.length-1||this.addDiagnostic({severity:"error",code:"E018",message:"RETURN must be at end of section or loop iteration",span:n.span});else if(n.kind==="ForEachStatement"||n.kind==="WhileStatement")this.validateReturnInBlocks(n.body);else if(n.kind==="IfStatement"){this.validateReturnInBlocks(n.thenBody);for(let s of n.elseIf)this.validateReturnInBlocks(s.body);n.elseBody&&this.validateReturnInBlocks(n.elseBody)}}}addDiagnostic(e){this.diagnostics.push(e)}validateContracts(e){let t=[];this.findDelegations(e.sections,t);for(let n of t){let s;n.kind==="Delegation"?s=n.target:n.kind==="UseStatement"||n.kind==="ExecuteStatement"?s=n.link:n.kind==="DelegateStatement"&&(s=n.target),s&&s.kind==="Link"&&this.validateDelegationParameters(n)}}findDelegations(e,t){for(let n of e)this.findDelegationsInBlocks(n.content,t)}findDelegationsInBlocks(e,t){for(let n of e)n.kind==="Delegation"||n.kind==="UseStatement"||n.kind==="ExecuteStatement"||n.kind==="DelegateStatement"?t.push(n):n.kind==="ForEachStatement"?this.findDelegationsInBlocks(n.body,t):n.kind==="WhileStatement"?this.findDelegationsInBlocks(n.body,t):n.kind==="IfStatement"&&(this.findDelegationsInBlocks(n.thenBody,t),n.elseBody&&this.findDelegationsInBlocks(n.elseBody,t))}validateDelegationParameters(e){let t;if(e.kind==="Delegation"?e.target.kind==="Link"&&(t=e.target):e.kind==="UseStatement"||e.kind==="ExecuteStatement"?t=e.link:e.kind==="DelegateStatement"&&(t=e.target),!t)return;let n=t.path.join("/"),s=[],a=this.buildDocumentTypeEnv();if(n===this.metadata.name)s=this.metadata.parameters;else if(this.registry){let r=this.registry.get(n);if(r){let l=this.getRegistryTypeEnv(n,r),u=z(r.source,{validateReferences:!1,validateContracts:!1});s=u.metadata.parameters,a=ae(u.metadata.types.map(E=>({kind:"TypeDefinition",name:E.name,typeExpr:l.get(E.name)??Y(),span:E.span})))}}let i=[];e.kind==="Delegation"?i=e.parameters:e.parameters&&(i=e.parameters.parameters);let p=new Set(i.map(r=>r.name)),c=s.filter(r=>r.isRequired);for(let r of c)p.has(r.name)||this.diagnostics.push({severity:"error",code:"E011",message:`Required parameter '${r.name}' is missing for '${n}'`,span:e.span});if(i.length>0)for(let r of i){let l=s.find(S=>S.name===r.name);if(!l){this.diagnostics.push({severity:"warning",code:"W002",message:`Parameter '${r.name}' is not defined for '${n}'`,span:r.span});continue}if(!l.type)continue;let u=this.parameterTypeExprFor(r);if(!u)continue;let E=a.has(l.type)||se(l.type)?ie(l.type):Y(),b=O(E,a),P=O(u,this.buildDocumentTypeEnv());if(!B(P,b,new Map).compatible){let S=this.typeExprToStringResolved(b,a),X=this.typeExprToStringResolved(P,this.buildDocumentTypeEnv());this.diagnostics.push({severity:"error",code:"E020",message:`Parameter '${r.name}' expects ${S} but received ${X}`,span:r.span})}}}};function z(d,e,t){return new re(e,t).compile(d)}var Z=class{constructor(){g(this,"documents",new Map);g(this,"skillRegistry",new Map);g(this,"workspaceFolders",[]);g(this,"semanticTokenTypes",["keyword","variable","type","string","number","operator","function","parameter","namespace","semanticSpan","link","anchor","frontmatter","heading"]);g(this,"semanticTokenTypeIndex",new Map(this.semanticTokenTypes.map((e,t)=>[e,t])))}setWorkspaceFolders(e){this.workspaceFolders=e}indexDocument(e,t,n){let s=this.analyzeDocument(e,t);this.documents.set(e,s);let a=n||this.computeRegistryKey(e);this.skillRegistry.set(a,s)}computeRegistryKey(e){return e.replace(/^file:\/\//,"").replace(/\.mdz$/,"")}openDocument(e,t){let n=this.analyzeDocument(e,t);return this.documents.set(e,n),this.skillRegistry.set(this.computeRegistryKey(e),n),this.getDiagnostics(n)}updateDocument(e,t){let n=this.analyzeDocument(e,t);return this.documents.set(e,n),this.skillRegistry.set(this.computeRegistryKey(e),n),this.getDiagnostics(n)}closeDocument(e){this.documents.delete(e)}analyzeDocument(e,t){let n=V(t),s=new Map,a=new Map,i=[],p=new Map,c=new Map,r=[],l=this.collectFrontmatterDeclarationSpans(t);if(n.frontmatter){for(let S of n.frontmatter.types)s.set(S.name,{name:S.name,definition:this.typeExprToString(S.typeExpr),span:l.types.get(S.name)??S.span,typeExpr:S.typeExpr}),this.analyzeTypeExpr(S.typeExpr,c);for(let S of n.frontmatter.input)a.set(S.name,{name:S.name,typeExpr:S.type,span:l.input.get(S.name)??S.span,isLambda:!1,source:"input"}),S.type&&this.analyzeTypeExpr(S.type,c);for(let S of n.frontmatter.context)a.set(S.name,{name:S.name,typeExpr:S.type,span:l.context.get(S.name)??S.span,isLambda:!1,source:"context"}),S.type&&this.analyzeTypeExpr(S.type,c)}for(let S of n.sections)this.analyzeBlocks(S.title,S.content,s,a,i,r,p,c);let u=this.collectParameters(n),E=this.buildTypeEnv(s,n),b=this.buildVariableTypes(a),P=e.replace(/\.mdz$/,""),I={uri:e,content:t,ast:n,types:s,variables:a,references:i,variableRefs:p,typeRefs:c,semanticSpans:r,parameters:u,typeEnv:E,variableTypes:b};return this.skillRegistry.set(P,I),I}analyzeBlocks(e,t,n,s,a,i,p,c){let r=e==="Types"||e==="Input"||e==="Context";for(let l of t)switch(l.kind){case"TypeDefinition":r||n.set(l.name,{name:l.name,definition:this.typeExprToString(l.typeExpr),span:l.span,typeExpr:l.typeExpr}),this.analyzeTypeExpr(l.typeExpr,c);break;case"VariableDeclaration":r||s.set(l.name,{name:l.name,typeExpr:l.typeAnnotation??void 0,span:l.span,isLambda:l.isLambda,source:"local"}),l.typeAnnotation&&l.typeAnnotation.kind==="TypeReference"&&this.addRef(c,l.typeAnnotation.name,l.typeAnnotation.span),l.value&&this.analyzeExpression(l.value,a,i,p,c);break;case"ForEachStatement":if(l.pattern.kind==="SimplePattern")s.set(l.pattern.name,{name:l.pattern.name,span:l.pattern.span,isLambda:!1,source:"local"});else for(let u of l.pattern.names)s.set(u,{name:u,span:l.pattern.span,isLambda:!1,source:"local"});this.analyzeExpression(l.collection,a,i,p,c),this.analyzeBlocks(e,l.body,n,s,a,i,p,c);break;case"WhileStatement":this.analyzeCondition(l.condition,a,i,p,c),this.analyzeBlocks(e,l.body,n,s,a,i,p,c);break;case"IfStatement":this.analyzeCondition(l.condition,a,i,p,c),this.analyzeBlocks(e,l.thenBody,n,s,a,i,p,c);for(let u of l.elseIf)this.analyzeCondition(u.condition,a,i,p,c),this.analyzeBlocks(e,u.body,n,s,a,i,p,c);l.elseBody&&this.analyzeBlocks(e,l.elseBody,n,s,a,i,p,c);break;case"Paragraph":for(let u of l.content)K(u)?a.push({kind:"link",path:u.path,anchor:u.anchor??void 0,target:u.raw,span:u.span}):J(u)?a.push({kind:"anchor",anchor:u.name,target:`#${u.name}`,span:u.span}):u.kind==="VariableReference"&&this.addRef(p,u.name,u.span);break;case"Delegation":case"UseStatement":case"ExecuteStatement":case"DelegateStatement":case"PushStatement":case"ReturnStatement":case"DoStatement":case"GotoStatement":this.analyzeOtherBlock(l,a,i,p,c,n,s,e);break}}addRef(e,t,n){e.has(t)||e.set(t,[]),e.get(t).push(n)}analyzeTypeExpr(e,t){switch(e.kind){case"TypeReference":this.addRef(t,e.name,e.span);break;case"ArrayType":this.analyzeTypeExpr(e.elementType,t);break;case"CompoundType":e.elements.forEach(n=>this.analyzeTypeExpr(n,t));break;case"FunctionType":this.analyzeTypeExpr(e.returnType,t);break}}analyzeOtherBlock(e,t,n,s,a,i,p,c){switch(e.kind){case"Delegation":e.target.kind==="Link"?t.push({kind:"link",path:e.target.path,anchor:e.target.anchor??void 0,target:e.target.raw,span:e.target.span}):t.push({kind:"anchor",anchor:e.target.name,target:`#${e.target.name}`,span:e.target.span});for(let r of e.parameters)r.typeAnnotation&&r.typeAnnotation.kind==="TypeReference"&&this.addRef(a,r.typeAnnotation.name,r.typeAnnotation.span),r.value&&this.analyzeExpression(r.value,t,n,s,a);break;case"UseStatement":case"ExecuteStatement":{let r=e.link;if(t.push({kind:"link",path:r.path,anchor:r.anchor??void 0,target:r.raw,span:r.span}),e.kind==="UseStatement"&&e.parameters)for(let l of e.parameters.parameters)l.value&&this.analyzeExpression(l.value,t,n,s,a);break}case"DelegateStatement":if(e.target&&t.push({kind:"link",path:e.target.path,anchor:e.target.anchor??void 0,target:e.target.raw,span:e.target.span}),e.withAnchor&&t.push({kind:"anchor",anchor:e.withAnchor.name,target:`#${e.withAnchor.name}`,span:e.withAnchor.span}),e.parameters)for(let r of e.parameters.parameters)r.value&&this.analyzeExpression(r.value,t,n,s,a);break;case"PushStatement":this.analyzeExpression(e.target,t,n,s,a),this.analyzeExpression(e.value,t,n,s,a);break;case"ReturnStatement":e.value&&this.analyzeExpression(e.value,t,n,s,a);break;case"DoStatement":e.body&&this.analyzeBlocks(c,e.body,i,p,t,n,s,a);break;case"GotoStatement":t.push({kind:"anchor",anchor:e.anchor.name,target:`#${e.anchor.name}`,span:e.anchor.span});break}}analyzeExpression(e,t,n,s,a){if(K(e)){t.push({kind:"link",path:e.path,anchor:e.anchor??void 0,target:e.raw,span:e.span});return}if(J(e)){t.push({kind:"anchor",anchor:e.name,target:`#${e.name}`,span:e.span});return}switch(e.kind){case"VariableReference":this.addRef(s,e.name,e.span);break;case"ArrayLiteral":for(let i of e.elements)this.analyzeExpression(i,t,n,s,a);break;case"TemplateLiteral":for(let i of e.parts)typeof i!="string"&&this.analyzeExpression(i,t,n,s,a);break;case"BinaryExpression":this.analyzeExpression(e.left,t,n,s,a),this.analyzeExpression(e.right,t,n,s,a);break;case"LambdaExpression":this.analyzeExpression(e.body,t,n,s,a);break;case"FunctionCall":this.analyzeExpression(e.callee,t,n,s,a);for(let i of e.args)this.analyzeExpression(i,t,n,s,a);break;case"MemberAccess":this.analyzeExpression(e.object,t,n,s,a);break}}analyzeCondition(e,t,n,s,a){switch(e.kind){case"SemanticCondition":n.push({content:e.text,span:e.span});break;case"DeterministicCondition":this.analyzeExpression(e.left,t,n,s,a),this.analyzeExpression(e.right,t,n,s,a);break;case"CompoundCondition":this.analyzeCondition(e.left,t,n,s,a),this.analyzeCondition(e.right,t,n,s,a);break}}typeExprToString(e){switch(e.kind){case"SemanticType":return e.description;case"EnumType":return e.values.map(t=>`"${t}"`).join(" | ");case"TypeReference":return`$${e.name}`;case"CompoundType":return`(${e.elements.map(t=>this.typeExprToString(t)).join(", ")})`;case"ArrayType":return`${this.typeExprToString(e.elementType)}[]`;case"FunctionType":return`(${e.params.join(", ")}) => ${this.typeExprToString(e.returnType)}`;default:return""}}getSemanticTokensLegend(){return{tokenTypes:[...this.semanticTokenTypes],tokenModifiers:[]}}getSemanticTokens(e){let t=this.documents.get(e);if(!t)return{data:[]};let n=[],s=this.buildLineOffsets(t.content),a=this.collectCodeBlockLines(t.ast),i=t.content.split(`
`),p=new Set;if(t.ast.frontmatter){let o=t.ast.frontmatter.span.start.line,m=t.ast.frontmatter.span.end.line;for(let k=o;k<=m;k+=1)p.add(k)}let c=(o,m,k,h)=>{if(k<=0)return;let f=this.semanticTokenTypeIndex.get(h);f!==void 0&&n.push({line:o,char:m,length:k,type:f,modifiers:0})},r=(o,m)=>{o.start.line===o.end.line&&c(o.start.line-1,o.start.column,o.end.column-o.start.column,m)},l=(o,m,k)=>{m<=0||c(o,0,m,k)},u=()=>{if(!t.ast.frontmatter)return;let o=t.ast.frontmatter.span.start.line-1,m=t.ast.frontmatter.span.end.line-1;for(let k=o;k<=m;k+=1){let h=i[k]??"";if(h.trim()==="---"){l(k,h.length,"frontmatter");continue}let y=h.match(/^\s*[A-Za-z0-9_-]+:/);y&&c(k,y.index??0,y[0].length,"frontmatter")}},E=/^#+\s+/,b=/\b(THEN|IN|WITH|TO)\b/g,P=(o,m)=>{a.has(o+1)||p.has(o+1)||E.test(m)&&l(o,m.length,"heading")},I=(o,m)=>{if(a.has(o+1)||p.has(o+1))return;b.lastIndex=0;let k;for(;k=b.exec(m);)c(o,k.index,k[0].length,"keyword")},S=(o,m)=>{if(a.has(o+1)||p.has(o+1))return;let k=/\/[^\/\n]+\//g,h;for(k.lastIndex=0;h=k.exec(m);)c(o,h.index,h[0].length,"semanticSpan")},X=(o,m)=>{if(a.has(o+1))return;let k=/`[^`]*`/g,h=/\$\/[^\/\n]+\/|\$[A-Za-z][A-Za-z0-9-]*/g,f;for(k.lastIndex=0;f=k.exec(m);){let y=f.index,A=f.index+f[0].length,N=f[0].slice(1,-1),D=y;h.lastIndex=0;let R;for(;R=h.exec(N);){let L=y+1+R.index;D<L&&c(o,D,L-D,"string"),c(o,L,R[0].length,"variable"),D=L+R[0].length}D<A&&c(o,D,A-D,"string")}},Te=(o,m)=>{if(!p.has(o+1)||m.trim()==="---")return;let k=[{regex:/\$\/[^\/\n]+\//g,type:"variable"},{regex:/\$[A-Z][A-Za-z0-9]*/g,type:"type"},{regex:/\$[a-z][A-Za-z0-9-]*/g,type:"variable"},{regex:/"[^"]*"/g,type:"string"},{regex:/\b-?\d+(?:\.\d+)?\b/g,type:"number"}];for(let{regex:f,type:y}of k){let A;for(f.lastIndex=0;A=f.exec(m);)c(o,A.index,A[0].length,y)}let h=m.match(/(\$[A-Za-z][A-Za-z0-9-]*\s*:\s+)(?!\$|"|\()([^\n=]+)/);if(h&&h.index!==void 0){let f=h.index+h[1].length,y=h.index+h[0].length;for(;y>f&&/\s/.test(m[y-1]);)y-=1;c(o,f,y-f,"semanticSpan")}},ge=o=>{if(o.start.line!==o.end.line)return;let m=o.start.line-1,k=i[m]??"",h=o.start.column,f=o.end.column-o.start.column;h>=1&&k[h-1]==='"'?(h-=1,f+=1):h>=2&&k[h-2]==='"'&&(h-=2,f+=2),h+f<k.length&&k[h+f]==='"'&&(f+=1),c(m,h,f,"string")},Se=(o,m)=>{if(a.has(o+1))return;let k=m.match(/^\s*(ELSE IF|ELSE|IF|FOR|WHILE|DO|END|RETURN|BREAK|CONTINUE|ASYNC|AWAIT|DELEGATE|USE|EXECUTE|GOTO)\b/);if(!k)return;let h=k[1],f=m.indexOf(h);f>=0&&c(o,f,h.length,"keyword")},H=(o,m)=>{let k=o.start.offset,h=o.end.offset,f=t.content.slice(k,h),y=-1;if(m==="AND"||m==="OR"||m==="NOT"){let D=new RegExp(`\\b${m}\\b`),R=f.match(D);R&&R.index!==void 0&&(y=R.index)}else y=f.indexOf(m);if(y<0)return;let A=this.offsetToPosition(k+y,s),N=m==="AND"||m==="OR"||m==="NOT"?"keyword":"operator";c(A.line,A.character,m.length,N)},oe=(o,m,k,h,f,y)=>{if(a.has(o+1))return;let A=i[o]||"",N=Math.max(0,m),D=k>0?Math.min(A.length,k):A.length,R=A.slice(N,D),L=R.indexOf(h);if(L===-1&&y){let de=h.replace(/^\$/,""),Ee=new RegExp(`\\b${de}\\b`),Q=R.match(Ee);if(Q&&Q.index!==void 0){L=Q.index,c(o,N+L,de.length,f);return}return}L!==-1&&c(o,N+L,h.length,f)},F=(o,m)=>{let k=o.start.line-1;oe(k,o.start.column,o.end.column,`$${m}`,"variable",!0)},ce=(o,m)=>{let k=o.start.line-1;oe(k,o.start.column,o.end.column,`$${m}`,"type",!1)},G=o=>{if(o.span.start.line!==o.span.end.line){r(o.span,"semanticSpan");return}let m=o.span.start.line-1,k=o.span.start.column,h=o.span.end.column,f=o.interpolations.filter(A=>A.span.start.line===o.span.start.line).sort((A,N)=>A.span.start.column-N.span.start.column),y=k;for(let A of f){let N=A.span.start.column,D=A.span.end.column;N>y&&c(m,y,N-y,"semanticSpan"),D>N&&c(m,N,D-N,"variable"),y=Math.max(y,D)}y<h&&c(m,y,h-y,"semanticSpan")},ye=o=>{if(o.span.start.line!==o.span.end.line)return;let m=o.span.start.line-1,k=i[m]??"",h=Math.max(0,o.span.start.column-2),f=Math.min(k.length,o.span.end.column+2);if(f<=h)return;let y=/"[^"]*"/g,A;for(;A=y.exec(k);){let N=A.index,D=A.index+A[0].length;N>=h&&D<=f&&c(m,N,A[0].length,"string")}},j=o=>{switch(o.kind){case"SemanticType":r(o.span,"semanticSpan");break;case"EnumType":ye(o);break;case"CompoundType":o.elements.forEach(j);break;case"ArrayType":j(o.elementType);break;case"FunctionType":j(o.returnType);break;case"TypeReference":r(o.span,"type");break}},x=o=>{switch(o.kind){case"VariableReference":r(o.span,"variable");break;case"InferredVariable":r(o.span,"variable");break;case"StringLiteral":ge(o.span);break;case"NumberLiteral":r(o.span,"number");break;case"BooleanLiteral":r(o.span,"keyword");break;case"Link":r(o.span,"link");break;case"Anchor":r(o.span,"anchor");break;case"TemplateLiteral":for(let m of o.parts)typeof m!="string"&&x(m);break;case"ArrayLiteral":for(let m of o.elements)x(m);break;case"BinaryExpression":x(o.left),x(o.right),H(o.span,o.operator);break;case"UnaryExpression":x(o.operand),H(o.span,o.operator);break;case"LambdaExpression":x(o.body);break;case"FunctionCall":x(o.callee);for(let m of o.args)x(m);break;case"MemberAccess":x(o.object);break;case"InlineText":break}},W=o=>{switch(o.kind){case"SemanticCondition":r(o.span,"semanticSpan");break;case"DeterministicCondition":x(o.left),x(o.right),H(o.span,o.operator);break;case"CompoundCondition":W(o.left),W(o.right),H(o.span,o.operator);break}},M=(o,m)=>{let k=o==="Types"||o==="Input"||o==="Context";for(let h of m)switch(h.kind){case"TypeDefinition":k||(ce(h.span,h.name),j(h.typeExpr));break;case"VariableDeclaration":k||(F(h.span,h.name),h.typeAnnotation&&(h.typeAnnotation.kind==="TypeReference"?ce(h.typeAnnotation.span,h.typeAnnotation.name):h.typeAnnotation.kind==="SemanticType"&&r(h.typeAnnotation.span,"semanticSpan"))),h.value&&x(h.value);break;case"ForEachStatement":if(h.pattern.kind==="SimplePattern")F(h.pattern.span,h.pattern.name);else for(let f of h.pattern.names)F(h.pattern.span,f);x(h.collection),M(o,h.body);break;case"WhileStatement":W(h.condition),M(o,h.body);break;case"IfStatement":W(h.condition),M(o,h.thenBody);for(let f of h.elseIf)W(f.condition),M(o,f.body);h.elseBody&&M(o,h.elseBody);break;case"DoStatement":{let f=h;f.instruction&&G(f.instruction),f.body&&M(o,f.body);break}case"ReturnStatement":h.value&&x(h.value);break;case"PushStatement":x(h.target),x(h.value);break;case"DelegateStatement":if(h.task&&G(h.task),h.target&&r(h.target.span,"link"),h.withAnchor&&r(h.withAnchor.span,"anchor"),h.parameters)for(let f of h.parameters.parameters)F(f.span,f.name),f.value&&x(f.value);break;case"UseStatement":if(r(h.link.span,"link"),G(h.task),h.parameters)for(let f of h.parameters.parameters)F(f.span,f.name),f.value&&x(f.value);break;case"ExecuteStatement":r(h.link.span,"link"),G(h.task);break;case"GotoStatement":r(h.anchor.span,"anchor");break;case"Delegation":r(h.target.span,h.target.kind==="Link"?"link":"anchor");for(let f of h.parameters)F(f.span,f.name),f.value&&x(f.value);break;case"Paragraph":for(let f of h.content)switch(f.kind){case"VariableReference":case"InferredVariable":r(f.span,"variable");break;case"Link":r(f.span,"link");break;case"Anchor":r(f.span,"anchor");break;case"CodeSpan":break}break;case"CodeBlock":case"List":case"HorizontalRule":break}};for(let o of t.ast.sections)M(o.title,o.content);u();for(let o=0;o<i.length;o+=1)P(o,i[o]),Se(o,i[o]),I(o,i[o]),S(o,i[o]),X(o,i[o]),Te(o,i[o]);n.sort((o,m)=>o.line-m.line||o.char-m.char);let pe=[],le=0,he=0;for(let o of n){let m=o.line-le,k=m===0?o.char-he:o.char;pe.push(m,k,o.length,o.type,o.modifiers),le=o.line,he=o.char}return{data:pe}}getDiagnostics(e){let t=[];for(let n of e.ast.errors)t.push({range:this.spanToRange(n.span),severity:1,message:n.message,source:"zen"});for(let n of e.references)if(n.kind==="link"&&n.path){let s=n.path.join("/"),a=this.skillRegistry.get(s);a?n.anchor&&(a.ast.sections.find(p=>p.anchor===n.anchor)||t.push({range:this.spanToRange(n.span),severity:2,message:`Section "${n.anchor}" not found in ~/${s}`,source:"zen"})):t.push({range:this.spanToRange(n.span),severity:3,message:`File not found in workspace: ~/${s}`,source:"zen"})}else n.kind==="anchor"&&n.anchor&&(e.ast.sections.find(a=>a.anchor===n.anchor)||t.push({range:this.spanToRange(n.span),severity:2,message:`Section "${n.anchor}" not found in current file`,source:"zen"}));return this.validateDelegationContracts(e,t),t}getDefinition(e,t){let n=this.documents.get(e);if(!n)return null;for(let[s,a]of n.variableRefs)for(let i of a)if(this.positionInSpan(t,i)){let p=n.variables.get(s);if(p)return{uri:e,range:this.spanToRange(p.span)}}for(let[s,a]of n.variables)if(this.positionInSpan(t,a.span))return{uri:e,range:this.spanToRange(a.span)};for(let[s,a]of n.typeRefs)for(let i of a)if(this.positionInSpan(t,i)){let p=n.types.get(s);if(p)return{uri:e,range:this.spanToRange(p.span)}}for(let[s,a]of n.types)if(this.positionInSpan(t,a.span))return{uri:e,range:this.spanToRange(a.span)};for(let s of n.references)if(this.positionInSpan(t,s.span)){if(s.kind==="link"&&s.path){let a=s.path.join("/"),i=this.skillRegistry.get(a);if(i){if(s.anchor){let p=i.ast.sections.find(c=>c.anchor===s.anchor);if(p)return{uri:i.uri,range:this.spanToRange(p.span)}}return{uri:i.uri,range:{start:{line:0,character:0},end:{line:0,character:0}}}}}else if(s.kind==="anchor"&&s.anchor){let a=n.ast.sections.find(i=>i.anchor===s.anchor);if(a)return{uri:e,range:this.spanToRange(a.span)}}}return null}getHover(e,t){let n=this.documents.get(e);if(!n)return null;for(let[s,a]of n.types)if((n.typeRefs.get(s)||[]).some(c=>this.positionInSpan(t,c))||this.positionInSpan(t,a.span))return{contents:`**Type** $${s}

${a.definition}`,range:this.spanToRange(a.span)};for(let[s,a]of n.variables)if((n.variableRefs.get(s)||[]).some(c=>this.positionInSpan(t,c))||this.positionInSpan(t,a.span)){let c=`**Variable** $${s}`,r=a.typeExpr||this.inferVariableType(n,s);if(r&&(c+=`: ${this.typeExprToString(r)}`,r.kind==="TypeReference")){let l=n.types.get(r.name);l&&(c+=`

${l.definition}`)}return a.source!=="local"&&(c+=`

*${a.source}*`),a.isLambda&&(c+=`

*Lambda function*`),{contents:c,range:this.spanToRange(a.span)}}for(let s of n.references)if(this.positionInSpan(t,s.span)){let a;if(s.kind==="link"&&s.path){let i=s.path.join("/"),p=this.inferLinkKind(s.path),c=this.skillRegistry.get(i);if(!c)a=`**${p}:** ${s.target}

*Not found in workspace*`;else{a=`**${p}:** ${s.target}`,c.ast.frontmatter?.description&&(a+=`

${c.ast.frontmatter.description}`);let r=c.ast.sections.filter(l=>l.anchor).map(l=>l.anchor);r.length>0&&(a+=`

Sections: ${r.join(", ")}`),c.parameters.length>0&&(a+=`

**Input Contract:**
`+c.parameters.map(l=>`- $${l.name}: ${this.typeExprToString(l.typeExpr)}${l.isRequired?"":" (optional)"}`).join(`
`))}}else if(s.kind==="anchor"){let i=n.ast.sections.find(p=>p.anchor===s.anchor);a=`**Anchor** ${s.target}`,i?.title&&(a+=`

Section: ${i.title}`)}else continue;return{contents:a,range:this.spanToRange(s.span)}}return null}inferVariableType(e,t){let n=e.variableTypes.get(t);if(n)return n;for(let s of e.ast.sections)for(let a of s.content)if(a.kind==="VariableDeclaration"&&a.name===t&&a.value)return _(a.value,e.typeEnv)}getCompletions(e,t){let n=this.documents.get(e);if(!n)return[];let a=(n.content.split(`
`)[t.line]||"").substring(0,t.character);if(a.endsWith("~/"))return this.getPathCompletions("");let i=a.match(/~\/([a-z0-9\/-]*)$/);if(i){let r=i[1],l=r.match(/^([^#]+)#([a-z0-9-]*)$/);return l?this.getCrossFileAnchorCompletions(l[1],l[2]):this.getPathCompletions(r)}if(a.endsWith("#")&&!a.match(/~\/[^#]*#$/))return this.getAnchorCompletions(n);let p=a.match(/(?<!~\/[^#]*)#([a-z0-9-]+)$/);if(p)return this.getAnchorCompletions(n).filter(r=>r.label.toLowerCase().startsWith(p[1].toLowerCase()));if(a.endsWith("$"))return[...this.getVariableCompletions(n),...this.getTypeCompletions(n)];let c=a.match(/\$([a-zA-Z0-9-]*)$/);if(c){let r=c[1].toLowerCase();return[...this.getVariableCompletions(n),...this.getTypeCompletions(n)].filter(l=>l.label.toLowerCase().startsWith(r))}return a.endsWith("/")?this.getSemanticCompletions():/^\s*$/.test(a)?this.getKeywordCompletions():[]}getPathCompletions(e){let t=[];for(let n of this.skillRegistry.keys())n.startsWith(e)&&t.push({label:"~/"+n,kind:17,detail:this.inferLinkKind(n.split("/")),insertText:n});return t}getCrossFileAnchorCompletions(e,t){let n=this.skillRegistry.get(e);return n?n.ast.sections.filter(s=>s.anchor&&s.anchor.startsWith(t)).map(s=>({label:"#"+s.anchor,kind:18,detail:s.title||"Section",insertText:s.anchor.substring(t.length)})):[]}getAnchorCompletions(e){return e.ast.sections.filter(t=>t.anchor).map(t=>({label:"#"+t.anchor,kind:18,detail:t.title||"Section",insertText:t.anchor}))}getVariableCompletions(e){let t=[];for(let[n,s]of e.variables){let a=s.typeExpr||this.inferVariableType(e,n);t.push({label:n,kind:s.isLambda?3:6,detail:a?this.typeExprToString(a):void 0})}return t}getTypeCompletions(e){let t=[];for(let[n,s]of e.types)t.push({label:n,kind:7,detail:s.definition});for(let n of["FilePath","String","Number","Boolean"])t.push({label:n,kind:7,detail:"Built-in type"});return t}getSemanticCompletions(){return[{label:"appropriate location",kind:15,insertText:"appropriate location/"},{label:"relevant context",kind:15,insertText:"relevant context/"},{label:"best approach for",kind:15,insertText:"best approach for /"},{label:"determine based on",kind:15,insertText:"determine based on /"}]}getKeywordCompletions(){return[{label:"FOR",kind:14,insertText:`FOR $item IN $items
  
END`},{label:"WHILE",kind:14,insertText:`WHILE /condition/ DO
  
END`},{label:"IF",kind:14,insertText:`IF $condition THEN
  
END`},{label:"ELSE",kind:14,insertText:`ELSE
  `},{label:"DO",kind:14,insertText:`DO
  
END`},{label:"END",kind:14,insertText:"END"}]}inferLinkKind(e){let t=e[0];return t==="agent"||t==="agents"?"agent":t==="skill"||t==="skills"?"skill":t==="tool"||t==="tools"?"tool":"link"}getDocumentSymbols(e){let t=this.documents.get(e);if(!t)return[];let n=[];for(let s of t.ast.sections){if(s.title==="Types"||s.title==="Input"||s.title==="Context")continue;let a=[];for(let i of s.content)i.kind==="VariableDeclaration"&&a.push({name:`$${i.name}`,kind:i.isLambda?12:13,range:this.spanToRange(i.span),selectionRange:this.spanToRange(i.span)});n.push({name:s.title||"(untitled)",kind:3,range:this.spanToRange(s.span),selectionRange:this.spanToRange(s.span),children:a.length>0?a:void 0})}return n}spanToRange(e){return{start:{line:e.start.line-1,character:e.start.column},end:{line:e.end.line-1,character:e.end.column}}}positionInSpan(e,t){let n=e.line+1,s=e.character;return!(n<t.start.line||n>t.end.line||n===t.start.line&&s<t.start.column||n===t.end.line&&s>t.end.column)}buildLineOffsets(e){let t=[0],n=0;for(let s of e)n+=1,s===`
`&&t.push(n);return t}offsetToPosition(e,t){let n=0;for(;n+1<t.length&&t[n+1]<=e;)n+=1;return{line:n,character:e-(t[n]??0)}}collectCodeBlockLines(e){let t=new Set;for(let n of e.sections)for(let s of n.content)if(s.kind==="CodeBlock")for(let a=s.span.start.line;a<=s.span.end.line;a++)t.add(a);return t}collectParameters(e){let t=[];if(e.frontmatter)for(let n of e.frontmatter.input)t.push({name:n.name,typeExpr:n.type??U(),isRequired:n.required,span:n.span});for(let n of e.sections)if(n.title==="Input")for(let s of n.content)s.kind==="VariableDeclaration"&&t.push({name:s.name,typeExpr:s.typeAnnotation??U(),isRequired:s.isRequired??s.value===null,span:s.span});return t}buildTypeEnv(e,t){let n=new Map;for(let[s,a]of e)n.set(s,a.typeExpr);if(t.frontmatter)for(let s of t.frontmatter.types)n.set(s.name,s.typeExpr);return n}buildVariableTypes(e){let t=new Map;for(let[n,s]of e)s.typeExpr?t.set(n,s.typeExpr):s.isLambda&&t.set(n,U());return t}validateDelegationContracts(e,t){for(let n of e.ast.sections)this.validateContractsInBlocks(n.title,n.content,e,t)}validateContractsInBlocks(e,t,n,s){for(let a of t)switch(a.kind){case"Delegation":this.validateDelegation(a,n,s);break;case"DelegateStatement":this.validateDelegateStatement(a,n,s);break;case"UseStatement":this.validateUseStatement(a,n,s);break;case"ForEachStatement":case"WhileStatement":this.validateContractsInBlocks(e,a.body,n,s);break;case"IfStatement":this.validateContractsInBlocks(e,a.thenBody,n,s);for(let i of a.elseIf)this.validateContractsInBlocks(e,i.body,n,s);a.elseBody&&this.validateContractsInBlocks(e,a.elseBody,n,s);break;case"DoStatement":a.body&&this.validateContractsInBlocks(e,a.body,n,s);break}}validateDelegation(e,t,n){e.target.kind==="Link"&&this.validateParameterBlock(e.parameters,e.target,t,n)}validateDelegateStatement(e,t,n){e.target&&e.parameters&&this.validateParameterBlock(e.parameters.parameters,e.target,t,n)}validateUseStatement(e,t,n){e.parameters&&this.validateParameterBlock(e.parameters.parameters,e.link,t,n)}validateParameterBlock(e,t,n,s){let a=t.path.join("/"),i=this.skillRegistry.get(a);if(!i)return;let p=i.parameters.filter(r=>r.isRequired),c=new Set(e.map(r=>r.name));for(let r of p)c.has(r.name)||s.push({range:this.spanToRange(t.span),severity:1,message:`Required parameter "${r.name}" is missing for "${a}"`,source:"zen"});for(let r of e){let l=i.parameters.find(b=>b.name===r.name);if(!l){s.push({range:this.spanToRange(r.span),severity:2,message:`Parameter "${r.name}" is not defined for "${a}"`,source:"zen"});continue}let u=this.inferParameterType(r,n);B(u,l.typeExpr,i.typeEnv).compatible||s.push({range:this.spanToRange(r.span),severity:1,message:`Parameter "${r.name}" expects ${this.typeExprToString(l.typeExpr)} but received ${this.typeExprToString(u)}`,source:"zen"})}}inferParameterType(e,t){return e.typeAnnotation?e.typeAnnotation:e.value?_(e.value,t.variableTypes):U()}collectFrontmatterDeclarationSpans(e){let t={types:new Map,input:new Map,context:new Map},n=e.split(`
`);if(n[0]?.trim()!=="---")return t;let s=n[0].length+1,a=null,i=null;for(let p=1;p<n.length;p++){let c=n[p]??"";if(c.trim()==="---")break;let r=c.search(/\S/),l=c.match(/^\s*(types|input|context):\s*$/);if(l)a=l[1],i=r;else if(a&&(i===null||r>i)){let u=c.match(/^\s*(\$?[A-Za-z0-9_-]+)\s*:/);if(u){let E=u[1].replace(/^\$/,""),b=u.index??0;t[a].set(E,v(p+1,b,s+b,p+1,b+u[0].length,s+b+u[0].length))}}else a=null,i=null;s+=c.length+1}return t}};var w=new Z;function be(d,e){try{let t=V(e);postMessage({type:"parse",id:d,result:t})}catch(t){postMessage({type:"error",id:d,error:t instanceof Error?t.message:String(t)})}}function Ne(d,e){try{let t=z(e),n={diagnostics:t.diagnostics.map(s=>({severity:s.severity,code:s.code,message:s.message,line:s.span.start.line,column:s.span.start.column,endLine:s.span.end.line,endColumn:s.span.end.column})),metadata:{name:t.metadata.name,description:t.metadata.description,uses:t.metadata.uses,types:t.metadata.types.map(s=>({name:s.name,definition:s.definition})),variables:t.metadata.variables.map(s=>({name:s.name,type:s.type})),references:t.metadata.references.map(s=>({kind:s.kind,target:s.target})),sections:t.metadata.sections.map(s=>({title:s.title,anchor:s.anchor,level:s.level}))},dependencies:{nodes:t.dependencies.nodes,edges:t.dependencies.edges.map(s=>({target:s.target,type:s.type}))}};postMessage({type:"validate",id:d,result:n})}catch(t){postMessage({type:"error",id:d,error:t instanceof Error?t.message:String(t)})}}function De(d,e,t,n){try{w.updateDocument(e,t);let s=w.getCompletions(e,n);postMessage({type:"completions",id:d,result:s})}catch(s){postMessage({type:"error",id:d,error:s instanceof Error?s.message:String(s)})}}function Re(d,e,t,n){try{w.updateDocument(e,t);let s=w.getHover(e,n);postMessage({type:"hover",id:d,result:s})}catch(s){postMessage({type:"error",id:d,error:s instanceof Error?s.message:String(s)})}}function Le(d,e,t){try{let n=w.updateDocument(e,t);postMessage({type:"diagnostics",id:d,result:n})}catch(n){postMessage({type:"error",id:d,error:n instanceof Error?n.message:String(n)})}}function Ie(d,e,t){try{w.updateDocument(e,t);let n=w.getSemanticTokens(e);postMessage({type:"semanticTokens",id:d,result:n})}catch(n){postMessage({type:"error",id:d,error:n instanceof Error?n.message:String(n)})}}function Ce(d,e){try{let t={},n=new Map,s=[];for(let[p,c]of Object.entries(e))w.updateDocument(p,c);let a=new Map;for(let[p,c]of Object.entries(e)){let r=z(c);r.metadata.name&&a.set(r.metadata.name,p)}for(let[p,c]of Object.entries(e)){let r=z(c),l=r.metadata.name;t[p]={diagnostics:r.diagnostics.map(u=>({severity:u.severity,code:u.code,message:u.message,line:u.span.start.line,column:u.span.start.column,endLine:u.span.end.line,endColumn:u.span.end.column})),metadata:{name:r.metadata.name,description:r.metadata.description,uses:r.metadata.uses,types:r.metadata.types.map(u=>({name:u.name,definition:u.definition})),variables:r.metadata.variables.map(u=>({name:u.name,type:u.type})),references:r.metadata.references.map(u=>({kind:u.kind,target:u.target})),sections:r.metadata.sections.map(u=>({title:u.title,anchor:u.anchor,level:u.level}))},dependencies:{nodes:r.dependencies.nodes,edges:r.dependencies.edges.map(u=>({target:u.target,type:u.type}))}},l&&n.set(l,p);for(let u of r.dependencies.nodes)n.has(u)||n.set(u,a.get(u)||null);for(let u of r.dependencies.edges)l&&s.push({source:l,target:u.target,type:u.type})}let i={fileResults:t,unifiedGraph:{nodes:Array.from(n.entries()).map(([p,c])=>({id:p,file:c})),edges:s}};postMessage({type:"validateProject",id:d,result:i})}catch(t){postMessage({type:"error",id:d,error:t instanceof Error?t.message:String(t)})}}self.addEventListener("message",d=>{let e=d.data;switch(e.type){case"parse":be(e.id,e.source);break;case"validate":Ne(e.id,e.source);break;case"validateProject":Ce(e.id,e.files);break;case"completions":De(e.id,e.uri,e.source,e.position);break;case"hover":Re(e.id,e.uri,e.source,e.position);break;case"diagnostics":Le(e.id,e.uri,e.source);break;case"semanticTokens":Ie(e.id,e.uri,e.source);break;default:postMessage({type:"error",id:e.id||0,error:`Unknown message type: ${e.type}`})}});postMessage({type:"ready"});})();
//# sourceMappingURL=zen-worker.min.js.map
